<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Phân Tích KPI Hoàn Thiện</title>
    <!-- Thêm Font Awesome cho các biểu tượng -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        xintegrity="sha512-iecdLmaskl7CV0sXU32F/eRj5lWc1BqB0/X/E5eF4/g5C3Z6aLgP4nFf5F5t2VfP4wL2gQJ7g=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        :root {
            /* Vibrant but Soft Pastel Palette - Synchronized with 2.html */
            --primary-accent: #0ABDE3;
            --secondary-accent: #FF9F43;
            --success-color: #00D2D3;
            --danger-color: #FF6B6B;
            --text-primary: #2D3436;
            --text-secondary: #636E72;
            --text-on-dark: #FFFFFF;
            --glass-bg: rgba(255, 255, 255, 0.75);
            --border-main: rgba(255, 255, 255, 0.4);
            --card-bg: #FFFFFF;
            --card-radius: 24px;
            --clay-shadow:
                8px 8px 16px 0 rgba(0, 0, 0, 0.05),
                inset -4px -4px 8px 0 rgba(0, 0, 0, 0.03),
                inset 4px 4px 8px 0 rgba(255, 255, 255, 0.8);
            --shadow-main: 0 8px 32px 0 rgba(31, 38, 135, 0.1);

            --bg-main: linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%) no-repeat fixed;

            /* Ánh xạ các biến cũ sang biến mới để tương thích */
            --primary-color: var(--primary-accent);
            /* --card-bg: var(--glass-bg);  This line was redundant as --card-bg is defined above */

            /* STRAM Colors (Giữ nguyên cho logic cũ) */
            --d1-color: #F04770;
            --d2-color: #F78C6A;
            --d3-color: #FFD167;
            --d4-color: #06D7A0;

            /* Infographic Colors */
            --info-bg-dark: #0D1B2A;
            --info-text-light: #E0E7FF;
            --info-pill-bg: #1A2E44;

            --gold-light: #FFEA7D;
            --gold-dark: #FFD700;
            --silver-light: #EFEFEF;
            --silver-dark: #C0C0C0;
            --bronze-light: #E99C5F;
            --bronze-dark: #CD7F32;

            --warning-red-light: #FF99AA;
            --warning-red-dark: #F04770;
            --warning-red-ribbon: linear-gradient(180deg, #F04770, #CC335D, #F04770);
            --warning-red-gradient: radial-gradient(circle at 30% 30%, var(--warning-red-light), var(--warning-red-dark));
            --warning-red-border: 3px solid #CC335D;
            --warning-text-color: #FFE0E5;
            --text-on-warning: #000000;
        }

        body {
            width: 100%;
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
            background-color: #f5f7fa;
            background-image: linear-gradient(to bottom, #ffffff, #eaeff2);
            min-height: 100vh;
            font-family: 'Tahoma', 'Arial', sans-serif;
            color: var(--text-primary);
        }

        .container {
            max-width: 100%;
            padding: 15px;
            box-sizing: border-box;
        }

        .inner-container {
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        h1,
        h2,
        h3 {
            color: var(--text-primary);
            font-family: 'Tahoma', 'Arial', sans-serif;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        h2 {
            font-size: 1.8em;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-main);
            font-weight: 700;
            text-align: center;
        }

        .card,
        .perf-card {
            background: var(--glass-bg);
            padding: 15px;
            /* Reduced from 25px */
            border-radius: var(--card-radius);
            box-shadow: var(--clay-shadow);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-main);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.3s ease;
            position: relative;
        }

        .card:hover,
        .perf-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 45px 0 rgba(31, 38, 135, 0.15);
        }

        .contest-table-container {
            margin: 15px -12px 0 -12px;
            /* Pull to edges */
            width: calc(100% + 24px);
            border-radius: 0;
            background: rgba(255, 255, 255, 0.3);
            border-top: 1px solid var(--border-main);
            border-bottom: 1px solid var(--border-main);
            padding: 0;
        }

        /* Custom scrollbar for better look */
        .contest-table-container::-webkit-scrollbar {
            width: 6px;
        }

        .contest-table-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .contest-table-container::-webkit-scrollbar-thumb {
            background: var(--primary-accent);
            border-radius: 10px;
        }

        /* NEW: Bố cục 3 cột cho phần nhập liệu */
        .input-grid-compact {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 10px;
            /* Reduced from 15px */
            margin-bottom: 0;
        }

        .input-group-compact {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .input-group-compact h3 {
            font-size: 0.95em;
            /* Reduced from 1.1em */
            margin-bottom: 0px;
            margin-top: 5px;
            font-weight: 700;
        }

        .input-group-compact textarea {
            width: 100%;
            height: 60px;
            /* Reduced from 80px */
            font-size: 11px;
            padding: 8px;
        }

        .btn-paste {
            padding: 6px 12px;
            font-size: 11px;
            font-weight: 700;
            color: #ffffff !important;
            /* Force white text */
            background-color: #00BCD4 !important;
            /* Force Cyan background */
            border: none;
            border-radius: 4px;
            margin-top: 5px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .btn-paste:hover {
            background-color: #00acc1 !important;
        }

        /* End NEW compact input styles */

        input[type="text"],
        input[type="number"],
        textarea,
        input[type="date"] {
            width: 100%;
            padding: 12px;
            background: rgba(236, 240, 243, 0.6);
            border-radius: 12px;
            font-size: 14px;
            box-sizing: border-box;
            box-shadow: inset 6px 6px 10px rgba(163, 177, 198, 0.3), inset -6px -6px 10px rgba(255, 255, 255, 0.8);
            border: none;
            transition: all 0.3s ease;
            font-family: 'Tahoma', 'Arial', sans-serif;
        }

        input:focus,
        textarea:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.8);
            box-shadow: inset 1px 1px 3px rgba(0, 0, 0, 0.05), 0 0 0 3px rgba(10, 189, 227, 0.2);
        }

        input:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn,
        .btn-paste,
        .action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 800;
            font-family: 'Tahoma', 'Arial', sans-serif;
            color: var(--text-on-dark);
            border: none;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 6px 6px 12px rgba(163, 177, 198, 0.4), -6px -6px 12px rgba(255, 255, 255, 0.4);
            transform: translateY(0);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .btn::after,
        .btn-paste::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 50%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.2), transparent);
            pointer-events: none;
        }

        .btn:active,
        .btn-paste:active {
            transform: translateY(3px);
            box-shadow: none;
        }

        #processBtn,
        #captureReportBtnMain,
        #captureComprehensiveBtn {
            background: var(--primary-accent);
            width: 100%;
            margin-bottom: 15px;
        }

        #editDataBtn {
            background: #dfe6e9;
            /* Light grey */
            color: #000000 !important;
        }

        #captureCardsBtn {
            background: var(--secondary-accent);
        }

        #captureAllCardsBtn {
            background: var(--success-color);
        }

        #copyCommentsBtn,
        #captureInfographicBtn {
            background: var(--primary-accent);
        }

        /* CONTEST SELECTOR GROUP */
        #contestSelectorGroup {
            display: flex;
            align-items: center;
            padding: 5px 10px;
            border-radius: 8px;
            background-color: var(--bg-main);
            border: 1px solid var(--border-main);
        }

        #allContestsCheckbox {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            accent-color: var(--success-color);
        }

        #selectContestsBtnCustom {
            background-color: var(--secondary-accent);
            color: var(--text-on-dark);
            border-radius: 8px;
            font-weight: bold;
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #selectContestsBtnCustom:hover {
            filter: brightness(90%);
        }

        #contestCountStatus {
            margin-left: 10px;
            font-size: 14px;
            color: var(--text-muted);
            font-weight: 500;
        }

        #captureCardsBtn {
            background-color: var(--secondary-accent);
        }

        #captureAllCardsBtn {
            background-color: var(--success-color);
            margin-left: 15px;
        }

        #copyCommentsBtn {
            background-color: var(--primary-accent);
        }

        #captureInfographicBtn {
            background-color: var(--primary-accent);
        }

        /* Target Allocation Styles (OLD - Giữ lại để tránh lỗi style) */
        #target-allocation-container {
            border: 1px solid var(--border-main);
            border-radius: 8px;
            padding: 15px;
            background-color: #fff;
            margin-top: 15px;
        }

        .target-mode-switch {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed var(--border-main);
        }

        .target-mode-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 500;
        }

        .target-mode-label input {
            width: 18px;
            height: 18px;
            margin-right: 8px;
            accent-color: var(--primary-accent);
        }

        #employee-list-header {
            display: grid;
            grid-template-columns: 40px 2fr 1fr 1.5fr;
            font-weight: bold;
            padding: 8px 0;
            background-color: #f8f9fa;
            border-bottom: 2px solid var(--border-main);
            text-align: center;
        }

        .employee-target-row {
            display: grid;
            grid-template-columns: 40px 2fr 1fr 1.5fr;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            align-items: center;
        }

        .employee-target-row input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: auto;
            accent-color: var(--success-color);
        }

        .employee-target-row input[type="number"] {
            width: 80%;
            padding: 5px;
            text-align: center;
            margin: auto;
        }

        .employee-target-val {
            font-weight: bold;
            color: var(--primary-accent);
            text-align: right;
            padding-right: 15px;
        }

        .employee-name-label {
            padding-left: 10px;
            font-weight: 500;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 25px;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--danger-color);
            color: var(--text-on-dark);
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            font-weight: 500;
        }

        .toast.show {
            opacity: 1;
            visibility: visible;
        }

        #reportTitle {
            text-align: center;
            margin: 20px 0 0 0;
            display: none;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            /* Cho phép xuống dòng nếu quá hẹp */
        }

        .section-header>div {
            display: flex;
            gap: 10px;
        }

        /* --- GIAO DIỆN BẢNG TỔNG HỢP --- */
        .comprehensive-table {
            width: max-content;
            /* Đảm bảo bảng không bị co lại */
            min-width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 11px;
            background: #fff;
            border: 1px solid var(--border-main);
        }

        .comprehensive-table th,
        .comprehensive-table td {
            border: 1px solid rgba(0, 0, 0, 0.05);
            padding: 4px 5px;
            text-align: center;
            vertical-align: middle;
        }

        .comprehensive-table thead th {
            background-color: var(--primary-accent);
            color: white;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 11px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* Column 1: Hạng */
        .comprehensive-table th:nth-child(1),
        .comprehensive-table td:nth-child(1) {
            position: sticky !important;
            left: 0 !important;
            background-color: #fff !important;
            z-index: 6;
            width: 45px;
            min-width: 45px;
            max-width: 45px;
            white-space: nowrap;
        }

        .comprehensive-table thead th:nth-child(1) {
            z-index: 20;
            background-color: var(--primary-accent) !important;
        }

        /* Column 2: Nhân viên */
        .comprehensive-table th:nth-child(2),
        .comprehensive-table td:nth-child(2) {
            position: sticky !important;
            left: 45px !important;
            background-color: #fff !important;
            z-index: 6;
            width: 130px;
            min-width: 130px;
            max-width: 130px;
            white-space: nowrap;
        }

        .comprehensive-table thead th:nth-child(2) {
            z-index: 20;
            background-color: var(--primary-accent) !important;
        }

        /* Column 3: Điểm */
        .comprehensive-table th:nth-child(3),
        .comprehensive-table td:nth-child(3) {
            position: sticky !important;
            left: 175px !important;
            background-color: #fff !important;
            z-index: 6;
            width: 70px;
            min-width: 70px;
            max-width: 70px;
            white-space: nowrap;
        }

        .comprehensive-table thead th:nth-child(3) {
            z-index: 20;
            background-color: var(--primary-accent) !important;
        }

        /* Column 4: Số ngành HT */
        .comprehensive-table th:nth-child(4),
        .comprehensive-table td:nth-child(4) {
            position: sticky !important;
            left: 245px !important;
            background-color: #fff !important;
            z-index: 6;
            width: 110px;
            min-width: 110px;
            max-width: 110px;
            white-space: nowrap;
        }

        .comprehensive-table thead th:nth-child(4) {
            z-index: 20;
            background-color: var(--primary-accent) !important;
        }

        /* Column 5: Tiến độ DT */
        .comprehensive-table th:nth-child(5),
        .comprehensive-table td:nth-child(5) {
            position: sticky !important;
            left: 355px !important;
            background-color: #fff !important;
            z-index: 6;
            width: 140px;
            min-width: 140px;
            max-width: 140px;
            border-right: 3px solid var(--primary-accent) !important;
        }

        .comprehensive-table thead th:nth-child(5) {
            z-index: 20;
            background-color: var(--primary-accent) !important;
        }

        /* ROWS INTERACTION */
        .comprehensive-table tbody tr {
            transition: background-color 0.2s;
        }

        .comprehensive-table tbody tr:hover td {
            background-color: #f8fafc;
        }

        /* Ensure sticky cols update color on hover */
        .comprehensive-table tbody tr:hover .sticky-col-1,
        .comprehensive-table tbody tr:hover .sticky-col-2,
        .comprehensive-table tbody tr:hover .sticky-col-3,
        .comprehensive-table tbody tr:hover .sticky-col-4,
        .comprehensive-table tbody tr:hover .sticky-col-5 {
            background-color: #f0f9ff !important;
            /* Light blue highlight */
        }

        thead th.sticky-col-3,
        thead th.sticky-col-4,
        thead th.sticky-col-5 {
            background-color: var(--primary-accent) !important;
            z-index: 30;
            /* Higher than body sticky cols */
        }

        /* Fix Shadow for Header Pivot */
        thead th.sticky-col-5 {
            box-shadow: 4px 0 6px -2px rgba(0, 0, 0, 0.2) !important;
        }

        /* ROWS INTERACTION */
        .comprehensive-table tbody tr {
            transition: background-color 0.2s;
        }

        .comprehensive-table tbody tr:hover td {
            background-color: #f8fafc;
        }

        /* Ensure sticky cols update color on hover */
        .comprehensive-table tbody tr:hover .sticky-col-1,
        .comprehensive-table tbody tr:hover .sticky-col-2,
        .comprehensive-table tbody tr:hover .sticky-col-3,
        .comprehensive-table tbody tr:hover .sticky-col-4,
        .comprehensive-table tbody tr:hover .sticky-col-5 {
            background-color: #f0f9ff !important;
            /* Light blue highlight */
        }


        /* Đảm bảo nền của các hàng tr không làm mất màu trắng của cột cố định */
        .comprehensive-table tbody tr {
            background-color: #fff;
        }

        .comprehensive-table tbody tr:hover td {
            background-color: #f1f2f6;
        }

        .comprehensive-table tbody tr:hover td:nth-child(-n+5) {
            background-color: #e8effa;
            /* Highlight cả phần cố định khi hover */
        }


        .comprehensive-table td:nth-child(2) {
            text-align: left;
            font-weight: 600;
        }

        .clickable-name,
        .clickable-header {
            color: var(--primary-accent) !important;
            text-decoration: none;
            font-weight: 700;
            cursor: pointer;
        }

        .bubble-projected {
            background: var(--secondary-accent);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.85em;
            font-weight: 800;
        }

        .progress-bar-wrapper {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }



        .clickable-name:hover,
        .clickable-header:hover {
            text-decoration: underline;
        }

        .rank-cell {
            font-weight: 700;
            font-size: 1.0em;
        }

        .rank-icon {
            font-size: 1.5em;
        }

        .heatmap-cell {
            color: var(--text-primary);
            font-size: 11px;
        }

        .percent-badge {
            display: inline-block;
            padding: 1px 3px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.9em;
            border: 1px solid;
            min-width: 35px;
            text-align: center;
        }

        .badge-green {
            background-color: rgba(6, 215, 160, 0.1);
            border-color: var(--success-color);
            color: var(--success-color);
        }

        .badge-red {
            background-color: rgba(240, 71, 112, 0.1);
            border-color: var(--danger-color);
            color: var(--danger-color);
        }

        .progress-bar-wrapper {
            min-width: 110px;
        }

        .progress-bar-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 12px;
            font-weight: 700;
            color: #1a202c;
            /* Darker color */
        }

        .progress-bar-bg {
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 50px;
            height: 12px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .progress-bar-fill {
            background: var(--primary-accent);
            height: 100%;
            border-radius: 50px;
            transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            background-image: linear-gradient(to bottom, rgba(255, 255, 255, 0.3) 0%, rgba(255, 255, 255, 0.05) 40%, rgba(0, 0, 0, 0.05) 100%);
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
        }

        .progress-bar-fill.success {
            background-color: var(--success-color);
        }

        /* CẬP NHẬT: FIX LỖI 2 - TĂNG ĐỘ RỘNG CỘT NGÀNH HÀNG VÀ CHO PHÉP XUỐNG DÒNG */
        .contest-header-cell {
            width: 120px;
            /* Tăng độ rộng cột để hiển thị tên đầy đủ hơn */
            min-width: 120px;
            white-space: normal;
            /* Cho phép xuống dòng */
            font-size: 10px;
            vertical-align: top;
            padding: 1px;
            line-height: 1.1;
        }

        .contest-header-cell>div {
            margin-top: 0;
            font-size: 1.0em;
            font-weight: 700;
            line-height: 1.1;
        }

        /* Style cho phần Lũy kế / Target mới */
        .contest-value-pair {
            display: block;
            font-size: 10px;
            font-weight: 500;
            color: var(--text-muted);
            margin-top: 1px;
            line-height: 1;
        }

        /* Clean Percent Display for Cells */
        .cell-main-percent {
            font-size: 14px;
            font-weight: 800;
            display: block;
        }

        .cell-sub-detail {
            font-size: 10px;
            color: #94a3b8;
            font-weight: 500;
            margin-top: 2px;
        }

        /* Modern Progress Bar - Minimal */
        .mini-progress {
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            margin-top: 4px;
            width: 100%;
            overflow: hidden;
        }



        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.85);
            /* Darker backdrop for better contrast */
            backdrop-filter: blur(4px);
            /* Blur effect for focus */
        }

        .modal-content {
            background-color: #FFFFFF;
            /* High contrast white background */
            margin: auto;
            padding: 25px;
            border: 1px solid #ddd;
            width: 95%;
            max-width: 1400px;
            border-radius: 16px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-close-btn {
            color: #fff;
            background-color: #ff4757;
            /* Red background for visibility */
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 15px;
            /* Moved down slightly */
            right: 15px;
            /* Moved left slightly */
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10000 !important;
            /* Force on top with high priority */
            box-shadow: 0 4px 10px rgba(255, 71, 87, 0.4);
            transition: all 0.2s ease;
        }

        .modal-close-btn:hover,
        .modal-close-btn:focus {
            background-color: #ff6b81;
            transform: scale(1.1);
        }

        .modal .data-table {
            font-size: 14px;
            width: 100%;
            border-collapse: collapse;
        }

        .modal .data-table th,
        .modal .data-table td {
            padding: 12px 10px;
            border: 1px solid var(--border-main);
            text-align: center;
        }

        .modal .data-table thead th {
            background-color: #F9FAFB;
        }

        /* Modal Contest Selection */
        #contest-selection-modal .modal-content {
            max-width: 600px;
        }

        #contest-list {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid var(--border-main);
            padding: 15px;
            border-radius: 8px;
            background-color: #fff;
        }

        /* NEW CSS: Cải thiện vùng click cho Ngành hàng */
        .contest-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
        }

        .contest-item:last-child {
            border-bottom: none;
        }

        .contest-item input[type="checkbox"] {
            margin-right: 15px;
            width: 18px;
            height: 18px;
            accent-color: var(--primary-accent);
            pointer-events: none;
            /* Quan trọng: Ngăn checkbox tự phản ứng với click */
        }

        .contest-item label {
            flex-grow: 1;
            cursor: pointer;
            pointer-events: none;
            /* Quan trọng: Cho phép click vào dòng để kích hoạt sự kiện */
        }

        /* END NEW CSS */

        .perf-quote {
            margin: 0;
            font-size: 0.85em;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .perf-quote.rank1 {
            color: #2D3436 !important;
        }

        /* Dark on Gold */
        .perf-quote.rank2 {
            color: #2D3436 !important;
        }

        /* Dark on Silver */
        .perf-quote.rank3 {
            color: #FFFFFF !important;
        }

        /* White on Bronze */
        .perf-quote.rank-mid {
            color: #FFFFFF !important;
        }

        /* White on Blue */
        .perf-quote.rank-bottom {
            color: #FFFFFF !important;
        }

        /* White on Red/Blue */

        /* Blue */

        .modal-footer {
            margin-top: 20px;
            text-align: right;
        }

        /* XÓA #applyContestSelectionBtn khỏi đây vì nó được chuyển vào nút Nhập/Xuất */

        /* --- GIAO DIỆN Thẻ KPI --- */
        #allCardsContainer {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
            gap: 40px 30px;
            /* Increased row gap */
            padding: 10px;
        }

        .perf-card {
            border-radius: 10px;
            overflow: hidden;
            background: white;
            border: 1px solid var(--border-main);
            display: flex;
            flex-direction: column;
            height: auto;
            /* Shrink to content */
            min-height: min-content;
            box-shadow: var(--shadow-main);
            position: relative;
            align-self: start;
            /* Prevent stretching in grid */
        }

        .perf-header {
            display: grid;
            grid-template-columns: 60px minmax(0, 1fr) auto;
            background: var(--primary-accent);
            color: white;
            padding: 15px;
            /* Increased padding */
            align-items: center;
            gap: 15px;
            border-radius: 20px 20px 0 0;
            margin: -15px -15px 15px -15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        /* Rank-specific header colors */
        .perf-header.header-rank1 {
            background: linear-gradient(135deg, #FFD700 0%, #F1C40F 100%);
            color: #2D3436 !important;
        }

        .perf-header.header-rank1 h2,
        .perf-header.header-rank1 h3 {
            color: #2D3436 !important;
        }

        .perf-header.header-rank1 .perf-quote {
            text-shadow: none;
            color: #4b4b4b !important;
        }

        .perf-header.header-rank2 {
            background: linear-gradient(135deg, #dfe6e9 0%, #b2bec3 100%);
            color: #2D3436 !important;
        }

        .perf-header.header-rank2 h2,
        .perf-header.header-rank2 h3 {
            color: #2D3436 !important;
        }

        .perf-header.header-rank3 {
            background: linear-gradient(135deg, #CD7F32 0%, #A0522D 100%);
            color: white !important;
        }

        .perf-header.header-rank3 h2,
        .perf-header.header-rank3 h3 {
            color: white !important;
        }

        .perf-header.header-top {
            background: linear-gradient(135deg, #0ABDE3 0%, #48dbfb 100%);
        }

        .perf-header.header-warning {
            background: linear-gradient(135deg, #ff7675 0%, #d63031 100%);
            color: white !important;
        }

        .perf-header.header-warning h2,
        .perf-header.header-warning h3 {
            color: white !important;
        }

        .perf-header .name-block h2 {
            margin: 0;
            font-size: 1.25em;
            color: white;
            font-weight: 800;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .perf-header .rank-block h3 {
            margin: 0;
            font-size: 1.4em;
            color: var(--warning-color);
            font-weight: 900;
        }

        .perf-body {
            padding: 12px;
            flex-grow: 1;
        }

        .progress-bar-group {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            text-align: center;
            font-size: 12px;
            margin-top: 25px;
        }

        .progress-bar-group>div {
            padding: 12px 8px;
            border-radius: 12px;
            color: white;
            box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.3), 0 4px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            background-image: linear-gradient(to bottom, rgba(255, 255, 255, 0.2), transparent);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .progress-bar-group .label {
            color: rgba(255, 255, 255, 0.9);
            font-weight: 700;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .progress-bar-group .value {
            color: white;
            font-size: 1.3em;
            margin-top: 4px;
            font-weight: 900;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            line-height: 1.2;
            word-break: break-all;
        }

        .progress-bar-group>div:nth-child(1) {
            background-color: var(--primary-accent);
        }

        .progress-bar-group>div:nth-child(2) {
            background-color: var(--secondary-accent);
        }

        .progress-bar-group>div:nth-child(3) {
            background-color: var(--danger-color);
        }

        .progress-bar-group>div:nth-child(4) {
            background-color: var(--success-color);
        }

        .progress-bar-group>div:nth-child(5) {
            background-color: #2f3542;
            /* Dark contrast background */
        }

        /* Comparison Styling for KPI Card */
        .comparison-change {
            display: inline-block;
            margin-left: 5px;
            font-size: 0.9em;
            font-weight: 700;
        }

        .change-up {
            color: var(--success-color);
        }

        .change-down {
            color: var(--danger-color);
        }

        .change-equal {
            color: var(--text-muted);
        }

        .change-na {
            color: var(--text-muted);
            font-style: italic;
        }

        .contest-table {
            width: 100%;
            border-collapse: collapse;
            /* Changed from separate for better grid lines */
            border-spacing: 0;
            margin-top: 15px;
            font-size: 11px;
            border: 1px solid #cbd5e0;
            /* More visible border */
        }

        .contest-table th,
        .contest-table td {
            border: 1px solid #cbd5e0;
            /* Clear grid lines */
            padding: 8px 5px;
            text-align: center;
        }

        .contest-table th {
            background: var(--primary-accent);
            color: white;
            text-transform: uppercase;
            font-size: 11px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .contest-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .contest-table tbody td:nth-child(2) {
            font-size: 10px;
            font-weight: normal;
            text-align: left;
        }

        .contest-table th:nth-child(1) {
            width: 30px;
        }

        .contest-table th:nth-child(2) {
            width: auto;
            min-width: 80px;
        }

        .contest-table th:nth-child(3) {
            width: 45px;
        }

        .contest-table th:nth-child(4) {
            width: 50px;
        }

        .contest-table th:nth-child(5) {
            width: 50px;
        }

        .contest-table th:nth-child(6) {
            width: 50px;
        }

        .contest-table th:nth-child(7) {
            width: 45px;
        }

        .contest-table th:nth-child(8) {
            width: 45px;
        }

        /* Đảm bảo kpi-actual là phần tử bên trong td và sử dụng inline flex */
        .contest-table .kpi-actual>span {
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            width: 100%;
        }

        .contest-table .kpi-change {
            font-weight: 700;
        }

        /* NEW: Class cho màu chữ dựa trên % */
        .text-success {
            color: var(--success-color) !important;
            font-weight: 700;
        }

        .text-warning {
            color: var(--warning-color) !important;
            font-weight: 700;
        }

        .text-danger {
            color: var(--danger-color) !important;
            font-weight: 700;
        }

        /* NEW: Class cho Icon Cup/Checkmark (để đồng nhất) */
        .icon-cell {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--success-color);
        }

        .success-text {
            color: var(--success-color);
        }

        /* Dùng cho text đã hoàn thành */


        /* Comparison Table inside KPI Card */
        .kpi-comparison-summary {
            display: none;
            /* Ẩn toàn bộ bảng so sánh theo yêu cầu mới */
        }

        /* New Comparison Controls Container - THU NHỎ & SẮP XẾP LẠI */
        /* Đã di chuyển xuống Bảng tổng hợp */
        #comparison-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 0;
            margin-bottom: 0;
            flex-wrap: nowrap;
            height: auto;
        }

        /* Đảm bảo các thành phần nhỏ lại */
        /* Đảm bảo các thành phần nhỏ lại */
        #comparison-controls label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            white-space: nowrap;
            margin-right: -2px;
            display: flex;
            align-items: center;
            height: 34px;
        }

        #comparison-controls input[type="date"] {
            width: 110px;
            min-width: 110px;
            font-family: inherit;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            height: 34px !important;
            padding: 0 5px !important;
            font-size: 12px !important;
            box-sizing: border-box !important;
        }

        /* Điều chỉnh kích thước nút nhỏ hơn */
        /* Điều chỉnh kích thước nút nhỏ hơn */
        #comparison-controls .btn-small,
        #contestSelectorGroup .btn-small,
        .capture-group .btn-small,
        #selectContestsBtnCustom {
            height: 34px !important;
            line-height: normal !important;
            font-size: 12px !important;
            padding: 0 12px !important;
            margin: 0 !important;
            box-sizing: border-box !important;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            white-space: nowrap;
            font-weight: 700;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #runComparisonBtn {
            background-color: var(--primary-accent);
        }

        #toggleComparisonBtn {
            background-color: var(--danger-color);
        }

        /* Đặt lại màu cho nút Ẩn */
        #captureCardsBtn {
            background-color: var(--secondary-accent);
            color: white;
        }

        #captureAllCardsBtn {
            background-color: var(--success-color);
            color: white;
        }

        #editDataBtn {
            background-color: #dfe6e9;
            color: #000000 !important;
        }

        /* FIX: Ensure all controls in the header fit on one line on desktop */
        .leaderboard-controls-row {
            display: flex;
            justify-content: flex-start;
            /* Align left to pack tight */
            align-items: center;
            flex-wrap: nowrap;
            /* Force single line */
            overflow-x: auto;
            /* Scroll if needed on very small screens */
            padding-bottom: 10px;
            margin-top: 15px;
            border-bottom: 1px solid var(--border-main);
            gap: 15px;
            /* Consistent gap between groups */
        }

        .leaderboard-controls-row>div {
            display: flex;
            gap: 6px;
            /* Tighter gap inside groups */
            flex-shrink: 0;
            align-items: center;
            height: 34px;
        }

        .capture-group {
            padding-left: 10px;
            border-left: 1px solid var(--border-main);
            /* Group capture buttons tighter */
        }

        /* Tighter buttons */
        /* Styles unified above */

        @media (max-width: 1024px) {
            .leaderboard-controls-row {
                flex-wrap: wrap;
            }

            .leaderboard-controls-row>div {
                flex-grow: 1;
                min-width: 100%;
                margin-top: 10px;
                gap: 5px;
            }

            .leaderboard-controls-row .capture-group {
                border-left: none;
                padding-left: 0;
                margin-top: 15px;
            }

            #comparison-controls {
                flex-wrap: wrap;
                height: auto;
            }

            #comparison-controls input[type="date"] {
                width: 45%;
                min-width: 110px;
            }

            #comparison-controls .btn-small {
                flex-grow: 1;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .card {
                padding: 15px;
                margin-bottom: 15px;
            }

            #data-input-card .input-grid-compact {
                grid-template-columns: 1fr;
            }

            .info-header-row,
            .mid-row {
                grid-template-columns: 60px 2fr 1.2fr 1.2fr 1.5fr;
                font-size: 11px;
            }

            .mid-name,
            .info-header-row .col-name {
                padding-left: 5px;
            }

            #allCardsContainer {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .perf-card .perf-body {
                padding: 15px;
            }

            /* SỬA LỖI: Cải thiện hiển thị Bảng Tổng Hợp */
            #comprehensiveLeaderboardContainer {
                height: auto !important;
                max-height: none !important;
                overflow-y: visible !important;
            }

            .comprehensive-table {
                font-size: 10px;
            }

            /* XÓA FIX MOBILE CŨ (đã dùng sticky) */
            /* .comprehensive-table th:nth-child(2), .comprehensive-table td:nth-child(2) {
                min-width: 80px; width: 80px;
            } */
            .contest-header-cell {
                min-width: 50px;
            }

            /* Fix cho STRAM modal trên mobile */
            .stram-modal-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            /* Fix input date controls */
            #comparison-controls input[type="date"] {
                width: 45%;
                min-width: 110px;
            }

            #comparison-controls .btn-small {
                flex-grow: 1;
            }

            .leaderboard-controls-row>div {
                flex-grow: 1;
                min-width: 100%;
                margin-top: 10px;
                gap: 5px;
            }

            .leaderboard-controls-row .capture-group {
                margin-top: 15px;
            }

            .top3-grid {
                grid-template-columns: 1fr;
            }

            /* Fix scale infographic on mobile */
            #infographic-card {
                /* Đảm bảo không scale trên mobile */
                transform: scale(1);
                width: 100%;
                height: auto;
                margin-bottom: 25px;
            }
        }

        /* FIX HIỂN THỊ TỔNG HỢP (chung) */
        #comprehensiveLeaderboardContainer {
            height: auto !important;
            max-height: none !important;
            overflow-y: visible !important;
        }

        /* INFOGRAPHIC SCALE FIX (giữ lại 1/2 cho CSS an toàn) */
        #infographic-card {
            margin-bottom: 0;
            height: 0;
        }

        /* NEW: Modern Target Allocation Table Styles */
        #target-allocation-report-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 13px;
            margin-top: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        #target-allocation-report-table thead th {
            background-color: #f8fafc;
            color: #475569;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.05em;
            padding: 12px 8px;
            border-bottom: 2px solid #e2e8f0;
            border-right: 1px solid #e2e8f0;
        }

        #target-allocation-report-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #e2e8f0;
            border-right: 1px solid #e2e8f0;
            vertical-align: middle;
        }

        #target-allocation-report-table tr:last-child td {
            border-bottom: none;
        }

        /* Color coding columns */
        .col-revenue {
            background-color: rgba(10, 189, 227, 0.03);
        }

        .col-contest-1 {
            background-color: rgba(255, 159, 67, 0.03);
        }

        .col-contest-2 {
            background-color: rgba(0, 210, 211, 0.03);
        }

        .col-contest-3 {
            background-color: rgba(255, 107, 107, 0.03);
        }

        .target-value-cell {
            font-weight: 800;
            font-size: 14px;
            text-align: center;
        }

        .revenue-value {
            color: var(--primary-accent);
        }

        .contest-value {
            color: var(--secondary-accent);
        }

        .input-pill {
            background: #f8fafc;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            padding: 2px 4px;
            width: 55px;
            text-align: center;
            font-weight: 700;
            font-size: 11px;
            box-shadow: none !important;
            transition: none;
            -moz-appearance: textfield;
            /* Remove arrows in Firefox */
        }

        /* Remove arrows in Chrome/Safari */
        .input-pill::-webkit-outer-spin-button,
        .input-pill::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .input-pill:focus {
            outline: none;
            border-color: var(--primary-accent);
            background: white;
            box-shadow: none !important;
        }

        .input-pill:disabled {
            background: #f1f5f9;
            color: #94a3b8;
            border-color: #e2e8f0;
        }

        .header-main-title {
            font-size: 12px;
            margin-bottom: 4px;
            display: block;
        }

        .header-sub-desc {
            font-size: 9px;
            font-weight: 500;
            color: #94a3b8;
            display: block;
        }

        /* NEW: Style cho hàng tổng trong bảng tổng hợp */
        .comprehensive-table tfoot td {
            font-size: 1.0em;
            background-color: #e9f5f8;
            font-weight: bold;
        }

        /* --- STRAM STYLES --- (Đảm bảo có đủ để hiển thị bảng) */
        .stram-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .stram-table th,
        .stram-table td {
            border: 1px solid #e2e8f0;
            padding: 8px;
            text-align: center;
            vertical-align: middle;
        }

        .stram-table thead th {
            background-color: #F9FAFB;
            font-weight: 600;
        }

        .stram-table td:nth-child(2) {
            text-align: left;
            font-weight: 600;
        }

        .d-level-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: 700;
            color: var(--text-primary);
            font-size: 1.1em;
            border: 2px solid;
        }

        .d1 {
            background-color: rgba(240, 71, 112, 0.1);
            border-color: var(--d1-color);
            color: var(--d1-color);
        }

        .d2 {
            background-color: rgba(247, 140, 106, 0.1);
            border-color: var(--d2-color);
            color: var(--d2-color);
        }

        .d3 {
            background-color: rgba(255, 209, 103, 0.1);
            border-color: var(--d3-color);
            color: var(--d3-color);
        }

        .d4 {
            background-color: rgba(6, 215, 160, 0.1);
            border-color: var(--d4-color);
            color: var(--d4-color);
        }

        .s-level-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: 700;
            color: #fff;
            font-size: 1.1em;
        }

        .s1 {
            background-color: var(--d1-color);
        }

        .s2 {
            background-color: var(--d2-color);
        }

        .s3 {
            background-color: var(--d3-color);
            color: var(--text-primary);
        }

        .s4 {
            background-color: var(--d4-color);
            color: var(--text-primary);
        }

        .btn-stram-detail {
            background: var(--primary-accent);
            color: white;
            padding: 8px 16px;
            border-radius: 12px;
            font-weight: 800;
            font-size: 13px;
            cursor: pointer;
            border: none;
            box-shadow: 4px 4px 8px rgba(0, 0, 0, 0.1);
            text-transform: uppercase;
            transition: all 0.2s;
        }

        .btn-stram-detail:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        /* STRAM Modal */
        #stram-modal .modal-content {
            max-width: 1200px;
        }

        .stram-modal-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 25px;
        }

        .stram-leader-card {
            background: var(--glass-bg);
            padding: 20px;
            border-radius: var(--card-radius);
            border: 1px solid var(--border-main);
            box-shadow: var(--clay-shadow);
            backdrop-filter: blur(10px);
        }

        .stram-leader-card h3 {
            margin-top: 0;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-main);
            padding-bottom: 10px;
        }

        .stram-leader-card h4 {
            color: var(--primary-accent);
            margin-bottom: 8px;
        }

        .stram-leader-card ul {
            padding-left: 20px;
            margin-top: 0;
            font-size: 14px;
            color: var(--text-muted);
        }

        .comprehensive-table th {
            background-color: var(--primary-accent);
            color: white;
            /* High contrast */
            font-weight: 700;
            padding: 2px 2px !important;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            white-space: normal;
            font-size: 11px;
            line-height: 1.1;
        }

        .comprehensive-table td {
            padding: 4px 5px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            color: #1a202c;
            /* Darker text */
            font-weight: 500;
        }

        .clickable-header {
            color: white !important;
            /* Force white on primary bg */
            text-decoration: none;
            display: block;
        }

        .contest-header-cell div {
            color: rgba(255, 255, 255, 0.9) !important;
            /* Light text for details in header */
        }

        .stram-tabs {
            display: flex;
            gap: 5px;
            border-bottom: 2px solid var(--border-main);
            margin-bottom: 20px;
        }

        .stram-tab-btn {
            padding: 12px 24px;
            cursor: pointer;
            background: rgba(0, 0, 0, 0.05);
            border: none;
            border-radius: 12px 12px 0 0;
            font-size: 16px;
            font-weight: 700;
            color: var(--text-muted);
            transition: all 0.3s;
        }

        .stram-tab-btn.active {
            background: var(--primary-accent);
            color: white;
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.1);
        }

        .stram-tab-content {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 0 10px 10px 10px;
            border: 1px solid var(--border-main);
            border-top: none;
        }

        .stram-tab-content.active {
            display: block;
        }

        .stram-task-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .stram-task-table th,
        .stram-task-table td {
            border: 1px solid var(--border-main);
            padding: 10px;
            text-align: center;
            vertical-align: middle;
        }

        .stram-task-table th {
            background-color: #F9FAFB;
        }

        .stram-task-table td:nth-child(1) {
            text-align: left;
            font-weight: 500;
        }

        .stram-progress-bar-bg {
            background-color: #e9ecef;
            border-radius: 50px;
            height: 6px;
            overflow: hidden;
            margin-top: 5px;
        }

        .stram-progress-bar-fill {
            height: 100%;
            border-radius: 50px;
            transition: width 0.5s ease-in-out;
        }

        .stram-progress-bar-fill.success {
            background-color: var(--success-color);
        }

        .stram-progress-bar-fill.danger {
            background-color: var(--danger-color);
        }

        .stram-task-details {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed var(--border-main);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px 10px;
        }

        .stram-task-details>div {
            display: flex;
            justify-content: space-between;
        }

        .stram-task-details .label {
            font-weight: 500;
            color: var(--text-primary);
        }

        .stram-task-details .value {
            font-weight: 700;
        }

        .stram-task-details .value.green {
            color: var(--success-color);
        }

        .stram-task-details .value.red {
            color: var(--danger-color);
        }

        /* --- INFOGRAPHIC STYLES (NEW) --- */
        #infographic-card {
            background-color: transparent !important;
            box-shadow: none !important;
            border: none !important;
            padding: 0 !important;
        }

        /* --- NEW CYBER VIBRANT 3D THEME (FINAL REDESIGN) --- */

        #infographic-report-area {
            font-family: 'Segoe UI', sans-serif;
            background: #f0f4f8;
            /* Nền sáng sạch */
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            max-width: 1200px;
            margin: 0 auto;
        }

        /* --- CYBER VIBRANT THEME - REFINED FIXES --- */

        /* 1. SECTION: TOP 3 PODIUM (CYBER GLOW) */
        .top3-container {
            /* GRADIENT TĂNG CƯỜNG ĐỘ TƯƠI SÁNG */
            background: linear-gradient(135deg, #021B79, #0575E6, #00F260);
            /* Xanh Điện Quang phối Xanh Lá Neon */
            border-radius: 25px;
            padding: 25px 20px 20px;
            position: relative;
            color: #fff;
            text-align: center;
            margin-bottom: 0px;
            box-shadow: 0 20px 60px rgba(5, 117, 230, 0.5);
            /* Bóng đổ màu xanh mạnh */
            border: 2px solid rgba(255, 255, 255, 0.25);
            overflow: visible;
        }

        .top3-header {
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 5px;
            padding-bottom: 10px;
        }

        .top3-header h2 {
            font-size: 2.2em;
            /* Reduced from 3.2em */
            text-transform: uppercase;
            font-weight: 900;
            margin: 0;
            letter-spacing: 2px;
            /* Gradient Text Vàng Cam Rực Rỡ */
            background: linear-gradient(to bottom, #FFFF00, #FFD700, #FFA500);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        /* REMOVED ::before/::after ghost icons */
        .header-trophy-icon {
            font-size: 0.8em;
            color: #FFD700;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.8));
            -webkit-text-fill-color: initial;
            /* Reset gradient text for icon */
        }

        .top3-header p {
            font-size: 1.1em;
            /* Reduced from 1.3em */
            font-weight: 700;
            color: #E0F7FA;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        /* Podium Layout */
        .top3-podium {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 20px;
            margin-top: 5px;
            /* Sát mép đường gạch ngang nhất */
            min-height: auto;
        }

        /* Individual Podium Item */
        .podium-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            width: 260px;
            position: relative;
            /* Ensure absolute children position relative to this */
            z-index: 10;
        }

        /* Order: rank1 center */
        .podium-item.rank1 {
            order: 2;
            z-index: 20;
        }

        .podium-item.rank2 {
            order: 1;
            z-index: 15;
        }

        .podium-item.rank3 {
            order: 3;
            z-index: 15;
        }

        /* STAR WRAPPER - LEFT SIDE below badge */
        .star-wrapper {
            position: absolute;
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 110;
            left: -20px;
            top: 25px;
            /* Sát dưới huy hiệu thứ hạng */
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }

        .podium-item:hover .star-wrapper {
            transform: scale(1.1) rotate(5deg);
        }

        .star-wrapper i.fa-star {
            font-size: 60px;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        /* Rank Colors - Super Vibrant */
        .rank1 .star-wrapper i.fa-star {
            color: #FFEB3B;
            text-shadow: inset 0 0 30px #F57F17;
            filter: drop-shadow(0 0 15px #FFEB3B);
        }

        .rank2 .star-wrapper i.fa-star {
            color: #ECEFF1;
            text-shadow: inset 0 0 30px #90A4AE;
            filter: drop-shadow(0 0 15px #ECEFF1);
        }

        .rank3 .star-wrapper i.fa-star {
            color: #FFAB91;
            text-shadow: inset 0 0 30px #BF360C;
            filter: drop-shadow(0 0 15px #FFAB91);
        }

        .podium-avatar-text {
            position: relative;
            z-index: 30;
            font-size: 1.2em;
            font-weight: 900;
            color: #263238;
            margin-top: 0;
        }

        /* PODIUM BASE - SYNCED COLORS */
        .podium-base {
            width: 100%;
            border-radius: 20px 20px 0 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding-bottom: 25px;
            padding-top: 60px;
            position: relative;
            box-shadow:
                inset 10px 0 20px rgba(255, 255, 255, 0.3),
                inset -10px 0 20px rgba(0, 0, 0, 0.1),
                0 20px 40px rgba(0, 0, 0, 0.2);
            border-top: 1px solid rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(5px);
        }

        .rank1 .podium-base {
            height: 120px;
            background: linear-gradient(135deg, var(--secondary-accent) 0%, #E67E22 100%);
        }

        .rank2 .podium-base {
            height: 90px;
            background: linear-gradient(135deg, var(--primary-accent) 0%, #0984E3 100%);
        }

        .rank3 .podium-base {
            height: 70px;
            background: linear-gradient(135deg, #1DD1A1 0%, #10AC84 100%);
        }

        /* RANK BADGE - TOP LEFT (OUTSIDE) */
        .podium-rank-number {
            position: absolute;
            top: -30px;
            left: -20px;
            right: auto;
            width: 45px;
            height: 45px;
            background: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            font-weight: 900;
            color: #333;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 140;
            /* Over everything */
            border: 3px solid #ccc;
        }

        .rank1 .podium-rank-number {
            border-color: #f1c40f;
            color: #f39c12;
        }

        .rank2 .podium-rank-number {
            border-color: #bdc3c7;
            color: #7f8c8d;
        }

        .rank3 .podium-rank-number {
            border-color: #e67e22;
            color: #d35400;
        }

        .podium-info-card {
            background: #fff;
            width: 95%;
            border-radius: 12px;
            padding: 10px;
            text-align: center;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            color: #333;
            z-index: 10;
            margin-bottom: 0;
            border: 2px solid rgba(255, 255, 255, 0.8);
        }

        .podium-info-card .name {
            display: block;
            font-size: 1.3em;
            font-weight: 800;
            text-transform: uppercase;
            color: #1565C0;
            margin-bottom: 5px;
            border-bottom: 2px solid #E3F2FD;
            padding-bottom: 5px;
        }

        /* Side Rank Container */
        .podium-side-rank {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            z-index: 10;
        }

        .side-rank-number {
            display: none;
            /* Ẩn số nhỏ vì đã có số lớn mờ ở bục */
        }

        .rank1 .side-rank-number {
            border-color: #FFD700;
            color: #E67E22;
        }

        .rank2 .side-rank-number {
            border-color: #b2bec3;
            color: #0984E3;
        }

        .rank3 .side-rank-number {
            border-color: #1DD1A1;
            color: #10AC84;
        }

        .crown-icon {
            position: absolute;
            font-size: 3.2em;
            /* Thu nhỏ */
            top: -30px;
            /* Sát mép trên thẻ */
            right: -15px;
            /* Chéo sang góc bên phải */
            left: auto;
            transform: rotate(20deg);
            /* Xoay chéo */
            filter: drop-shadow(0 0 10px gold);
            z-index: 150;
        }


        /* 2. SECTION: TOP 4-8 (NEUMORPHISM / RAISED 3D CARDS) */
        .mid-tier-container {
            margin-top: 10px;
            padding: 20px;
        }

        .mid-tier-header h3 {
            font-size: 1.8em;
            font-weight: 800;
            color: var(--primary-accent);
            text-transform: uppercase;
            margin-bottom: 5px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .mid-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 25px;
            margin-top: 20px;
        }

        .mid-card {
            background: #fff;
            border-radius: 20px;
            /* Ultra 3D Shadow */
            box-shadow:
                0 1px 2px rgba(0, 0, 0, 0.07),
                0 2px 4px rgba(0, 0, 0, 0.07),
                0 4px 8px rgba(0, 0, 0, 0.07),
                0 8px 16px rgba(0, 0, 0, 0.07),
                0 16px 32px rgba(0, 0, 0, 0.07),
                0 32px 64px rgba(0, 0, 0, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.8);
            padding: 30px 15px;
            text-align: center;
            position: relative;
            transition: transform 0.3s;
            overflow: visible;
        }

        .mid-card:hover {
            transform: translateY(-15px) scale(1.02);
            z-index: 10;
        }

        /* Rank Badge */
        .mid-rank {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #2196F3, #21CBF3);
            color: white;
            padding: 8px 25px;
            border-radius: 30px;
            font-weight: 800;
            font-size: 1em;
            box-shadow: 0 10px 20px rgba(33, 203, 243, 0.4);
            border: 3px solid #fff;
        }

        .mid-avatar {
            width: 80px;
            height: 80px;
            background: #E3F2FD;
            color: #1565C0;
            font-size: 2em;
            font-weight: 800;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px auto 15px;
            border: 4px solid #fff;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .mid-name {
            font-size: 1.3em;
            font-weight: 800;
            color: #37474F;
            margin-bottom: 15px;
            height: 2.5em;
        }

        .mid-stats {
            background: #F5F7F9;
            padding: 10px;
            border-radius: 12px;
            font-size: 0.9em;
            text-align: left;
        }

        .mid-stats b {
            color: #1565C0;
            font-weight: 900;
        }


        /* 3. SECTION: TOP 9+ (WARNING) */
        .bottom-tier-container {
            margin-top: 20px;
            background: var(--glass-bg);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid var(--border-main);
            box-shadow: var(--clay-shadow);
            backdrop-filter: blur(10px);
        }

        .bottom-header h3 {
            color: #D32F2F;
            font-size: 2em;
            text-transform: uppercase;
            font-weight: 900;
            text-align: center;
        }

        .bottom-item {
            background: rgba(235, 77, 75, 0.05);
            border-left: 5px solid var(--danger-color);
            padding: 12px 20px;
            border-radius: 12px;
            margin-bottom: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            border: 1px solid rgba(235, 77, 75, 0.1);
        }

        .bottom-item:hover {
            transform: translateX(10px);
            background: rgba(235, 77, 75, 0.1);
        }

        .bottom-rank {
            font-size: 2em;
            font-weight: 900;
            color: #D32F2F;
            margin-right: 20px;
            min-width: 60px;
        }

        .bottom-name {
            font-size: 1.2em;
            font-weight: 800;
            color: #333;
        }


        /* BUTTON */
        .infographic-actions {
            position: absolute;
            top: 30px;
            right: 30px;
            z-index: 100;
        }

        .btn-download-hd {
            background: #fff;
            color: #2196F3;
            padding: 12px 25px;
            font-weight: 800;
            border-radius: 50px;
            border: none;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
            font-size: 15px;
            text-transform: uppercase;
        }

        .btn-download-hd:hover {
            transform: scale(1.1);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            color: #0D47A1;
        }

        .btn-download-hd {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 6px;
            transition: transform 0.2s;
        }

        .btn-download-hd:hover {
            transform: scale(1.05);
            color: #0277BD;
        }

        /* RESPONSIVE */
        @media (max-width: 900px) {
            .mid-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .top3-podium {
                flex-direction: column;
                align-items: center;
            }

            .podium-item {
                width: 100%;
                max-width: 300px;
                margin-bottom: 20px;
            }

            .podium-item.rank1 {
                order: 1;
                margin-top: 0;
            }

            .podium-item.rank2 {
                order: 2;
            }

            .podium-item.rank3 {
                order: 3;
            }
        }

        .bottom-card {
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background 0.2s;
            padding: 10px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 5px;
        }

        .bottom-card:hover {
            background: #333;
        }

        .bottom-card .rank {
            font-size: 1.8em;
            font-weight: 900;
            color: #555;
            width: 40px;
            text-align: center;
        }

        .bottom-card .content {
            flex-grow: 1;
        }

        .bottom-card .name {
            font-weight: 700;
            color: #fff;
            font-size: 14px;
            display: block;
            margin-bottom: 2px;
        }

        .bottom-card .info {
            color: #ccc;
            font-size: 11px;
            margin-bottom: 2px;
        }

        .bottom-card .stats {
            color: #EF5350;
            font-weight: 600;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .siren-light {
            width: 150px;
            height: 60px;
            background: radial-gradient(circle, rgba(240, 71, 112, 0.6) 0%, rgba(240, 71, 112, 0) 70%);
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0.5;
            pointer-events: none;
            z-index: 0;
        }

        /* Responsive Fixes */
        @media (max-width: 768px) {
            .top3-podium {
                flex-direction: column;
                align-items: center;
                height: auto;
                min-height: auto;
                gap: 30px;
                margin-top: 30px;
            }

            .podium-item {
                width: 100%;
                max-width: 280px;
            }

            .podium-item.rank1 {
                order: 1;
            }

            /* Top 1 đầu tiên */
            .podium-item.rank2 {
                order: 2;
            }

            .podium-item.rank3 {
                order: 3;
            }

            .podium-star {
                width: 100px;
                height: 100px;
            }

            .podium-star.rank1 {
                width: 130px;
                height: 130px;
            }

            .rank1 .podium-base {
                height: 160px;
            }

            .rank2 .podium-base {
                height: 140px;
            }

            .rank3 .podium-base {
                height: 140px;
            }

            .mid-grid {
                grid-template-columns: 1fr 1fr;
            }

            .bottom-list {
                grid-template-columns: 1fr;
            }
        }

        /* --- EVALUATION COMMENT BOX STYLES --- */
        .evaluation-container {
            margin-top: 15px;
            border-top: 1px dashed rgba(0, 0, 0, 0.1);
            padding-top: 10px;
        }

        .evaluation-toggle-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            padding: 5px 0;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: color 0.2s;
        }

        .evaluation-toggle-btn:hover {
            color: var(--primary-accent);
        }

        .evaluation-content {
            background: #f8fafc;
            border-left: 4px solid var(--primary-accent);
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 13px;
            color: #334155;
            line-height: 1.5;
            margin-top: 5px;
            display: none;
            /* Default Hidden */
            animation: fadeIn 0.3s ease;
            text-align: justify;
        }

        .evaluation-content.visible {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body onload="initDashboard()">
    <div class="container">
        <div class="inner-container">

            <div id="report-header"
                style="display: none; align-items: center; justify-content: space-between; margin-bottom: 25px;">
                <h1 style="margin: 0; text-align: left;">Báo cáo Phân tích Hiệu suất</h1>
                <div>
                    <button id="editDataBtn" class="btn btn-inline">Chỉnh sửa Dữ liệu</button>
                </div>
            </div>

            <div class="card" id="data-input-card">
                <h1 style="margin-top:0;">Dashboard Đánh giá Hiệu suất</h1>

                <!-- NEW: Nhập/Xuất Toàn bộ Dữ liệu -->
                <details class="import-export-data"
                    style="margin-bottom: 15px; border-bottom: 1px dashed var(--border-main); padding-bottom: 10px;">
                    <summary
                        style="font-weight: bold; cursor: pointer; color: var(--primary-accent); font-size: 1.05em;">
                        <i class="fas fa-database" style="margin-right: 5px;"></i> Nhập/Xuất Toàn bộ Dữ liệu Dashboard
                        (Backup)
                    </summary>
                    <div style="padding: 5px 0;">
                        <p style="font-size: 11px; color: var(--text-muted); margin-bottom: 5px;">Sao chép mã dưới đây
                            để lưu trữ hoặc dán mã vào để khôi phục toàn bộ trạng thái:</p>
                        <textarea id="allDataImportExportData"
                            style="width: 100%; height: 60px; font-size: 11px; font-family: 'Courier New', Courier, monospace; padding: 5px;"></textarea>
                        <div style="display: flex; gap: 10px; margin-top: 5px; justify-content: space-between;">
                            <button id="exportAllDataBtn" class="btn btn-small"
                                style="background-color: var(--text-muted); width: 48%; height: 30px; line-height: 0; font-size: 11px;">Xuất
                                (Sao chép)</button>
                            <button id="importAllDataBtn" class="btn btn-small"
                                style="background-color: var(--primary-accent); width: 48%; height: 30px; line-height: 0; font-size: 11px;">Nhập
                                (Áp dụng)</button>
                        </div>
                    </div>
                </details>

                <div class="input-grid-compact">
                    <div class="input-group-compact">
                        <h3><a href="https://bi.thegioididong.com/thi-dua-st?id=16753&tab=1&rt=2&dm=2&mt=1"
                                target="_blank" rel="noopener noreferrer"
                                style="text-decoration: none; color: inherit;">Bảng 2: Target Thi đua T(hiện tại)</a>
                        </h3>
                        <textarea id="dataInput2" placeholder="Dán dữ liệu Bảng 2..."></textarea>
                        <button class="btn-paste" data-target="dataInput2" data-filter="table2">Dán & Lọc</button>
                    </div>
                    <div class="input-group-compact">
                        <h3><a href="https://bi.thegioididong.com/sieu-thi-con?id=16753&tab=bcdtnv&rt=2&dm=1"
                                target="_blank" rel="noopener noreferrer"
                                style="text-decoration: none; color: inherit;">Bảng 6: Doanh thu T(hiện tại)</a></h3>
                        <textarea id="dataInput6" placeholder="Dán dữ liệu Bảng 6..."></textarea>
                        <button class="btn-paste" data-target="dataInput6" data-filter="table6">Dán & Lọc</button>
                    </div>
                    <div class="input-group-compact">
                        <h3><a href="https://bi.thegioididong.com/sieu-thi-con?id=16753&tab=bcdtnv&rt=2&dm=1"
                                target="_blank" rel="noopener noreferrer"
                                style="text-decoration: none; color: inherit;">Bảng 7: Dữ liệu Thi đua T(hiện tại)</a>
                        </h3>
                        <textarea id="dataInput7" placeholder="Dán dữ liệu Bảng 7..."></textarea>
                        <button class="btn-paste" data-target="dataInput7" data-filter="table7">Dán & Lọc</button>
                    </div>
                    <!-- MOVED HERE: Target Siêu thị (Triệu) -->
                    <div class="input-group-compact">
                        <h3 style="white-space: nowrap;">Target Siêu thị (Triệu)</h3>
                        <input type="text" id="storeTargetInput" onkeyup="updateEmployeeTargets()"
                            placeholder="Nhập số tiền (VD: 5000)"
                            style="padding: 10px; font-size: 14px; font-weight: bold; color: var(--danger-color); height: 60px; border: 1px solid #ccc;" />
                    </div>
                </div>

                <!-- NEW: Mục nhập liệu LỊCH SỬ (CHỈ T-1) -->
                <details id="historyDataInput"
                    style="margin-top: 15px; border: 1px solid var(--border-main); border-radius: 8px; padding: 10px;">
                    <summary
                        style="font-weight: bold; cursor: pointer; color: var(--secondary-accent); font-size: 1em;">
                        <i class="fas fa-history" style="margin-right: 5px;"></i> Nhập Dữ liệu Tháng Trước (T-1) - (Dùng
                        để chia Target)
                    </summary>
                    <p style="font-size: 11px; color: var(--text-muted); margin-top: 5px; margin-bottom: 5px;">
                        Hệ thống sẽ dùng <b>Tỷ trọng Doanh thu T-1</b> để phân bổ Target Doanh thu & Thi đua cho tháng
                        hiện tại.
                    </p>
                    <div class="input-grid-compact" style="margin-top: 5px;">
                        <!-- T-1 -->
                        <div class="input-group-compact">
                            <h3>Bảng DT T-1 (Doanh thu Tháng Trước)</h3>
                            <textarea id="dataInput6_T1"></textarea>
                            <button class="btn-paste" data-target="dataInput6_T1" data-filter="table6">Dán &
                                Lọc</button>
                        </div>
                        <!-- Contest T-1 removed as per request to use Revenue Weight for all -->
                    </div>
                </details>
                <!-- END NEW: Mục nhập liệu LỊCH SỬ -->

                <!-- Removed grid-container for Store Target as it's moved up -->

                <!-- START NEW: Thay thế Bảng Phân bổ Target cũ bằng Bảng Target có thể chỉnh sửa -->
                <button type="button" class="btn"
                    style="width: 100%; margin-bottom: 15px; background-color: #546E7A; color: white; font-weight: bold;"
                    onclick="const el=document.getElementById('target-allocation-report-card'); el.style.display = el.style.display === 'none' ? 'block' : 'none';">
                    👁️ Hiển thị/Ẩn Bảng Phân bổ Theo Năng lực (DT & TĐ)
                </button>
                <div class="card" id="target-allocation-report-card"
                    style="margin-bottom: 0; padding: 15px; display: none;">
                    <div class="section-header">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h2 style="color:var(--primary-accent); margin-bottom: 0; border: none;">🎯 Target Phân bổ
                                Theo Năng lực (DT & TĐ) & % Đóng góp T-1</h2>
                            <div style="display: flex; gap: 10px;">
                                <!-- Global Equal Checkbox -->
                                <div
                                    style="display: flex; align-items: center; background: #fff; padding: 5px 10px; border-radius: 20px; border: 1px solid var(--border-color); box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                                    <input type="checkbox" id="global_equal_dist"
                                        onchange="toggleAllEqualDistribution(this.checked)">
                                    <label for="global_equal_dist"
                                        style="font-size: 13px; font-weight: 600; color:var(--primary-accent); margin-left: 5px; cursor: pointer;">⚖️
                                        Chia đều (Toàn bộ)</label>
                                </div>
                                <!-- Global T-1 Checkbox -->
                                <div
                                    style="display: flex; align-items: center; background: #fff; padding: 5px 10px; border-radius: 20px; border: 1px solid var(--border-color); box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                                    <input type="checkbox" id="global_t1_dist"
                                        onchange="toggleAllT1Distribution(this.checked)">
                                    <label for="global_t1_dist"
                                        style="font-size: 13px; font-weight: 600; color:var(--primary-accent); margin-left: 5px; cursor: pointer;">⚡
                                        Tự chia T-1 (Toàn bộ)</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- NEW: Nhập/Xuất Dữ liệu Phân bổ Target (Fix 2) -->
                    <details class="import-export-target"
                        style="margin-top: 15px; border-bottom: 1px dashed var(--border-main); padding-bottom: 15px;">
                        <summary
                            style="font-weight: bold; cursor: pointer; color: var(--secondary-accent); font-size: 1.1em;">
                            <i class="fas fa-download" style="margin-right: 8px;"></i> Nhập/Xuất Dữ liệu Phân bổ Target
                            (Targets/Flags)
                        </summary>
                        <div style="padding: 10px 0;">
                            <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Xuất/Nhập dữ liệu
                                phân bổ Target đã chỉnh sửa thủ công (File JSON):</p>
                            <input type="file" id="targetAllocationFileInput" accept=".json" style="display: none;"
                                onchange="handleTargetAllocationFileImport(event)">
                            <div style="display: flex; gap: 10px; margin-top: 10px; justify-content: space-between;">
                                <button id="exportTargetAllocationBtn" class="btn btn-small"
                                    style="background-color: var(--text-muted); width: 48%;">Xuất (Tải file
                                    JSON)</button>
                                <button id="importTargetAllocationBtn" class="btn btn-small"
                                    style="background-color: var(--primary-accent); width: 48%;"
                                    onclick="document.getElementById('targetAllocationFileInput').click();">Nhập (Chọn
                                    file JSON)</button>
                            </div>
                        </div>
                    </details>

                    <!-- NEW: Cấu hình Thời gian Target -->
                    <div id="target-time-config"
                        style="margin-top: 20px; padding: 15px; border: 1px solid var(--border-main); border-radius: 12px; background: #fafafa;">
                        <h3 style="margin: 0 0 10px 0; font-size: 1.1em; color: var(--text-primary);"><i
                                class="far fa-calendar-alt"></i> Cấu hình Thời Gian Target</h3>

                        <div style="display: flex; gap: 20px; margin-bottom: 10px;">
                            <label style="cursor: pointer; display: flex; align-items: center; font-weight: 600;">
                                <input type="radio" name="targetTimeMode" value="full_month" checked
                                    onchange="toggleTargetTimeMode()"
                                    style="width: 18px; height: 18px; margin-right: 8px;">
                                Cả Tháng (Mặc định)
                            </label>
                            <label style="cursor: pointer; display: flex; align-items: center; font-weight: 600;">
                                <input type="radio" name="targetTimeMode" value="range"
                                    onchange="toggleTargetTimeMode()"
                                    style="width: 18px; height: 18px; margin-right: 8px;">
                                Theo Giai Đoạn (Chọn ngày)
                            </label>
                        </div>

                        <div id="target-time-range-inputs"
                            style="display: none; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; padding-top: 10px; border-top: 1px dashed #ccc;">
                            <div class="input-group-compact">
                                <label style="font-weight: 700; font-size: 12px; color: #555;">Từ ngày:</label>
                                <input type="date" id="targetRangeStart" onchange="updateEmployeeTargets()">
                            </div>
                            <div class="input-group-compact">
                                <label style="font-weight: 700; font-size: 12px; color: #555;">Đến ngày:</label>
                                <input type="date" id="targetRangeEnd" onchange="updateEmployeeTargets()">
                            </div>
                            <div class="input-group-compact">
                                <label style="font-weight: 700; font-size: 12px; color: var(--primary-accent);">% Target
                                    Giai đoạn:</label>
                                <input type="number" id="targetRangePercent" value="100" min="1" max="100"
                                    onchange="updateEmployeeTargets()" placeholder="Nhập % (VD: 50)"
                                    style="font-weight: bold; color: var(--primary-accent);">
                                <span style="font-size: 10px; color: #777;">(Ví dụ: Nhập 50 nếu giai đoạn này chiếm 50%
                                    target tháng)</span>
                            </div>
                        </div>
                    </div>

                    <div id="target-global-adjustments"
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                        <!-- Thẻ 1: Target DT -->
                        <div class="card"
                            style="padding: 15px; background: #f0f9ff; border: 1px solid rgba(10, 189, 227, 0.2); border-left: 5px solid var(--primary-accent); display: flex; flex-direction: row; align-items: center; justify-content: space-between; text-align: left; box-shadow: none;">
                            <div>
                                <label
                                    style="font-weight: 800; color: var(--primary-accent); display: block; margin-bottom: 2px; font-size: 14px;">📈
                                    Tăng/Giảm Target DT (%)</label>
                                <span style="font-size: 11px; color: var(--text-muted);">Điều chỉnh toàn shop</span>
                            </div>
                            <input type="number" id="revenueGlobalAdjust" value="0" step="1"
                                onchange="updateEmployeeTargets()"
                                style="width: 70px; padding: 5px; border-radius: 8px; border: 1px solid #cbd5e0; font-weight: 800; text-align: center; font-size: 18px; color: var(--primary-accent); background: white;">
                        </div>
                        <!-- Thẻ 2: Target Thi Đua -->
                        <div class="card"
                            style="padding: 15px; background: #fff7ed; border: 1px solid rgba(255, 159, 67, 0.2); border-left: 5px solid var(--secondary-accent); display: flex; flex-direction: row; align-items: center; justify-content: space-between; text-align: left; box-shadow: none;">
                            <div>
                                <label
                                    style="font-weight: 800; color: var(--secondary-accent); display: block; margin-bottom: 2px; font-size: 14px;">🏆
                                    Tăng/Giảm Target Thi Đua (%)</label>
                                <span style="font-size: 11px; color: var(--text-muted);">Điều chỉnh tất cả ngành
                                    hàng</span>
                            </div>
                            <input type="number" id="contestGlobalAdjust" value="0" step="1"
                                onchange="updateEmployeeTargets()"
                                style="width: 70px; padding: 5px; border-radius: 8px; border: 1px solid #cbd5e0; font-weight: 800; text-align: center; font-size: 18px; color: var(--secondary-accent); background: white;">
                        </div>

                        <!-- Lưu logic ngày đã qua ngầm -->
                        <div id="autoPassedDaysDisplay" style="display: none;">0</div>
                        <input type="hidden" id="manualPassedDaysInput" value="0">
                    </div>

                    <p style="font-size: 13px; color: var(--text-muted); margin-top: 15px; margin-bottom: 8px;">
                        **Gợi ý**: Bạn có thể điều chỉnh Target nhanh bằng cách nhập % tăng/giảm ở trên. Để chỉnh riêng
                        từng ngành hàng, hãy nhập % vào bảng bên dưới.
                    </p>

                    <div id="targetAllocationReportContainer" class="table-container" style="margin-top: 10px;">
                        <div style="padding: 20px; text-align: center; color: #aaa;">Vui lòng dán dữ liệu và nhấn "Tạo
                            Báo Cáo Phân Tích" để phân bổ Target.</div>
                    </div>
                </div>
                <!-- END NEW: Thay thế Bảng Phân bổ Target cũ -->

                <div class="btn-group">
                    <button id="processBtn" class="btn">Tạo Báo Cáo Phân Tích</button>
                    <!-- Nút So sánh đã được chuyển xuống dưới -->
                </div>
            </div>

            <div id="report-capture-area">
                <h2 id="reportTitle"></h2>
                <div id="month-progress-container" class="card"
                    style="display: none; padding: 15px 25px; margin-bottom: 25px; margin-top: 0;"></div>

                <div id="results-wrapper" style="display: none;">
                    <div class="card">
                        <div class="section-header">
                            <h2 style="color:var(--primary-accent); margin-bottom: 0; border: none;"> Bảng Xếp Hạng Tổng
                                Hợp</h2>
                            <!-- NEW: NÚT ĐIỀU KHIỂN ĐÃ ĐƯỢC DI CHUYỂN VÀ TỐI ƯU HÓA -->
                            <!-- Dùng leader-controls-row để đảm bảo các nhóm nằm trên một hàng -->
                            <div class="leaderboard-controls-row">
                                <!-- NHÓM CHỌN NGÀNH HÀNG -->
                                <div id="contestSelectorGroup" style="display: flex; align-items: center; gap: 6px;">
                                    <input type="checkbox" id="allContestsCheckbox"
                                        style="width: 16px; height: 16px; cursor: pointer;">
                                    <label for="allContestsCheckbox"
                                        style="cursor: pointer; font-weight: 600; font-size: 13px; white-space: nowrap;">Tất
                                        cả</label>

                                    <button id="selectContestsBtnCustom" class="btn btn-small">CHỌN NGÀNH</button>
                                    <span id="contestCountStatus"
                                        style="font-size: 11px; color: var(--text-muted); font-weight: 500; display:none;">(0/0)</span>
                                </div>

                                <!-- NHÓM ĐIỀU KHIỂN SO SÁNH -->
                                <div id="comparison-controls">
                                    <label for="comparisonStartDate"
                                        style="font-weight: 700; color: #555; font-size: 12px;">BĐ:</label>
                                    <input type="date" id="comparisonStartDate" class="date-input">
                                    <label for="comparisonEndDate"
                                        style="font-weight: 700; color: #555; font-size: 12px;">KT:</label>
                                    <input type="date" id="comparisonEndDate" class="date-input">
                                    <button id="runComparisonBtn" class="btn btn-small"
                                        style="background: var(--primary-accent);">SO SÁNH</button>
                                    <button id="toggleComparisonBtn" class="btn btn-small"
                                        style="display: none; background: var(--danger-color);">Ẩn</button>
                                </div>

                                <!-- NHÓM NÚT CHỤP -->
                                <div class="capture-group"
                                    style="display: flex; align-items: center; gap: 6px; flex-shrink: 0;">
                                    <button id="captureComprehensiveBtn" class="btn btn-small"
                                        style="background: #00bcd4; color: white; border: none; min-width: 100px;">CHỤP
                                        BẢNG</button>
                                    <button id="captureInfographicBtn" class="btn btn-small"
                                        onclick="captureAndDownload(document.getElementById('infographic-report-area'), 'BaoCao_XepHang_Infographic.png')"
                                        style="background: #00bcd4; color: white; border: none; min-width: 110px;">CHỤP
                                        ĐỒ HỌA</button>
                                </div>
                            </div>
                            <!-- END NEW CONTROL ROW -->
                        </div>
                        <div id="comprehensiveLeaderboardContainer" class="table-container"
                            style="margin-top:15px; position: relative; border-radius: 12px; border: 1px solid var(--border-main);">
                        </div>
                    </div>

                    <!-- PHẦN TARGET PHÂN BỔ CHI TIẾT (NEW) -->
                    <!-- VỊ TRÍ NÀY ĐÃ ĐƯỢC CHUYỂN LÊN TRÊN PHẦN INPUT -->
                    <div id="target-allocation-report-card-spacer" style="display: none;"></div>
                    <!-- END PHẦN TARGET PHÂN BỔ CHI TI TIẾT -->

                    <!-- PHẦN STRAM ĐÃ ĐƯỢC KHÔI PHỤC -->
                    <div class="card" id="stram-analysis-card" style="display: none;">
                        <div class="section-header">
                            <h2 style="color:var(--primary-accent); margin-bottom: 0; border: none;">🔥 Chuẩn đoán STRAM
                                & Phong cách Lãnh đạo</h2>
                        </div>
                        <div id="stramAnalysisContainer" class="table-container" style="margin-top:15px;"></div>
                    </div>
                    <!-- HẾT PHẦN STRAM KHÔI PHỤC -->

                </div>
            </div>

            <div id="kpi-cards-section" style="display: none;">
                <div class="card" style="padding: 15px;">
                    <div class="section-header">
                        <h2 style="color:var(--primary-color); margin-bottom: 0;">🧑‍💻 Phân tích Chi tiết Hiệu suất Cá
                            nhân</h2>

                        <!-- RE-ADDED: Nút chụp KPI đã được đưa lại vào section header này -->
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <!-- NEW: Global Comment Controls -->
                            <button id="showAllCommentsBtn" class="btn btn-small" onclick="toggleAllComments(true)"
                                style="background-color: #607D8B;">👁 Xem Nhận xét</button>
                            <button id="hideAllCommentsBtn" class="btn btn-small" onclick="toggleAllComments(false)"
                                style="background-color: #90A4AE;">🙈 Ẩn Nhận xét</button>

                            <button id="captureCardsBtn" class="btn btn-small">Chụp Thẻ KPI</button>
                            <button id="captureAllCardsBtn" class="btn btn-small">Chụp Tất Cả KPI</button>
                        </div>
                    </div>
                    <!-- container cards -->
                    <div id="allCardsContainer"></div>
                </div>
            </div>

            <!-- NEW INFOGRAPHIC SECTION -->
            <div id="infographic-report-area" style="display: none; margin-bottom: 25px;">
                <!-- Container cho Infographic, sẽ được JS populate -->
            </div>

            <!-- OLD COMMENTS CARD (Hidden but kept for copy functionality) -->
            <div class="card" id="comments-card" style="display: none;">
                <div id="comments-section">
                    <div class="section-header"
                        style="padding-bottom: 10px; border-bottom: 1px solid var(--border-main); margin-bottom: 15px;">
                        <h3 style="margin:0; font-size: 1.2em;">📋 Nhận xét Text (Copy)</h3>
                        <button id="copyCommentsBtn" class="btn btn-small">Sao chép Nhận xét</button>
                    </div>
                    <textarea id="comments-textarea" readonly
                        style="width: 100%; height: 200px; font-family: 'Courier New', Courier, monospace; background-color: #f8f9fa; border: 1px solid #ccc; border-radius: 5px; padding: 10px; resize: vertical;"></textarea>
                </div>
            </div>

            <!-- ĐÃ XÓA div#infographic-card VÀ CÁC THÀNH PHẦN LIÊN QUAN -->

        </div>
    </div>

    <div id="toast-notification" class="toast"></div>

    <div id="kpi-modal" class="modal">
        <div class="modal-content">
            <div class="modal-close-btn" onclick="window.closeModal('kpi-modal')"><i class="fa-solid fa-xmark"></i>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

    <div id="stram-modal" class="modal">
        <div class="modal-content">
            <div class="modal-close-btn" onclick="window.closeModal('stram-modal')"><i class="fa-solid fa-xmark"></i>
            </div>
            <h2 id="stram-modal-title" style="margin-top:0; color: var(--primary-accent);"></h2>
            <div id="stram-modal-body"></div>
        </div>
    </div>
    <div id="contest-selection-modal" class="modal">
        <div class="modal-content">
            <div class="modal-close-btn" onclick="window.closeModal('contest-selection-modal')"><i
                    class="fa-solid fa-xmark"></i></div>
            <h2 style="margin-top:0; color: var(--primary-accent);">Chọn Ngành hàng Thi đua</h2>

            <!-- NEW: Nhập/Xuất Panel (với nút Áp dụng Bộ lọc cùng hàng) -->
            <details class="import-export-panel" open style="margin-bottom: 20px;">
                <summary style="font-weight: bold; cursor: pointer; color: var(--text-primary); padding: 5px 0;">
                    <i class="fas fa-folder-open" style="margin-right: 8px;"></i> Nhập/Xuất Danh sách (Click để mở)
                </summary>
                <div style="padding: 10px 0;">
                    <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Sao chép mã dưới đây để
                        chia sẻ hoặc dán mã vào để khôi phục toàn bộ trạng thái:</p>
                    <textarea id="contestImportExportData"
                        style="width: 100%; height: 80px; font-size: 12px; font-family: 'Courier New', Courier, monospace;"></textarea>
                    <div style="display: flex; gap: 10px; margin-top: 10px; justify-content: space-between;">
                        <!-- ĐÃ SỬA LỖI: Thêm sự kiện click cho nút Xuất -->
                        <button id="exportContestBtn" class="btn btn-small"
                            style="background-color: var(--text-muted); width: 30%;">Sao chép (Xuất)</button>
                        <!-- ĐÃ SỬA LỖI: Thêm sự kiện click cho nút Nhập -->
                        <button id="importContestBtn" class="btn btn-small"
                            style="background-color: var(--success-color); width: 30%;">Áp dụng (Nhập)</button>
                        <!-- Nút Áp dụng Bộ lọc mới -->
                        <button id="applyContestSelectionBtn" class="btn btn-small"
                            style="background-color: var(--primary-accent); width: 30%;">Áp dụng Bộ lọc</button>
                    </div>
                </div>
            </details>
            <!-- END NEW: Nhập/Xuất Panel -->

            <div style="margin-bottom: 15px;">
                <!-- ĐÃ SỬA LỖI: Chỉ gán sự kiện cho hàng item con, loại bỏ sự kiện toggleCheckboxInModal khỏi đây -->
                <div class="contest-item">
                    <!-- ĐÃ SỬA LỖI: Thêm sự kiện onclick và stopPropagation để chỉ checkbox hoạt động khi click vào nó -->
                    <input type="checkbox" id="modalSelectAllContests"
                        onclick="event.stopPropagation(); toggleAllModalContests(this.checked);">
                    <label for="modalSelectAllContests" style="font-weight: bold; color: var(--primary-accent);">**Chọn
                        tất cả**</label>
                </div>
            </div>
            <div id="contest-list">
            </div>
            <!-- XÓA modal-footer để chuyển nút Apply lên trên -->
        </div>
    </div>

    <!-- Loại bỏ modal comparison-modal vì đã chuyển chức năng hiển thị trực tiếp lên thẻ KPI -->

    <script>
        // Global data store
        var finalData = [];
        var allContestHeadersGlobal = []; // Danh sách tất cả các ngành hàng từ dataInput7
        var selectedContestHeaders = []; // Danh sách các ngành hàng đã được chọn
        var sortedContestHeadersGlobal = []; // Danh sách các ngành hàng đã được chọn và sắp xếp theo % HT

        // NEW: Biến lưu trữ % điều chỉnh (Adjustments)
        var revenueGlobalAdjust = 0; // % tăng/giảm DT toàn shop
        var contestGlobalAdjust = 0; // % tăng/giảm TĐ toàn bộ ngành hàng
        var contestAdjustPercents = new Map(); // Key: CategoryName, Value: % adjustment riêng biệt

        // NEW: Biến lưu danh sách nhân viên tạm thời cho phần Target
        var detectedEmployees = [];
        var comparisonResultsCache = null; // Cache kết quả so sánh
        // Target phân bổ theo Năng lực (chỉ dùng làm mặc định ban đầu và lưu % 3T)
        var employeeTargetsBySkill = new Map();
        // Target cuối cùng (bao gồm chỉnh sửa thủ công và trạng thái active)
        var finalEmployeeTargets = new Map();

        // NEW: Trạng thái Chia đều (Equal Distribution)
        var equalDistributionFlags = new Map(); // Key: 'DT_Target' hoặc 'ContestName_TargetTD'
        var t1DistributionFlags = new Map(); // Checkbox "Theo T-1"

        // Cấu trúc dữ liệu lịch sử DT cho 1 tháng T-1
        const historyDataInputs = [
            { idDT: 'dataInput6_T1' }
        ];

        // --- KHỞI TẠO ---
        // GLOBAL MODAL CLOSE FUNCTION
        window.closeModal = function (modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = "none";
            }
        };

        function initDashboard() {
            // Load saved values from localStorage
            const idsToLoad = ['dataInput7', 'dataInput6', 'dataInput2', 'storeTargetInput', 'allContestsCheckbox'];
            historyDataInputs.forEach(h => {
                idsToLoad.push(h.idDT);
            });

            // Load Target Time Configuration
            const savedTimeMode = localStorage.getItem('targetTimeMode');
            if (savedTimeMode) {
                const radio = document.querySelector(`input[name="targetTimeMode"][value="${savedTimeMode}"]`);
                if (radio) {
                    radio.checked = true;
                    toggleTargetTimeMode(); // Update UI visibility
                }
            }
            if (localStorage.getItem('targetRangeStart')) document.getElementById('targetRangeStart').value = localStorage.getItem('targetRangeStart');
            if (localStorage.getItem('targetRangeEnd')) document.getElementById('targetRangeEnd').value = localStorage.getItem('targetRangeEnd');
            if (localStorage.getItem('targetRangePercent')) document.getElementById('targetRangePercent').value = localStorage.getItem('targetRangePercent');

            idsToLoad.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    const savedValue = localStorage.getItem(id);
                    if (savedValue !== null) {
                        if (el.type === 'checkbox') {
                            el.checked = savedValue === 'true';
                        } else {
                            el.value = savedValue;
                        }
                    }
                }
            });

            // Load selected contests
            const savedContests = localStorage.getItem('selectedContestHeaders');
            if (savedContests) {
                selectedContestHeaders = JSON.parse(savedContests);
            }

            // Load Target cuối cùng nếu có
            const savedFinalTargets = localStorage.getItem('finalEmployeeTargets');
            if (savedFinalTargets) {
                finalEmployeeTargets = new Map(Object.entries(JSON.parse(savedFinalTargets)));
            }

            // Load Equal Distribution Flags (MỚI)
            const savedFlags = localStorage.getItem('equalDistributionFlags');
            if (savedFlags) {
                equalDistributionFlags = new Map(Object.entries(JSON.parse(savedFlags)));
            }

            // Load T-1 Distribution Flags
            const savedT1Flags = localStorage.getItem('t1DistributionFlags');
            if (savedT1Flags) {
                t1DistributionFlags = new Map(Object.entries(JSON.parse(savedT1Flags)));
            }

            // **NEW FIX: Đặt ngày bắt đầu mặc định là hôm qua**
            const startDateEl = document.getElementById('comparisonStartDate');
            if (!startDateEl.value) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                startDateEl.value = formatDate(yesterday);
            }
            // **END NEW FIX**

            // Set default date values
            document.getElementById('comparisonEndDate').value = getTodayDateString();

            // Add event listeners
            document.getElementById('processBtn').addEventListener('click', processData);
            document.getElementById('editDataBtn').addEventListener('click', showInputCard);
            // Gán sự kiện dán cho cả inputs lịch sử
            document.getElementById('data-input-card').addEventListener('click', handlePaste);
            document.getElementById('captureComprehensiveBtn').addEventListener('click', captureFullTable);
            document.getElementById('captureCardsBtn').addEventListener('click', captureAllIndividualCards);
            document.getElementById('captureAllCardsBtn').addEventListener('click', () => captureAndDownload(document.getElementById('kpi-cards-section'), 'TatCa_KPI_NhanVien.png'));
            document.getElementById('copyCommentsBtn').addEventListener('click', copyComments);

            // NEW EVENT LISTENERS for Import/Export & History
            // ĐÃ SỬA LỖI: Đảm bảo các sự kiện này được gán đúng
            document.getElementById('exportContestBtn').addEventListener('click', exportContestSelection);
            document.getElementById('importContestBtn').addEventListener('click', importContestSelection);

            // NEW EVENT LISTENERS for All Data Import/Export
            document.getElementById('exportAllDataBtn').addEventListener('click', exportAllData);
            document.getElementById('importAllDataBtn').addEventListener('click', importAllData);

            // NEW EVENT LISTENERS for Target Allocation Import/Export (File JSON)
            document.getElementById('exportTargetAllocationBtn').addEventListener('click', exportTargetAllocation);
            // Lệnh click cho nút nhập đã được đặt inline để kích hoạt input type="file"


            // XÓA: document.getElementById('saveDailyBtn').addEventListener('click', ...);


            // Gán sự kiện cho nút So sánh trực quan mới
            document.getElementById('runComparisonBtn').addEventListener('click', runComparison);

            // Gán sự kiện cho nút Ẩn/Hiện So sánh mới
            document.getElementById('toggleComparisonBtn').addEventListener('click', toggleComparisonDisplay);

            // Gắn sự kiện cho nút Áp dụng Bộ lọc trong Import/Export
            document.getElementById('applyContestSelectionBtn').addEventListener('click', applyContestSelection);


            // NEW CONTEST SELECTION BUTTONS
            document.getElementById('selectContestsBtnCustom').addEventListener('click', showContestSelectionModal);

            // Checkbox "Hiển thị TẤT CẢ"
            document.getElementById('allContestsCheckbox').addEventListener('change', (e) => {
                localStorage.setItem('allContestsCheckbox', e.target.checked);
                // SỬA LỖI 1: Luôn gọi processData(false, false) để re-render khi trạng thái TẤT CẢ thay đổi.
                if (finalData.length > 0 || document.getElementById('dataInput7').value.trim() !== '') {
                    showToast(e.target.checked ? 'Đã chọn hiển thị TẤT CẢ. Đang cập nhật báo cáo...' : 'Đã bỏ chọn TẤT CẢ. Đang cập nhật báo cáo...');
                    processData(false, false);
                }
            });

            // Sự kiện khi nhập/dán dữ liệu để tự động load danh sách nhân viên (gồm cả inputs lịch sử)
            // SỬA LỖI: Gọi extractEmployeesFromInputs khi có input thay đổi để tự động hiển thị Target Allocation
            ['dataInput6', 'dataInput7', 'dataInput6_T1', 'dataInput6_T2', 'dataInput6_T3', 'dataInput7_T1', 'dataInput7_T2', 'dataInput7_T3', 'storeTargetInput'].forEach(id => {
                document.getElementById(id).addEventListener('input', () => {
                    setTimeout(extractEmployeesFromInputs, 500); // Debounce nhẹ
                });
            });


            // Modal close buttons (chỉ còn cho Contest và Stram)
            // Improved Modal Handling (Backdrop Click Only)
            document.addEventListener('click', (event) => {
                // Handle Backdrop Click (Click outside content)
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = "none";
                }
            });

            updateContestStatusUI(); // Cập nhật trạng thái ngay khi load
            // Thử load nhân viên nếu đã có dữ liệu trong localStorage
            extractEmployeesFromInputs();

        }

        // --- HÀM HỖ TRỢ & TIỆN ÍCH ---
        function showToast(message) {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }

        function formatNumberFull(num, decimals = 0) {
            if (isNaN(num) || num === null) return '0';
            return num.toLocaleString('vi-VN', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        }

        // NEW: Helper to safely read target values (non-Triệu format)
        function safeParseFloat(value) {
            const num = parseFloat(String(value).replace(/,/g, '')) || 0;
            return isNaN(num) ? 0 : num;
        }

        // Hàm tạo chữ cái đầu (VD: D.X.L)
        function getInitials(name) {
            if (!name) return '';
            const parts = name.trim().split(' ').filter(p => p);
            // Lấy chữ cái đầu của tên cuối, nếu có 3 phần tử trở lên, lấy chữ cái đầu của 2 phần tử cuối (VD: Phan Đình Hưng -> P.H)
            if (parts.length >= 2) {
                return `${parts[0].charAt(0)}${parts[parts.length - 1].charAt(0)}`.toUpperCase();
            }
            // Nếu chỉ có 1 từ, lấy 2 chữ cái đầu
            if (parts.length === 1) return parts[0].substring(0, 2).toUpperCase();
            return '';
        }

        // Hàm tạo tên viết tắt (VD: N.T.Hoàng)
        function abbreviateName(name) {
            if (!name) return '';
            const parts = name.trim().split(' ').filter(p => p);
            if (parts.length <= 1) return name;
            const lastName = parts.pop();
            const initials = parts.map(p => p.charAt(0).toUpperCase()).join('.');
            return `${initials}.${lastName}`;
        }

        // NEW: Hàm hỗ trợ ngày tháng
        function formatDate(date) {
            const d = new Date(date);
            let month = '' + (d.getMonth() + 1);
            let day = '' + d.getDate();
            const year = d.getFullYear();

            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;

            return [year, month, day].join('-');
        }

        function getTodayDateString() {
            return formatDate(new Date());
        }

        function getContestTimeframe(header) {
            const manualPassedDaysInput = document.getElementById('manualPassedDaysInput');
            const manualPassedDays = manualPassedDaysInput ? parseInt(manualPassedDaysInput.value) : 0;

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const currentYear = today.getFullYear();
            let passedDays, totalDays;

            // Tính toán số ngày đã qua (Passed Days) và tổng số ngày trong khung thời gian (Total Days)
            // Số ngày còn lại = Total Days - Passed Days (hoặc Today.getDate())

            // Lấy tổng số ngày của tháng hiện tại
            totalDays = new Date(currentYear, today.getMonth() + 1, 0).getDate();
            if (manualPassedDays > 0) {
                passedDays = manualPassedDays;
            } else {
                // Số ngày đã trôi qua (Tính đến HÔM QUA)
                passedDays = today.getDate() - 1;
            }

            // Số ngày còn lại (kể cả hôm nay) = Total Days - Passed Days
            const remainingDays = Math.max(0, totalDays - passedDays);

            // Mặc định cho trường hợp không xác định khung T(x)-T(y)
            const defaultTimeframe = {
                passedDays: Math.max(1, passedDays),
                totalDays,
                remainingDays: Math.max(1, remainingDays)
            };

            const match = header.match(/\(\s*T(\d+)\s*-\s*T(\d+)\s*\)/);

            if (match) {
                try {
                    const startMonth = parseInt(match[1], 10) - 1;
                    const endMonth = parseInt(match[2], 10) - 1;
                    const startDate = new Date(currentYear, startMonth, 1);
                    const endDate = new Date(currentYear, endMonth + 1, 0);

                    if (isNaN(startDate.getTime()) || isNaN(endDate.getTime()) || startDate > endDate) return defaultTimeframe;

                    let totalDaysInContest = 0;
                    for (let m = startMonth; m <= endMonth; m++) totalDaysInContest += new Date(currentYear, m + 1, 0).getDate();

                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    yesterday.setHours(0, 0, 0, 0);

                    // SỬA LỖI THEO YÊU CẦU: Tự động tính số ngày đã qua theo quy tắc mới
                    if (today.getDate() === 1) {
                        // Nếu là ngày 1 đầu tháng, lấy số ngày tháng trước
                        const lastDayPrevMonth = new Date(currentYear, today.getMonth(), 0);
                        passedDaysInContest = lastDayPrevMonth.getDate();
                    } else {
                        // Ngược lại = ngày hiện tại - 1
                        passedDaysInContest = today.getDate() - 1;
                    }

                    // Cập nhật hiển thị UI
                    const displayElem = document.getElementById('autoPassedDaysDisplay');
                    if (displayElem) displayElem.innerText = passedDaysInContest;
                    const manualInput = document.getElementById('manualPassedDaysInput');
                    if (manualInput) manualInput.value = passedDaysInContest;

                    const remainingDaysInContest = Math.max(0, totalDaysInContest - passedDaysInContest);


                    return {
                        passedDays: Math.max(1, passedDaysInContest),
                        totalDays: totalDaysInContest,
                        remainingDays: Math.max(1, remainingDaysInContest) // Số ngày còn lại (kể cả hôm nay)
                    };
                } catch (e) { return defaultTimeframe; }
            }
            return defaultTimeframe;
        }

        // NEW: Cập nhật trạng thái số lượng ngành hàng đã chọn
        function updateContestStatusUI() {
            const total = allContestHeadersGlobal.length;
            const selected = selectedContestHeaders.length;

            const allCheckbox = document.getElementById('allContestsCheckbox');

            if (allCheckbox && document.getElementById('contestCountStatus')) {
                if (allCheckbox.checked) {
                    document.getElementById('contestCountStatus').textContent = `(${total}/${total} nhóm được chọn)`;
                } else {
                    document.getElementById('contestCountStatus').textContent = `(${selected}/${total} nhóm được chọn)`;
                }
            }
        }
        // --- FINAL FIX: SỬA LỖI "contest3MonthContribution.get is not a function" ---
        function extractEmployeesFromInputs() {
            try {
                console.log("Đang bắt đầu trích xuất dữ liệu...");
                const allInputIds = ['dataInput6', 'dataInput7', 'dataInput6_T1', 'dataInput6_T2', 'dataInput6_T3', 'dataInput7_T1', 'dataInput7_T2', 'dataInput7_T3'];
                let employeeSet = new Set();

                // 1. QUÉT NHÂN VIÊN
                allInputIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (!el || !el.value.trim()) return;

                    const lines = el.value.split('\n');
                    lines.forEach(line => {
                        if (line.includes('-') || line.includes('–')) {
                            const parts = line.split(/[\t]/);
                            parts.forEach(cell => {
                                const cleanCell = cell.trim();
                                if (cleanCell.length > 5 && /[a-zA-Z]/.test(cleanCell) && /\d+$/.test(cleanCell)) {
                                    if (!cleanCell.startsWith('TỔNG') &&
                                        !cleanCell.startsWith('BP') &&
                                        !cleanCell.includes('Nhân viên') &&
                                        !cleanCell.includes('Siêu thị')) {
                                        employeeSet.add(cleanCell);
                                    }
                                }
                            });
                        }
                    });
                });

                // 2. QUÉT NGÀNH HÀNG (Bảng 7)
                const data7 = document.getElementById('dataInput7').value;
                let foundHeaders = [];

                if (data7.trim()) {
                    const lines7 = data7.split('\n').filter(l => l.trim());
                    const stopIndex = lines7.findIndex(line => line.includes('DTQĐ') || (line.includes('SLLK') && line.includes('DTLK')));

                    if (stopIndex > 0) {
                        const potentialHeaders = lines7.slice(0, stopIndex);
                        potentialHeaders.forEach(row => {
                            const cols = row.split('\t');
                            cols.forEach(c => {
                                const val = c.trim();
                                if (val && isNaN(val) && val !== 'Phòng ban' && !val.startsWith('BP ')) {
                                    foundHeaders.push(val);
                                }
                            });
                        });
                        if (foundHeaders.length > 0) {
                            allContestHeadersGlobal = [...new Set(foundHeaders)];
                        }
                    }
                }
                // 3. Xử lý logic hiển thị
                // (Logic kiểm tra hasRealTimeData đã được chuyển xuống processData để tránh lỗi)
                if (selectedContestHeaders.length === 0 && allContestHeadersGlobal.length > 0) {
                    selectedContestHeaders = [...allContestHeadersGlobal];
                    localStorage.setItem('selectedContestHeaders', JSON.stringify(selectedContestHeaders));
                }

                // 3. TÍNH TOÁN VÀ HIỂN THỊ
                if (employeeSet.size > 0) {
                    const newEmployeeList = Array.from(employeeSet).sort();

                    detectedEmployees = newEmployeeList.map(id => ({
                        id: id, name: id.split(/ [-–] /)[0].trim(), checked: true, percent: 0
                    }));

                    // Tính toán Target ban đầu
                    const initialTargets = calculateInitialTargets(allContestHeadersGlobal);

                    initialTargets.forEach((initial, id) => {
                        let existing = finalEmployeeTargets.get(id);

                        // ĐẢM BẢO contest3MonthContribution LUÔN LÀ MAP
                        let contest3MonthMap;
                        if (initial.contest3MonthContribution instanceof Map) {
                            contest3MonthMap = initial.contest3MonthContribution;
                        } else {
                            contest3MonthMap = new Map(Object.entries(initial.contest3MonthContribution || {}));
                        }

                        if (!existing) {
                            finalEmployeeTargets.set(id, {
                                ...initial,
                                contest3MonthContribution: contest3MonthMap, // Gán đúng kiểu Map
                                manualDtPercent: initial.dtPercent3T,
                                manualContestPercent: Object.fromEntries(contest3MonthMap),
                                isActive: true
                            });
                        } else {
                            // Cập nhật cái mới nhưng giữ cái cũ
                            existing.contestTargets = initial.contestTargets;
                            existing.contest3MonthContribution = contest3MonthMap; // Cập nhật Map mới nhất

                            if (!existing.manualContestPercent) existing.manualContestPercent = {};

                            contest3MonthMap.forEach((percent, contestName) => {
                                if (existing.manualContestPercent[contestName] === undefined) {
                                    existing.manualContestPercent[contestName] = percent;
                                }
                            });
                            finalEmployeeTargets.set(id, existing);
                        }
                    });

                    // Lưu vào storage (khi lưu nó sẽ biến Map thành Object, nhưng khi load lại ta phải parse cẩn thận)
                    // Ở đây ta render trực tiếp từ biến finalEmployeeTargets đang ở trong RAM (là Map chuẩn)
                    localStorage.setItem('finalEmployeeTargets', JSON.stringify(Object.fromEntries(finalEmployeeTargets)));

                    renderTargetAllocationReport(finalEmployeeTargets, allContestHeadersGlobal);

                    showToast(`✅ Thành công: ${employeeSet.size} NV & ${allContestHeadersGlobal.length} Ngành hàng!`);

                } else {
                    if (allContestHeadersGlobal.length > 0) {
                        showToast(`⚠️ Đã thấy ${allContestHeadersGlobal.length} ngành hàng, nhưng chưa thấy Nhân viên.`);
                        renderTargetAllocationReport(new Map(), allContestHeadersGlobal);
                    }
                }

                updateContestStatusUI();

            } catch (error) {
                console.error(error);
                showToast("❌ Lỗi xử lý: " + error.message);
            }
        }
        function calculateInitialTargets(targetContestHeaders = []) {
            if (detectedEmployees.length === 0) return new Map();

            const allEmployeeIds = detectedEmployees.map(e => e.id);
            const dtContributionMap = calculateAverageDTContribution(allEmployeeIds);

            // Target TĐ cần lấy danh sách ngành hàng hiện tại
            const headersToUse = targetContestHeaders.length > 0 ? targetContestHeaders : [...allContestHeadersGlobal];

            // OLD: const contestContributionMap = calculateContestContribution(allEmployeeIds, headersToUse);
            // NEW: Use Revenue Weight (dtContributionMap) for contest distribution as well
            const contestContributionMap = dtContributionMap;

            const totalStoreTarget = safeParseFloat(document.getElementById('storeTargetInput').value);

            const initialTargets = new Map();

            // Lấy Target Siêu thị (Bảng 2)
            const contestTargetsStore = {};
            const data2 = document.getElementById('dataInput2').value;
            if (data2.trim()) {
                const lines2 = data2.split('\n').filter(line => line.trim());
                if (lines2.length > 1) {
                    const headers2 = lines2.shift().split('\t').map(h => h.trim());
                    const nameIndex2 = headers2.findIndex(h => h.includes('Ngành hàng'));
                    const targetIndex2 = headers2.findIndex(h => h === 'Target');
                    if (nameIndex2 !== -1 && targetIndex2 !== -1) {
                        lines2.forEach(row => {
                            const cells = row.split('\t');
                            const categoryName = (cells[nameIndex2] || '').trim();
                            // Chỉ lấy các ngành hàng có trong allContestHeadersGlobal
                            if (allContestHeadersGlobal.includes(categoryName)) {
                                const target = safeParseFloat(cells[targetIndex2]);
                                contestTargetsStore[categoryName] = target;
                            }
                        });
                    }
                }
            }

            detectedEmployees.forEach(emp => {

                const dtPercent = dtContributionMap.get(emp.id) || (100 / detectedEmployees.length);
                const dtTarget = totalStoreTarget * (dtPercent / 100);

                const contestTargets = {};
                const contest3MonthContribution = new Map();

                headersToUse.forEach(h => {
                    if (contestTargetsStore[h]) {
                        // NEW LOGIC: Use Revenue Weight (dtPercent) for Contest Targets as well
                        // Previously: const contestPercentMap = contestContributionMap.get(h);
                        // contestContributionMap IS NOW dtContributionMap (Map<EmpId, Percent>)

                        // % này lấy trực tiếp từ Tỷ trọng DT T-1 của nhân viên
                        const contestPercent = dtPercent;

                        // Target TĐ theo SKILL (chỉ để làm Target ban đầu)
                        contestTargets[h] = Math.ceil(contestTargetsStore[h] * (contestPercent / 100));
                        contest3MonthContribution.set(h, contestPercent);
                    }
                });

                initialTargets.set(emp.id, {
                    id: emp.id,
                    name: emp.name,
                    dtPercent3T: dtPercent, // % T-1 Contribution (renamed purely in comment, keep key for compat)
                    dtTarget: dtTarget,
                    manualDtPercent: dtPercent,
                    contestTargets: contestTargets,
                    contest3MonthContribution: contest3MonthContribution,
                    manualContestPercent: {},
                    isActive: true
                });
            });

            return initialTargets;
        }

        // Hàm này bị loại bỏ vì giờ phân bổ tự động theo skill, không cho phép nhập % thủ công
        function toggleAllEmployees(checked) { return; }
        function updateEmployeeCheck(index, checked) { return; }
        function updateEmployeePercent(index, value) { return; }
        function updateEmployeeTargets() { /* Vẫn giữ nhưng chỉ gọi lại processData để re-render target */
            // NEW: Sau khi nhập Target Siêu thị, chỉ cần render lại Target Allocation Table
            if (finalEmployeeTargets.size > 0) {
                // SỬA LỖI: Dùng allContestHeadersGlobal để hiển thị vì target allocation report chỉ hiển thị sơ bộ
                renderTargetAllocationReport(finalEmployeeTargets, allContestHeadersGlobal);
            }
        }

        // NEW: Hàm tính % đóng góp DT tháng trước (T-1)
        function calculateAverageDTContribution(employeeIds) {
            const dtData = []; // Mảng chứa tổng DT

            // CHỈ LẤY T-1
            const dtInputIds = ['dataInput6_T1'];

            dtInputIds.forEach(id => {
                const data = document.getElementById(id).value;
                if (data.trim()) {
                    const lines = data.split('\n');
                    const headers = lines[0].split('\t').map(h => h.trim());
                    const nameIndex = headers.findIndex(h => h.includes('Nhân viên'));
                    const dtlkIndex = headers.findIndex(h => h === 'DTLK');

                    if (nameIndex !== -1 && dtlkIndex !== -1) {
                        const monthData = new Map();
                        lines.slice(1).forEach(row => {
                            const cells = row.split('\t');
                            const nameId = (cells[nameIndex] || '').trim();
                            if (employeeIds.includes(nameId)) {
                                const dtlk = safeParseFloat(cells[dtlkIndex]);
                                monthData.set(nameId, dtlk);
                            }
                        });
                        dtData.push(monthData);
                    }
                }
            });

            const dtTotalMap = new Map(); // Tổng DT qua các tháng có dữ liệu
            employeeIds.forEach(id => dtTotalMap.set(id, 0));

            dtData.forEach(monthData => {
                monthData.forEach((dt, id) => {
                    dtTotalMap.set(id, dtTotalMap.get(id) + dt);
                });
            });

            const grandTotalDT = Array.from(dtTotalMap.values()).reduce((sum, dt) => sum + dt, 0);

            const contributionMap = new Map();
            if (grandTotalDT > 0) {
                employeeIds.forEach(id => {
                    const totalDT = dtTotalMap.get(id);
                    const percent = (totalDT / grandTotalDT) * 100;
                    contributionMap.set(id, percent);
                });
            } else {
                // Chia đều nếu không có dữ liệu lịch sử nào
                const evenPercent = 100 / employeeIds.length;
                employeeIds.forEach(id => contributionMap.set(id, evenPercent));
            }

            return contributionMap;
        }

        // NEW: Hàm lấy tên nhóm hàng gốc (bỏ tháng/năm)
        function normalizeContestName(header) {
            // Loại bỏ các pattern như (Txx-Tyy), Txx, Mxx, yy/mm, Month
            let name = header.replace(/\s*(\(\s*T\d+\s*-\s*T\d+\s*\))|(\s*T\d+)|(\s*M\d+)|(\s*\d{2}\/\d{2})|(\s*Tháng\s*\d+)/gi, '').trim();
            // Lọc các ký tự đặc biệt và đưa về chữ thường để so sánh (ví dụ: Camera/Camera)
            return name.replace(/[^a-zA-Z0-9\s]/g, '').toLowerCase();
        }

        // NEW: Hàm tính % đóng góp TĐ trung bình 3 tháng (T-1, T-2, T-3) cho TỪNG NGÀNH HÀNG
        function calculateContestContribution(employeeIds, targetContestHeaders) {
            const contestDataByMonth = []; // Array of { month: { normalizedName: { id: actualValue } } }
            const tdInputIds = ['dataInput7_T1', 'dataInput7_T2', 'dataInput7_T3'];

            tdInputIds.forEach(id => {
                const data = document.getElementById(id).value;
                if (data.trim()) {
                    const lines = data.split('\n').filter(line => line.trim());
                    const subHeaderIndex = lines.findIndex(line => line.trim().startsWith('SLLK'));
                    const headers = lines.slice(1, subHeaderIndex).map(h => h.trim()).filter(Boolean);
                    const fullHeaderMap = headers.reduce((map, header, index) => {
                        map[header] = index;
                        return map;
                    }, {});

                    const monthContestData = new Map(); // Map<NormalizedName, Map<EmployeeId, ActualValue>>

                    lines.slice(subHeaderIndex + 1).forEach(row => {
                        const cells = row.split('\t');
                        const nameId = (cells[0] || '').trim();

                        if (employeeIds.includes(nameId)) {
                            headers.forEach(header => {
                                const actualIndex = fullHeaderMap[header];
                                const actualValue = safeParseFloat(cells[actualIndex + 1]);

                                const normalizedName = normalizeContestName(header);
                                if (actualValue > 0) {
                                    if (!monthContestData.has(normalizedName)) {
                                        monthContestData.set(normalizedName, new Map());
                                    }
                                    monthContestData.get(normalizedName).set(nameId, actualValue);
                                }
                            });
                        }
                    });
                    contestDataByMonth.push(monthContestData);
                }
            });

            // 1. Tổng hợp giá trị Lũy kế (Actual) theo Tên chuẩn hóa và Nhân viên
            const aggregatedContests = new Map(); // Map<NormalizedName, Map<EmployeeId, TotalActualValue>>

            contestDataByMonth.forEach(monthData => {
                monthData.forEach((employeeData, normalizedName) => {
                    if (!aggregatedContests.has(normalizedName)) {
                        // Đảm bảo tất cả nhân viên đều có key, ban đầu là 0
                        aggregatedContests.set(normalizedName, new Map(employeeIds.map(id => [id, 0])));
                    }
                    const employeeTotals = aggregatedContests.get(normalizedName);

                    employeeData.forEach((value, id) => {
                        if (employeeTotals.has(id)) {
                            employeeTotals.set(id, employeeTotals.get(id) + value);
                        }
                    });
                });
            });

            // 2. Tính % đóng góp (Contribution) cho từng Ngành hàng
            const finalContestContribution = new Map(); // Map<TargetContestHeader, Map<EmployeeId, ContributionPercent>>

            targetContestHeaders.forEach(targetHeader => {
                const normalizedTargetName = normalizeContestName(targetHeader);
                const employeeContribution = new Map();

                // Tìm dữ liệu tổng hợp bằng tên chuẩn hóa
                const contestTotals = aggregatedContests.get(normalizedTargetName);

                if (contestTotals) {
                    const grandTotalContest = Array.from(contestTotals.values()).reduce((sum, val) => sum + val, 0);

                    if (grandTotalContest > 0) {
                        employeeIds.forEach(id => {
                            const totalActual = contestTotals.get(id) || 0;
                            const percent = (totalActual / grandTotalContest) * 100;
                            employeeContribution.set(id, percent);
                        });
                    } else {
                        // Nếu có tên contest nhưng tổng Actual = 0 (trường hợp hiếm), chia đều
                        const evenPercent = 100 / employeeIds.length;
                        employeeIds.forEach(id => employeeContribution.set(id, evenPercent));
                    }
                } else {
                    // Nếu là nhóm hàng MỚI (chưa từng xuất hiện trong 3 tháng trước), CHIA ĐỀU target.
                    const evenPercent = 100 / employeeIds.length;
                    employeeIds.forEach(id => employeeContribution.set(id, evenPercent));
                }

                finalContestContribution.set(targetHeader, employeeContribution);
            });

            return finalContestContribution;
        }


        // --- TƯƠNG TÁC UI & XỬ LÝ SỰ KIỆN ---

        // NEW: Hàm tính Target dựa trên trạng thái Chia đều và Active Status
        // SỬA LỖI: Thêm tham số headers để đồng bộ danh sách ngành hàng với UI
        function calculateTargetDistribution(targets, headers = []) {
            const baseStoreTarget = safeParseFloat(document.getElementById('storeTargetInput').value);
            const revenueAdj = safeParseFloat(document.getElementById('revenueGlobalAdjust').value) || 0;
            const contestAdj = safeParseFloat(document.getElementById('contestGlobalAdjust').value) || 0;

            // --- XỬ LÝ TARGET TIME RANGE ---
            const timeMode = document.querySelector('input[name="targetTimeMode"]:checked').value;
            let timeRangeScale = 1;

            if (timeMode === 'range') {
                const rangePercent = safeParseFloat(document.getElementById('targetRangePercent').value);
                if (rangePercent > 0) {
                    timeRangeScale = rangePercent / 100;
                }
            }
            // -------------------------------

            // Target DT sau khi áp dụng % điều chỉnh global VÀ Scale theo Range
            const totalStoreTarget = baseStoreTarget * (1 + revenueAdj / 100) * timeRangeScale;

            // 1. Tính toán Total Target cho từng cột dựa trên Active status và Điều chỉnh
            const totalContestTargetsStore = {}; // Target tổng của Siêu thị cho mỗi Ngành hàng
            const data2 = document.getElementById('dataInput2').value;
            if (data2.trim()) {
                const lines2 = data2.split('\n').filter(line => line.trim());
                if (lines2.length > 1) {
                    const headers2 = lines2.shift().split('\t').map(h => h.trim());
                    const nameIndex2 = headers2.findIndex(h => h.includes('Ngành hàng'));
                    const targetIndex2 = headers2.findIndex(h => h === 'Target');
                    if (nameIndex2 !== -1 && targetIndex2 !== -1) {
                        lines2.forEach(row => {
                            const cells = row.split('\t');
                            const categoryName = (cells[nameIndex2] || '').trim();
                            if (allContestHeadersGlobal.includes(categoryName)) {
                                const baseTarget = safeParseFloat(cells[targetIndex2]);
                                // Lấy % điều chỉnh riêng cho ngành hàng này (nếu có)
                                const specificAdj = contestAdjustPercents.get(categoryName) || 0;
                                // Áp dụng cả Global Contest Adjust và Specific Adjust VÀ Scale theo Range
                                const finalTarget = baseTarget * (1 + (contestAdj + specificAdj) / 100) * timeRangeScale;
                                totalContestTargetsStore[categoryName] = finalTarget;
                            }
                        });
                    }
                }
            }

            const calculatedTargets = new Map();
            const activeEmployees = Array.from(targets.values()).filter(e => e.isActive);
            const activeCount = activeEmployees.length;

            // SỬA LỖI: Ưu tiên sử dụng headers được truyền vào (từ UI render) để đảm bảo khớp key
            let headersForCalculation = [];
            if (headers && headers.length > 0) {
                headersForCalculation = headers;
            } else {
                headersForCalculation = sortedContestHeadersGlobal.length > 0 ? sortedContestHeadersGlobal : allContestHeadersGlobal;
            }

            targets.forEach(emp => {
                if (!emp.isActive) {
                    calculatedTargets.set(emp.id, {
                        ...emp,
                        dtTarget: 0,
                        contestTargets: Object.fromEntries(headersForCalculation.map(h => [h, 0]))
                    });
                    return;
                }

                const empTargets = {
                    dtTarget: 0,
                    contestTargets: {},
                    dtPercentFinal: 0
                };

                // --- A. Target DT ---
                const dtKey = 'DT_Target';
                const isDtEqualDistribution = equalDistributionFlags.get(dtKey);
                const isDtT1Distribution = t1DistributionFlags.get(dtKey);

                if (isDtEqualDistribution) {
                    empTargets.dtTarget = totalStoreTarget / activeCount;
                    empTargets.dtPercentFinal = 100 / activeCount;
                } else if (isDtT1Distribution) {
                    // NEW: Distribute according to T-1 Revenue Weight (dtPercent3T)
                    // Note: We need to normalize percentages of ACTIVE employees to sum to 100%
                    const t1PercentRaw = emp.dtPercent3T;

                    // Get sum of T-1 percent of all ACTIVE employees
                    // This is needed because if some employees are inactive, the total T-1 % of active ones < 100%
                    const totalActiveT1Percent = activeEmployees.reduce((sum, e) => sum + e.dtPercent3T, 0);

                    let normalizedPercent = 0;
                    if (totalActiveT1Percent > 0) {
                        normalizedPercent = (t1PercentRaw / totalActiveT1Percent) * 100;
                    }

                    empTargets.dtPercentFinal = normalizedPercent;
                    empTargets.dtTarget = totalStoreTarget * (normalizedPercent / 100);
                    // Also update the 'manual' percent so input reflects this value
                    emp.manualDtPercent = normalizedPercent;

                } else {
                    const manualPercent = emp.manualDtPercent;
                    empTargets.dtPercentFinal = manualPercent;
                    empTargets.dtTarget = totalStoreTarget * (manualPercent / 100);
                }

                // --- B. Target TĐ (Contests) ---
                headersForCalculation.forEach(h => {
                    const contestKey = `${h}_TargetTD`;
                    const isContestEqualDistribution = equalDistributionFlags.get(contestKey);
                    const isContestT1Distribution = t1DistributionFlags.get(contestKey);
                    const totalTarget = totalContestTargetsStore[h] || 0;

                    if (totalTarget > 0) {
                        const contestManualPercent = emp.manualContestPercent?.[h] || (emp.contest3MonthContribution.get(h) || 0);

                        if (isContestEqualDistribution) {
                            empTargets.contestTargets[h] = totalTarget / activeCount;
                            emp.manualContestPercent[h] = 100 / activeCount;
                        } else if (isContestT1Distribution) {
                            // NEW: Use T-1 Revenue Weight
                            const t1PercentRaw = emp.dtPercent3T;
                            const totalActiveT1Percent = activeEmployees.reduce((sum, e) => sum + e.dtPercent3T, 0);
                            let normalizedPercent = 0;
                            if (totalActiveT1Percent > 0) {
                                normalizedPercent = (t1PercentRaw / totalActiveT1Percent) * 100;
                            }

                            empTargets.contestTargets[h] = totalTarget * (normalizedPercent / 100);
                            emp.manualContestPercent[h] = normalizedPercent;

                        } else {
                            empTargets.contestTargets[h] = totalTarget * (contestManualPercent / 100);
                        }
                    } else {
                        empTargets.contestTargets[h] = 0;
                    }
                });

                calculatedTargets.set(emp.id, {
                    ...emp,
                    dtTarget: empTargets.dtTarget,
                    manualDtPercent: empTargets.dtPercentFinal,
                    contestTargets: empTargets.contestTargets,
                    manualContestPercent: emp.manualContestPercent
                });
            });

            return calculatedTargets;
        }

        // NEW: Hàm wrapper để lấy giá trị cũ và gọi updateFinalTarget
        function handleTargetPercentChange(inputElement, employeeId, targetType, contestName = null) {
            const newValue = safeParseFloat(inputElement.value);
            const oldValue = safeParseFloat(inputElement.dataset.oldValue);

            // Update the input's old value immediately
            inputElement.dataset.oldValue = newValue.toFixed(2);

            updateFinalTarget(employeeId, targetType, newValue, oldValue, contestName);
        }

        // NEW: Hàm cập nhật Target cuối cùng (có chỉnh sửa thủ công) VÀ CHIA ĐỀU CHO CÁC NHÂN VIÊN CÒN LẠI
        function updateFinalTarget(employeeId, targetType, newValue, oldValue, contestName = null) {
            let currentTarget = finalEmployeeTargets.get(employeeId);

            // Chỉ xử lý nếu có target và nhân viên đang Active
            if (!currentTarget || !currentTarget.isActive) {
                showToast("Lỗi: Không tìm thấy target hoặc nhân viên không Active.");
                renderTargetAllocationReport(finalEmployeeTargets, allContestHeadersGlobal);
                return;
            }

            // Đảm bảo giá trị nằm trong khoảng [0, 100]
            const numericValue = Math.max(0, Math.min(100, newValue));
            const difference = numericValue - oldValue;

            // Xác định Key cho cờ Chia đều
            const targetKey = (targetType === 'dtPercent') ? 'DT_Target' : `${contestName}_TargetTD`;

            // Nếu nhân viên này đang được Chia đều hoặc Theo T-1, không cho chỉnh sửa (UI đã disabled, nhưng phòng trường hợp gọi hàm trực tiếp)
            if (equalDistributionFlags.get(targetKey) || t1DistributionFlags.get(targetKey)) {
                showToast("Lỗi: Không thể chỉnh sửa khi chế độ 'Chia đều' hoặc 'Theo T-1' đang BẬT.");
                // Đặt lại giá trị cũ trong input (sẽ được cập nhật khi render lại)
                if (targetType === 'dtPercent') {
                    currentTarget.manualDtPercent = oldValue;
                } else if (targetType === 'contestPercent' && contestName) {
                    currentTarget.manualContestPercent[contestName] = oldValue;
                }
                finalEmployeeTargets.set(employeeId, currentTarget);
                renderTargetAllocationReport(finalEmployeeTargets, allContestHeadersGlobal);
                return;
            }

            // 1. Cập nhật % mới cho nhân viên đang chỉnh sửa
            if (targetType === 'dtPercent') {
                currentTarget.manualDtPercent = numericValue;
            } else if (targetType === 'contestPercent' && contestName) {
                if (!currentTarget.manualContestPercent) currentTarget.manualContestPercent = {};
                currentTarget.manualContestPercent[contestName] = numericValue;
            }

            // 2. Phân bổ lại sự khác biệt cho các nhân viên khác (trừ chính nó)
            const sharers = Array.from(finalEmployeeTargets.values()).filter(emp =>
                emp.id !== employeeId && // Không phải nhân viên đang chỉnh sửa
                emp.isActive && // Nhân viên phải Active
                !equalDistributionFlags.get(targetKey) // Quan trọng: Phải là nhân viên KHÔNG đang ở chế độ Chia đều
            );

            const sharerCount = sharers.length;

            if (sharerCount > 0) {
                // Sự khác biệt cần được phân bổ (âm khi tăng, dương khi giảm)
                const changePerSharer = -difference / sharerCount;

                sharers.forEach(sharer => {
                    let currentPercent;
                    if (targetType === 'dtPercent') {
                        currentPercent = sharer.manualDtPercent;
                        // Áp dụng sự thay đổi và đảm bảo không âm
                        sharer.manualDtPercent = Math.max(0, currentPercent + changePerSharer);
                    } else if (targetType === 'contestPercent' && contestName) {
                        if (!sharer.manualContestPercent) sharer.manualContestPercent = {};
                        currentPercent = sharer.manualContestPercent[contestName] || 0;
                        sharer.manualContestPercent[contestName] = Math.max(0, currentPercent + changePerSharer);
                    }
                    finalEmployeeTargets.set(sharer.id, sharer);
                });
                showToast("Đã chia đều sự thay đổi % cho các nhân viên còn lại.");
            } else if (sharerCount === 0 && difference !== 0) {
                // Không có nhân viên nào để chia đều (Tự đứng ngoài chế độ Chia đều)
                showToast(`Cảnh báo: Không có nhân viên nào để chia đều sự thay đổi. Tổng % có thể không còn 100%.`);
            }

            // 3. Chuẩn hóa lại tổng (rất quan trọng sau khi chia đều)
            let totalRecalculated = 0;
            sharers.forEach(sharer => {
                if (targetType === 'dtPercent') {
                    totalRecalculated += sharer.manualDtPercent;
                } else if (targetType === 'contestPercent' && contestName) {
                    totalRecalculated += sharer.manualContestPercent[contestName];
                }
            });
            totalRecalculated += numericValue; // Thêm lại giá trị mới của người chỉnh sửa

            // Chỉ chuẩn hóa nếu tổng vượt quá 100.01% hoặc dưới 99.99%
            if (Math.abs(totalRecalculated - 100) > 0.01) {
                const correctionFactor = 100 / totalRecalculated;
                const allActiveSharersAndEditor = Array.from(finalEmployeeTargets.values()).filter(emp =>
                    emp.isActive && !equalDistributionFlags.get(targetKey) && !t1DistributionFlags.get(targetKey)
                );

                allActiveSharersAndEditor.forEach(emp => {
                    if (targetType === 'dtPercent') {
                        emp.manualDtPercent *= correctionFactor;
                    } else if (type === 'contestPercent' && contestName) {
                        emp.manualContestPercent[contestName] *= correctionFactor;
                    }
                    finalEmployeeTargets.set(emp.id, emp);
                });
            }


            // 4. Lưu và render lại
            localStorage.setItem('finalEmployeeTargets', JSON.stringify(Object.fromEntries(finalEmployeeTargets)));

            // Re-render table to immediately show the recalculated target value
            // Bắt buộc gọi lại processData để đảm bảo tính toán lại Target Tuyệt đối (Value) và hiển thị
            processData(true, true);
        }

        // NEW: Toggle active status for an employee
        function toggleEmployeeActive(employeeId, checked) {
            let currentTarget = finalEmployeeTargets.get(employeeId);
            if (currentTarget) {
                currentTarget.isActive = checked;
                finalEmployeeTargets.set(employeeId, currentTarget);
                localStorage.setItem('finalEmployeeTargets', JSON.stringify(Object.fromEntries(finalEmployeeTargets)));

                // Re-render the table to reflect the change in active count for Equal Distribution calculation
                showToast(`Đã ${checked ? 'chọn' : 'bỏ chọn'} ${currentTarget.name}. Cập nhật phân bổ...`);
                // SỬA LỖI: Dùng allContestHeadersGlobal để hiển thị vì target allocation report chỉ hiển thị sơ bộ
                renderTargetAllocationReport(finalEmployeeTargets, allContestHeadersGlobal);
            }
            renderTargetAllocationReport(finalEmployeeTargets, allContestHeadersGlobal);
        }


        // NEW: Toggle ALL T-1 Distribution
        function toggleAllT1Distribution(checked) {
            // Updated all keys to T1
            const allKeys = ['DT_Target', ...allContestHeadersGlobal.map(h => `${h}_TargetTD`)];

            allKeys.forEach(key => {
                t1DistributionFlags.set(key, checked);
                if (checked) {
                    equalDistributionFlags.set(key, false);
                }
            });

            // Save state
            localStorage.setItem('equalDistributionFlags', JSON.stringify(Object.fromEntries(equalDistributionFlags)));
            localStorage.setItem('t1DistributionFlags', JSON.stringify(Object.fromEntries(t1DistributionFlags)));

            showToast(`Đã ${checked ? 'bật' : 'tắt'} chế độ Theo T-1 cho TOÀN BỘ bảng target.`);
            // Uncheck Global Equal if it exists
            const globalEqual = document.getElementById('global_equal_dist');
            if (globalEqual && checked) globalEqual.checked = false;

            renderTargetAllocationReport(finalEmployeeTargets, allContestHeadersGlobal);
        }

        // NEW: Toggle ALL Equal Distribution
        function toggleAllEqualDistribution(checked) {
            const allKeys = ['DT_Target', ...allContestHeadersGlobal.map(h => `${h}_TargetTD`)];

            allKeys.forEach(key => {
                equalDistributionFlags.set(key, checked);
                if (checked) {
                    t1DistributionFlags.set(key, false);
                }
            });

            // Save state
            localStorage.setItem('equalDistributionFlags', JSON.stringify(Object.fromEntries(equalDistributionFlags)));
            localStorage.setItem('t1DistributionFlags', JSON.stringify(Object.fromEntries(t1DistributionFlags)));

            showToast(`Đã ${checked ? 'bật' : 'tắt'} chế độ Chia đều cho TOÀN BỘ bảng target.`);

            // Uncheck Global T-1 if it exists
            const globalT1 = document.getElementById('global_t1_dist');
            if (globalT1 && checked) globalT1.checked = false;

            renderTargetAllocationReport(finalEmployeeTargets, allContestHeadersGlobal);
        }

        // NEW: Toggle all employee active status
        function toggleAllEmployeesTarget(checked) {
            Array.from(finalEmployeeTargets.keys()).forEach(id => {
                let currentTarget = finalEmployeeTargets.get(id);
                if (currentTarget) {
                    currentTarget.isActive = checked;
                    finalEmployeeTargets.set(id, currentTarget);
                }
            });
            localStorage.setItem('finalEmployeeTargets', JSON.stringify(Object.fromEntries(finalEmployeeTargets)));
            showToast(`Đã ${checked ? 'chọn' : 'bỏ chọn'} tất cả nhân viên. Cập nhật phân bổ...`);
            // SỬA LỖI: Dùng allContestHeadersGlobal để hiển thị vì target allocation report chỉ hiển thị sơ bộ
            renderTargetAllocationReport(finalEmployeeTargets, allContestHeadersGlobal);
        }


        // NEW: Toggle Equal Distribution flag
        function toggleEqualDistribution(key, checked) {
            equalDistributionFlags.set(key, checked);
            if (checked) {
                // Tắt chế độ 'Theo T-1' nếu bật 'Chia đều'
                t1DistributionFlags.set(key, false);
            }

            // Lưu trạng thái cờ phân bổ (tùy chọn)
            localStorage.setItem('equalDistributionFlags', JSON.stringify(Object.fromEntries(equalDistributionFlags)));

            showToast(`Đã ${checked ? 'bật' : 'tắt'} chế độ Chia đều cho cột ${key.split('_')[0]}. Cập nhật phân bổ...`);
            // Re-render to show the calculated distribution and disable/enable input fields
            // SỬA LỖI: Dùng allContestHeadersGlobal để hiển thị vì target allocation report chỉ hiển thị sơ bộ
            renderTargetAllocationReport(finalEmployeeTargets, allContestHeadersGlobal);
        }

        // NEW: Toggle T-1 Distribution flag
        function toggleT1Distribution(key, checked) {
            t1DistributionFlags.set(key, checked);
            if (checked) {
                // Tắt chế độ 'Chia đều' nếu bật 'Theo T-1'
                equalDistributionFlags.set(key, false);
            }
            // Save state
            localStorage.setItem('equalDistributionFlags', JSON.stringify(Object.fromEntries(equalDistributionFlags)));
            localStorage.setItem('t1DistributionFlags', JSON.stringify(Object.fromEntries(t1DistributionFlags)));

            showToast(`Đã ${checked ? 'bật' : 'tắt'} chế độ Theo T-1 cho cột ${key.split('_')[0]}. Cập nhật phân bổ...`);
            renderTargetAllocationReport(finalEmployeeTargets, allContestHeadersGlobal);
        }


        function exportAllData() {
            const allInputData = {};
            const allInputIds = ['dataInput2', 'dataInput6', 'dataInput7', 'storeTargetInput', 'targetRangeStart', 'targetRangeEnd', 'targetRangePercent'];
            historyDataInputs.forEach(h => {
                allInputIds.push(h.idDT);
            });

            allInputIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) allInputData[id] = el.value;
            });

            // LƯU TRẠNG THÁI TARGET CUỐI CÙNG (CÓ CHỈNH SỬA) VÀ CỜ
            const finalTargets = Object.fromEntries(finalEmployeeTargets);
            const distributionFlags = Object.fromEntries(equalDistributionFlags);

            const allData = {
                ...allInputData,
                finalEmployeeTargets: finalTargets,
                equalDistributionFlags: distributionFlags, // LƯU CỜ CHIA ĐỀU
                t1DistributionFlags: Object.fromEntries(t1DistributionFlags) // LƯU CỜ T-1
            };

            const jsonString = JSON.stringify(allData, null, 2);
            document.getElementById('allDataImportExportData').value = jsonString;

            try {
                document.getElementById('allDataImportExportData').select();
                document.getElementById('allDataImportExportData').setSelectionRange(0, 99999);
                document.execCommand('copy');
                window.getSelection().removeAllRanges();
                showToast('Đã sao chép toàn bộ dữ liệu vào clipboard!');
            } catch (err) {
                showToast('Không thể sao chép tự động. Vui lòng copy thủ công.');
            }
        }

        // NEW: Hàm Import All Data
        function importAllData() {
            const jsonString = document.getElementById('allDataImportExportData').value;
            try {
                const importedData = JSON.parse(jsonString);

                // 1. Restore main inputs and history inputs
                const allInputIds = ['dataInput2', 'dataInput6', 'dataInput7', 'storeTargetInput', 'targetRangeStart', 'targetRangeEnd', 'targetRangePercent'];
                historyDataInputs.forEach(h => {
                    allInputIds.push(h.idDT);
                });

                allInputIds.forEach(id => {
                    document.getElementById(id).value = importedData[id] || '';
                });

                // 2. Restore Final Employee Targets (CÓ CHỈNH SỬA)
                if (importedData.finalEmployeeTargets && typeof importedData.finalEmployeeTargets === 'object') {
                    finalEmployeeTargets = new Map(Object.entries(importedData.finalEmployeeTargets));
                } else {
                    finalEmployeeTargets = new Map();
                }

                // 3. Restore Equal Distribution Flags
                if (importedData.equalDistributionFlags && typeof importedData.equalDistributionFlags === 'object') {
                    equalDistributionFlags = new Map(Object.entries(importedData.equalDistributionFlags));
                } else {
                    equalDistributionFlags = new Map();
                }

                // 3b. Restore T-1 Flags
                if (importedData.t1DistributionFlags && typeof importedData.t1DistributionFlags === 'object') {
                    t1DistributionFlags = new Map(Object.entries(importedData.t1DistributionFlags));
                } else {
                    t1DistributionFlags = new Map();
                }

                // 4. Render lại
                extractEmployeesFromInputs();
                processData(true, true);

                showToast('Đã khôi phục toàn bộ dữ liệu thành công! Vui lòng nhấn "Tạo Báo Cáo Phân Tích".');

            } catch (e) {
                showToast(`Lỗi nhập dữ liệu: ${e.message}`);
                console.error("Import error:", e);
            }
        }

        // NEW: Import/Export Target Allocation (File JSON)
        function exportTargetAllocation() {
            const dataToExport = {
                finalEmployeeTargets: Object.fromEntries(finalEmployeeTargets),
                equalDistributionFlags: Object.fromEntries(equalDistributionFlags),
                t1DistributionFlags: Object.fromEntries(t1DistributionFlags)
            };
            const jsonString = JSON.stringify(dataToExport, null, 2);

            // Use Blob to create a downloadable file
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Target_Allocation_Backup.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast('Đã xuất Target đã phân bổ ra file JSON!');
        }

        function handleTargetAllocationFileImport(event) {
            const file = event.target.files[0];
            if (!file) {
                showToast("Vui lòng chọn file JSON hợp lệ.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                const jsonString = e.target.result;
                try {
                    const importedData = JSON.parse(jsonString);

                    if (!importedData.finalEmployeeTargets || !importedData.equalDistributionFlags) {
                        throw new Error("Dữ liệu không hợp lệ. Thiếu cấu trúc 'finalEmployeeTargets' hoặc 'equalDistributionFlags'.");
                    }

                    // 1. Restore Final Employee Targets (CÓ CHỈNH SỬA)
                    finalEmployeeTargets = new Map(Object.entries(importedData.finalEmployeeTargets));

                    // 2. Restore Equal Distribution Flags
                    equalDistributionFlags = new Map(Object.entries(importedData.equalDistributionFlags));

                    if (importedData.t1DistributionFlags) {
                        t1DistributionFlags = new Map(Object.entries(importedData.t1DistributionFlags));
                    }

                    // 3. Render lại
                    // Cần đảm bảo inputs (Bảng 6, 7, Target Siêu thị) đã được dán trước khi Import Targets
                    extractEmployeesFromInputs();
                    processData(true, true);

                    showToast('Đã khôi phục Targets và cờ "Chia đều" từ file JSON thành công!');

                } catch (e) {
                    showToast(`Lỗi nhập dữ liệu Target: ${e.message}`);
                    console.error("Target Import error:", e);
                } finally {
                    // Clear the file input value to allow the same file to be selected again
                    event.target.value = '';
                }
            };
            reader.onerror = function () {
                showToast("Lỗi khi đọc file.");
            };
            reader.readAsText(file);
        }


        function showInputCard() {
            document.getElementById('results-wrapper').style.display = 'none';
            document.getElementById('stram-analysis-card').style.display = 'none';
            document.getElementById('report-header').style.display = 'none';
            document.getElementById('comments-card').style.display = 'none';
            document.getElementById('kpi-cards-section').style.display = 'none';
            document.getElementById('data-input-card').style.display = 'block';

            // CẬP NHẬT: Hiển thị bảng Target ngay trong phần input
            document.getElementById('target-allocation-report-card').style.display = 'block';
        }

        async function handlePaste(event) {
            if (!event.target.classList.contains('btn-paste')) return;
            const targetId = event.target.dataset.target;
            const filterType = event.target.dataset.filter;
            const textarea = document.getElementById(targetId);
            if (!textarea) return;

            try {
                const text = await navigator.clipboard.readText();
                // Logic lọc dữ liệu cũ (giữ nguyên)
                const markers = {
                    table2: /^Ngành hàng\s+DTQĐ\s+Target/,
                    table6: /^Nhân viên\s+DTLK\s+DTQĐ/,
                    table7: /^Phòng ban/
                };
                const endMarker = "Hỗ trợ BI";
                const lines = text.split('\n');
                const startIndex = lines.findIndex(line => markers[filterType] && markers[filterType].test(line.trim()));

                if (startIndex !== -1) {
                    let endIndex = lines.findIndex(line => line.includes(endMarker), startIndex);
                    if (endIndex === -1) endIndex = lines.length;
                    textarea.value = lines.slice(startIndex, endIndex).join('\n').trim();
                } else {
                    textarea.value = text;
                }

                showToast(`Đã dán dữ liệu vào ${targetId}! Đang xử lý...`);

                // --- KÍCH HOẠT XỬ LÝ NGAY LẬP TỨC ---
                setTimeout(() => {
                    extractEmployeesFromInputs();
                }, 300); // Đợi 300ms để DOM cập nhật giá trị rồi mới chạy

            } catch (err) {
                console.error(err);
                showToast('Lỗi khi dán: ' + err.message);
            }
        }
        // NEW: Hàm chụp ảnh và tải về
        function captureAndDownload(element, filename) {
            const commentsCard = document.getElementById('comments-card');
            const originalDisplay = commentsCard ? commentsCard.style.display : 'none';

            if (commentsCard) commentsCard.style.display = 'none';

            const reportTitleEl = document.getElementById('reportTitle');
            if (reportTitleEl) reportTitleEl.style.display = 'block';

            html2canvas(element, {
                useCORS: true,
                scale: 3, // Increased scale for HD
                backgroundColor: '#ffffff', // Force white background for reliability
                logging: false,
                allowTaint: true,
                scrollY: -window.scrollY,
                onclone: (clonedDoc) => {
                    // Fix rendering issues in the cloned document
                    const cards = clonedDoc.querySelectorAll('.perf-card');
                    cards.forEach(card => {
                        card.style.boxShadow = 'none'; // Remove shadow to prevent artifacts
                        card.style.backdropFilter = 'none'; // Remove unsupported filter
                        card.style.webkitBackdropFilter = 'none';
                        card.style.background = '#ffffff'; // Ensure clean white background
                        card.style.transform = 'none'; // Prevent transformation glitches
                        card.style.border = '1px solid #dcdcdc'; // Clean border
                    });

                    // Fix badges and table cells
                    const badges = clonedDoc.querySelectorAll('.percent-badge');
                    badges.forEach(badge => {
                        badge.style.boxShadow = 'none';
                    });

                    // Remove shadows from progress bars for cleaner look
                    const progressBars = clonedDoc.querySelectorAll('.progress-bar-fill');
                    progressBars.forEach(bar => {
                        bar.style.boxShadow = 'none';
                    });

                    // FIX: Clean up KPI stat boxes specifically
                    const statBoxes = clonedDoc.querySelectorAll('.progress-bar-group > div');
                    statBoxes.forEach(box => {
                        box.style.boxShadow = 'none';
                        box.style.backgroundImage = 'none'; // Remove gradient to prevent banding
                    });

                    const statValues = clonedDoc.querySelectorAll('.progress-bar-group .value');
                    statValues.forEach(val => {
                        val.style.textShadow = 'none';
                    });
                }
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = filename;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(err => {
                showToast("Lỗi khi chụp ảnh màn hình.");
                console.error(err);
            }).finally(() => {
                if (reportTitleEl) reportTitleEl.style.display = 'none';
                if (commentsCard) commentsCard.style.display = originalDisplay;
            });
        }

        // NEW: Hàm chụp ảnh và copy vào clipboard
        function captureAndCopyToClipboard(element) {
            // Kiểm tra xem trình duyệt có hỗ trợ API Clipboard.write() không
            if (!navigator.clipboard || !navigator.clipboard.write) {
                showToast("Trình duyệt không hỗ trợ sao chép ảnh vào clipboard.");
                return;
            }

            const commentsCard = document.getElementById('comments-card');
            const originalDisplay = commentsCard ? commentsCard.style.display : 'none';
            if (commentsCard) commentsCard.style.display = 'none';

            const reportTitleEl = document.getElementById('reportTitle');
            if (reportTitleEl) reportTitleEl.style.display = 'block';

            let scaleFactor = 1;

            html2canvas(element, {
                useCORS: true,
                scale: 3, // HD
                backgroundColor: '#ffffff', // Solid white
                logging: false,
                allowTaint: true,
                scrollY: -window.scrollY,
                onclone: (clonedDoc) => {
                    // Fix rendering issues in the cloned document
                    const cards = clonedDoc.querySelectorAll('.perf-card');
                    cards.forEach(card => {
                        card.style.boxShadow = 'none';
                        card.style.backdropFilter = 'none';
                        card.style.webkitBackdropFilter = 'none';
                        card.style.background = '#ffffff';
                        card.style.transform = 'none';
                        card.style.border = '1px solid #dcdcdc';
                    });

                    const badges = clonedDoc.querySelectorAll('.percent-badge');
                    badges.forEach(badge => {
                        badge.style.boxShadow = 'none';
                    });

                    const progressBars = clonedDoc.querySelectorAll('.progress-bar-fill');
                    progressBars.forEach(bar => {
                        bar.style.boxShadow = 'none';
                    });

                    // FIX: Clean up KPI stat boxes specifically
                    const statBoxes = clonedDoc.querySelectorAll('.progress-bar-group > div');
                    statBoxes.forEach(box => {
                        box.style.boxShadow = 'none';
                        box.style.backgroundImage = 'none'; // Remove gradient to prevent banding
                    });

                    const statValues = clonedDoc.querySelectorAll('.progress-bar-group .value');
                    statValues.forEach(val => {
                        val.style.textShadow = 'none';
                    });
                }
            }).then(canvas => {
                // Chuyển canvas sang Blob
                canvas.toBlob(async (blob) => {
                    try {
                        // Sử dụng Clipboard API để ghi Blob (ảnh) vào clipboard
                        await navigator.clipboard.write([
                            new ClipboardItem({ 'image/png': blob })
                        ]);
                        showToast("Đã sao chép ảnh vào clipboard!");
                    } catch (err) {
                        console.error("Lỗi khi sao chép ảnh vào clipboard:", err);
                        showToast("Lỗi: Không thể sao chép ảnh. Vui lòng thử Chụp Ảnh (Tải xuống).");
                    }
                }, 'image/png');
            }).catch(err => {
                showToast("Lỗi khi xử lý hình ảnh.");
                console.error(err);
            }).finally(() => {
                if (reportTitleEl) reportTitleEl.style.display = 'none';
                if (commentsCard) commentsCard.style.display = originalDisplay;
            });
        }


        // --- HÀM CHỤP ẢNH TOÀN BẢNG ---
        function captureFullTable() {
            const container = document.getElementById('comprehensiveLeaderboardContainer');
            if (!container || !container.closest('.card')) {
                showToast("Lỗi: Không tìm thấy container bảng xếp hạng hoặc phần tử cha.");
                return;
            }
            const cardElement = container.closest('.card');
            const originalStyles = {
                containerOverflowX: container.style.overflowX,
                containerMaxHeight: container.style.maxHeight,
                cardWidth: cardElement.style.width,
                cardMaxWidth: cardElement.style.maxWidth,
                bodyOverflow: document.body.style.overflow
            };

            container.style.overflowX = 'visible';
            container.style.maxHeight = 'none';
            cardElement.style.width = 'fit-content';
            cardElement.style.maxWidth = 'none';
            document.body.style.overflow = 'hidden';

            showToast('Đang xử lý ảnh toàn bảng (bao gồm phần bị che)...');

            setTimeout(() => {
                html2canvas(cardElement, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    width: cardElement.scrollWidth + 20,
                    height: cardElement.scrollHeight,
                    windowWidth: cardElement.scrollWidth + 50,
                    x: 0,
                    y: 0
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'BangTongHop_Full.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    showToast("Đã chụp ảnh thành công!");
                }).catch(err => {
                    showToast("Lỗi khi chụp ảnh màn hình. (Chi tiết: " + err.message + ")");
                    console.error("Lỗi html2canvas:", err);
                }).finally(() => {
                    container.style.overflowX = originalStyles.containerOverflowX;
                    container.style.maxHeight = originalStyles.containerMaxHeight;
                    cardElement.style.width = originalStyles.cardWidth;
                    cardElement.style.maxWidth = originalStyles.cardMaxWidth;
                    document.body.style.overflow = originalStyles.bodyOverflow;
                });
            }, 500);
        }

        function captureAllIndividualCards() {
            const cards = document.querySelectorAll('#allCardsContainer .perf-card');
            if (cards.length === 0) return showToast("Không có thẻ KPI nào để chụp.");

            showToast(`Bắt đầu chụp ${cards.length} thẻ KPI...`);
            cards.forEach((card, index) => {
                const employeeName = card.querySelector('.name-block h2').textContent.trim();
                setTimeout(() => {
                    captureAndDownload(card, `KPI-${employeeName}.png`);
                }, index * 1000);
            });
        }

        function copyComments() {
            const textarea = document.getElementById('comments-textarea');
            textarea.select();
            textarea.setSelectionRange(0, 99999);
            try {
                document.execCommand('copy');
                showToast('Đã sao chép nhận xét!');
            } catch (err) {
                showToast('Lỗi khi sao chép.');
            }
            window.getSelection().removeAllRanges();
        }

        // --- NEW: CHỨC NĂNG NHẬP/XUẤT NGÀNH HÀNG ---
        function exportContestSelection() {
            const checkboxes = document.querySelectorAll('#contest-list input[type="checkbox"]');
            const contestsToExport = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);

            // Nếu "Chọn tất cả" đang được tích, ta phải kiểm tra xem có checkbox ngành hàng nào được render không
            const isSelectAllChecked = document.getElementById('modalSelectAllContests')?.checked;

            let dataToExport = [];

            if (isSelectAllChecked || contestsToExport.length === allContestHeadersGlobal.length) {
                // Nếu chọn tất cả đang được tích (hoặc tất cả đều đã được chọn), xuất toàn bộ danh sách global
                dataToExport = allContestHeadersGlobal;
            } else {
                // Nếu chỉ chọn một vài mục, xuất các mục đã chọn trong DOM
                dataToExport = contestsToExport;
            }

            const data = JSON.stringify(dataToExport);
            const textarea = document.getElementById('contestImportExportData');
            textarea.value = data;

            try {
                textarea.select();
                textarea.setSelectionRange(0, 99999);
                document.execCommand('copy');
                window.getSelection().removeAllRanges();
                showToast(`Đã sao chép ${dataToExport.length} ngành hàng (JSON).`);
            } catch (err) {
                showToast('Không thể sao chép tự động. Vui lòng copy thủ công.');
            }
        }

        function importContestSelection() {
            const text = document.getElementById('contestImportExportData').value;
            try {
                const importedList = JSON.parse(text);
                if (!Array.isArray(importedList) || importedList.some(item => typeof item !== 'string')) {
                    throw new Error("Dữ liệu không hợp lệ. Phải là một mảng chuỗi (JSON Array of strings).");
                }

                const validContests = importedList.filter(c => allContestHeadersGlobal.includes(c));
                if (validContests.length === 0 && allContestHeadersGlobal.length > 0) {
                    showToast("Không có ngành hàng hợp lệ nào được nhập. Đã hủy thao tác.");
                    return;
                }

                // Nếu có ngành hàng hợp lệ, dùng danh sách đó. Nếu không (nhưng allContestHeadersGlobal có), dùng tất cả.
                selectedContestHeaders = validContests.length > 0 ? validContests : [...allContestHeadersGlobal];
                // FIX LỖI: Sử dụng biến toàn cục 'selectedContestHeaders'
                localStorage.setItem('selectedContestHeaders', JSON.stringify(selectedContestHeaders));

                renderContestListInModal(); // Cập nhật lại list checkbox
                updateModalSelectAll(); // Cập nhật lại checkbox "Chọn tất cả"

                showToast(`Đã nhập thành công ${selectedContestHeaders.length} ngành hàng hợp lệ! Vui lòng nhấn 'Áp dụng Bộ lọc'.`);

            } catch (e) {
                showToast(`Lỗi nhập dữ liệu: ${e.message}`);
                console.error("Import error:", e);
            }
        }

        // NEW FUNCTION: Toggle checkbox when clicking anywhere in the contest-item row
        function toggleCheckboxInModal(event, checkboxId) {
            // Đảm bảo event.stopPropagation() được gọi để ngăn chặn đóng modal không mong muốn
            event.stopPropagation();
            const checkbox = document.getElementById(checkboxId);
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                updateModalSelectAll(); // Cập nhật trạng thái "Chọn tất cả"
            }
        }

        // Hàm render lại list checkbox trong modal (để gọi sau khi import)
        function renderContestListInModal() {
            const listContainer = document.getElementById('contest-list');
            listContainer.innerHTML = '';

            // Cập nhật trạng thái checkbox "Chọn tất cả" trong modal
            updateModalSelectAll();

            // Cập nhật lại list các checkbox ngành hàng
            allContestHeadersGlobal.forEach(contest => {
                const isChecked = selectedContestHeaders.includes(contest);
                const itemId = `check-${contest.replace(/[^a-zA-Z0-9]/g, '-')}`;
                const itemHtml = `
                <div class="contest-item" onclick="toggleCheckboxInModal(event, '${itemId}')">
                    <input type="checkbox" id="${itemId}" value="${contest}" ${isChecked ? 'checked' : ''}>
                    <label for="${itemId}">${contest}</label>
                </div>
            `;
                listContainer.innerHTML += itemHtml;
            });
        }

        function showContestSelectionModal() {
            if (allContestHeadersGlobal.length === 0) {
                showToast("Vui lòng dán đủ dữ liệu đầu vào và chạy 'Tạo Báo Cáo' trước.");
                return;
            }

            renderContestListInModal(); // Gọi hàm render list mới

            // Tắt Checkbox "Hiển thị TẤT CẢ" bên ngoài khi mở modal
            document.getElementById('allContestsCheckbox').checked = false;
            localStorage.setItem('allContestsCheckbox', false);

            document.getElementById('contest-selection-modal').style.display = 'block';
        }

        function toggleAllModalContests(select) {
            // HÀM SỬA LỖI: Cập nhật selectedContestHeaders ngay lập tức
            const checkboxes = document.querySelectorAll('#contest-list input[type="checkbox"]');

            if (select) {
                // Nếu chọn tất cả, gán selectedContestHeaders = allContestHeadersGlobal
                selectedContestHeaders = [...allContestHeadersGlobal];
            } else {
                // Nếu bỏ chọn tất cả, gán selectedContestHeaders = []
                selectedContestHeaders = [];
            }

            checkboxes.forEach(cb => cb.checked = select);
            // FIX LỖI: Sử dụng biến toàn cục 'selectedContestHeaders'
            localStorage.setItem('selectedContestHeaders', JSON.stringify(selectedContestHeaders));
        }

        function updateModalSelectAll() {
            // HÀM SỬA LỖI: Kiểm tra trạng thái của selectedContestHeaders và allContestHeadersGlobal
            const allCheckboxes = document.querySelectorAll('#contest-list input[type="checkbox"]');
            const modalSelectAll = document.getElementById('modalSelectAllContests');

            const checkedCount = Array.from(allCheckboxes).filter(cb => cb.checked).length;

            // Đồng bộ trạng thái checkbox "Chọn tất cả"
            if (modalSelectAll) {
                modalSelectAll.checked = checkedCount === allCheckboxes.length && allCheckboxes.length > 0;
            }
        }

        function applyContestSelection() {
            const checkboxes = document.querySelectorAll('#contest-list input[type="checkbox"]');
            const newSelectedContests = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);

            if (newSelectedContests.length === 0) {
                showToast("Vui lòng chọn ít nhất một ngành hàng.");
                return;
            }

            selectedContestHeaders = newSelectedContests;
            localStorage.setItem('selectedContestHeaders', JSON.stringify(selectedContestHeaders));
            document.getElementById('contest-selection-modal').style.display = 'none';

            updateContestStatusUI();

            // **SỬA LỖI 1:** Đảm bảo gọi processData(false, false) để re-render báo cáo sau khi áp dụng bộ lọc.
            const hasInputData = document.getElementById('dataInput7').value.trim() !== '' &&
                document.getElementById('dataInput6').value.trim() !== '' &&
                document.getElementById('dataInput2').value.trim() !== '';

            if (finalData.length > 0 || hasInputData) {
                showToast('Đã lưu lựa chọn. Đang cập nhật lại báo cáo...');
                processData(false, false);
            } else {
                showToast('Đã lưu lựa chọn ngành hàng. Vui lòng dán đủ dữ liệu và nhấn "Tạo Báo Cáo Phân Tích".');
            }
        }

        // --- NEW: CHỨC NĂNG LỊCH SỬ VÀ SO SÁNH ---

        // Thêm hàm mới để ẩn/hiện so sánh
        function toggleComparisonDisplay() {
            const toggleBtn = document.getElementById('toggleComparisonBtn');

            if (comparisonResultsCache) {
                // Nếu đang hiện, thì ẩn đi
                comparisonResultsCache = null;
                toggleBtn.textContent = 'Hiện So sánh';
                toggleBtn.style.backgroundColor = 'var(--primary-accent)';
                showToast('Đã ẩn chế độ so sánh.');
                renderAllEmployeeCards(finalData); // Re-render cards without comparison
                renderComprehensiveDashboard(finalData, sortedContestHeadersGlobal, {}); // Re-render comprehensive table without comparison
            } else {
                // Nếu đang ẩn, thì chạy so sánh lại với ngày đã chọn
                const startDateStr = document.getElementById('comparisonStartDate').value;
                const endDateStr = document.getElementById('comparisonEndDate').value;

                if (!startDateStr || !endDateStr) {
                    toggleBtn.textContent = 'Ẩn So sánh';
                    toggleBtn.style.backgroundColor = 'var(--text-muted)';
                    return showToast('Vui lòng chọn ngày Bắt đầu và Kết thúc để hiện So sánh.');
                }

                // Chạy lại logic so sánh
                runComparison();
            }
        }

        // Cập nhật hàm này để lưu thêm chi tiết nhóm hàng thi đua
        function saveDailyPerformance(data) {
            if (!data || data.length === 0) {
                return;
            }

            try {
                const historyKey = 'performanceHistory';
                const today = getTodayDateString();

                // Lọc dữ liệu cần thiết để lưu chi tiết
                const simplifiedData = data.map(e => ({
                    id: e.id,
                    name: e.name,
                    rank: e.rank,
                    totalScore: e.totalScore,
                    projectedRevenueCompletion: e.projectedRevenueCompletion,
                    overallProjectedContestCompletion: e.overallProjectedContestCompletion,
                    // Lưu chi tiết nhóm hàng thi đua
                    contestCompletion: Object.fromEntries(
                        Object.entries(e.contestCompletion).map(([key, value]) => [
                            key,
                            // SỬA LỖI: LŨY KẾ thực tế được làm tròn thành số nguyên khi lưu
                            { actual: Math.round(value.actual), projectedPercent: value.projectedPercent }
                        ])
                    )
                }));

                let history = JSON.parse(localStorage.getItem(historyKey) || '{}');
                history[today] = simplifiedData;
                localStorage.setItem(historyKey, JSON.stringify(history));
                // showToast(`Đã lưu hiệu suất chi tiết của ngày ${today} (${data.length} nhân viên).`); // Xóa toast khi tự động lưu
            } catch (error) {
                console.error("Lỗi khi lưu lịch sử:", error);
                showToast("Lỗi khi lưu lịch sử vào bộ nhớ cục bộ.");
            }
        }

        function loadHistory() {
            try {
                return JSON.parse(localStorage.getItem('performanceHistory') || '{}');
            } catch (error) {
                console.error("Lỗi khi đọc lịch sử:", error);
                return {};
            }
        }

        // Bỏ qua hàm showComparisonModal vì không dùng modal nữa

        function runComparison() {
            const startDateStr = document.getElementById('comparisonStartDate').value;
            const endDateStr = document.getElementById('comparisonEndDate').value;
            const toggleBtn = document.getElementById('toggleComparisonBtn');

            // Vô hiệu hóa nút toggle trước
            toggleBtn.style.display = 'none';

            if (!startDateStr || !endDateStr) {
                comparisonResultsCache = null;
                renderAllEmployeeCards(finalData);
                return showToast('Vui lòng chọn cả Ngày Bắt đầu và Ngày Kết thúc để hiện So sánh.');
            }

            if (startDateStr > endDateStr) {
                comparisonResultsCache = null;
                renderAllEmployeeCards(finalData);
                return showToast('Ngày Bắt đầu phải nhỏ hơn hoặc bằng Ngày Kết thúc.');
            }

            const history = loadHistory();
            const startData = history[startDateStr];
            let endData;

            // 1. Lấy dữ liệu ngày kết thúc
            if (endDateStr === getTodayDateString() && finalData.length > 0) {
                // Nếu ngày kết thúc là hôm nay, dùng dữ liệu đang có trong bộ nhớ (finalData)
                endData = finalData.map(e => ({
                    id: e.id,
                    name: e.name,
                    rank: e.rank,
                    totalScore: e.totalScore,
                    projectedRevenueCompletion: e.projectedRevenueCompletion,
                    overallProjectedContestCompletion: e.overallProjectedContestCompletion,
                    contestCompletion: Object.fromEntries(
                        Object.entries(e.contestCompletion).map(([key, value]) => [
                            key,
                            // LŨY KẾ thực tế được làm tròn khi lưu
                            { actual: Math.round(value.actual), projectedPercent: value.projectedPercent }
                        ])
                    )
                }));
            } else {
                // Lấy dữ liệu của ngày kết thúc từ lịch sử
                endData = history[endDateStr];
            }

            // 2. Lấy dữ liệu ngày bắt đầu
            let startDataToUse = startData;

            // Xử lý trường hợp so sánh 2 ngày trùng nhau
            if (startDateStr === endDateStr) {
                startDataToUse = endData; // Dữ liệu bắt đầu = dữ liệu kết thúc
            }

            if (!startDataToUse || !endData) {
                let missingDate = !startDataToUse ? startDateStr : endDateStr;
                comparisonResultsCache = null;
                renderAllEmployeeCards(finalData);
                return showToast(`Không tìm thấy dữ liệu hiệu suất đã lưu cho ngày ${missingDate}.`);
            }

            // Xây dựng map cho dữ liệu bắt đầu
            const startMap = new Map(startDataToUse.map(e => [e.id, e]));

            // Tạo dữ liệu so sánh (sử dụng dữ liệu kết thúc làm cơ sở)
            const comparisonResults = endData.map(endEmp => {
                const startEmp = startMap.get(endEmp.id);
                if (!startEmp) {
                    return {
                        ...endEmp,
                        startRank: 'N/A',
                        changeScore: 'N/A',
                        changeRevenue: 'N/A',
                        changeContest: 'N/A',
                        contestChanges: []
                    };
                }

                // Tính toán thay đổi nhóm hàng chi tiết
                const allContests = new Set([...Object.keys(endEmp.contestCompletion || {}), ...Object.keys(startEmp.contestCompletion || {})]);
                const contestChanges = Array.from(allContests).map(contest => {
                    // Lấy Lũy kế đã làm tròn từ dữ liệu đã lưu
                    const endActual = endEmp.contestCompletion?.[contest]?.actual || 0;
                    const startActual = startEmp.contestCompletion?.[contest]?.actual || 0;

                    // Lấy chênh lệch LŨY KẾ thực tế (Actual) giữa 2 ngày (sẽ là số nguyên)
                    const change = endActual - startActual;

                    // Lấy chênh lệch % HT Dự kiến để hiển thị thêm
                    const endProjected = endEmp.contestCompletion?.[contest]?.projectedPercent || 0;
                    const startProjected = startEmp.contestCompletion?.[contest]?.projectedPercent || 0;
                    const changeProjectedPercent = endProjected - startProjected;


                    return {
                        name: contest,
                        changeActual: change, // Chênh lệch Lũy kế (giá trị thực)
                        changeProjectedPercent: changeProjectedPercent // Chênh lệch % HT Dự kiến (giá trị phần trăm)
                    };
                }).filter(c => Math.abs(c.changeActual) > 0 || Math.abs(c.changeProjectedPercent) > 0.001); // Chỉ quan tâm thay đổi


                return {
                    ...endEmp,
                    startRank: startEmp.rank,
                    changeScore: endEmp.totalScore - startEmp.totalScore,
                    changeRevenue: endEmp.projectedRevenueCompletion - startEmp.projectedRevenueCompletion,
                    changeContest: endEmp.overallProjectedContestCompletion - startEmp.overallProjectedContestCompletion,
                    contestChanges: contestChanges
                };
            }).sort((a, b) => a.rank - b.rank); // Sắp xếp theo rank hiện tại (ngày kết thúc)

            comparisonResultsCache = comparisonResults;

            // Hiển thị trực tiếp kết quả lên thẻ KPI
            renderAllEmployeeCards(finalData);
            // Render lại Bảng tổng hợp để hiển thị chênh lệch điểm
            renderComprehensiveDashboard(finalData, sortedContestHeadersGlobal, {});

            // Kích hoạt và đặt lại nút toggle
            toggleBtn.textContent = 'Ẩn So sánh';
            toggleBtn.style.backgroundColor = 'var(--danger-color)';
            toggleBtn.style.display = 'inline-block';

            showToast(`Đã so sánh hiệu suất từ ${startDateStr} đến ${endDateStr}. Dữ liệu chênh lệch hiển thị trên Thẻ KPI.`);
        }

        // Đã loại bỏ renderComparisonTable vì không dùng modal

        function getChangeHtml(value, decimals = 1, isPercent = false) {
            if (value === 'N/A') return '';

            const num = parseFloat(value);
            // Ngưỡng 0.001 được dùng cho giá trị float (phần trăm/điểm). Giá trị đếm (actual) đã được làm tròn thành số nguyên nên chỉ cần check > 0
            if (isNaN(num) || (!isPercent && num === 0) || (isPercent && Math.abs(num) < 0.001)) return '';

            const absValue = Math.abs(num);
            let icon = '';
            let className = '';
            const suffix = isPercent ? '%' : '';


            if (num > 0) {
                icon = '▲';
                className = 'change-up';
            } else if (num < 0) {
                icon = '▼';
                className = 'change-down';
            }

            // QUAN TRỌNG: Giá trị lũy kế thực tế (không phải phần trăm) sẽ được làm tròn 0 chữ số thập phân và dùng formatNumberFull
            const displayDecimals = isPercent ? decimals : 0;
            // Giá trị lũy kế (actual) đã được làm tròn trong quá trình lưu, nên chỉ cần format lại cho dễ đọc
            const displayValue = isPercent ? absValue.toFixed(displayDecimals) : formatNumberFull(Math.round(absValue), 0);

            return `<span class="comparison-change ${className}" style="margin-left: 5px;">${icon} ${displayValue}${suffix}</span>`;
        }

        // Hàm xác định lớp màu dựa trên phần trăm
        function getPercentColorClass(percent) {
            if (percent >= 100) return 'text-success';
            if (percent >= 80) return 'text-warning';
            return 'text-danger';
        }


        // --- XỬ LÝ DỮ LIỆU CHÍNH ---
        // Thêm tham số `isReRenderOnly` để không chạy lại tính Target ban đầu nếu chỉ là re-render UI
        function processData(skipHeaderExtraction = false, isReRenderOnly = false) {
            try {
                // 1. Lấy và xác thực đầu vào
                const inputs = {
                    data7: document.getElementById('dataInput7').value,
                    data6: document.getElementById('dataInput6').value,
                    data2: document.getElementById('dataInput2').value,
                    data6_T1: document.getElementById('dataInput6_T1').value, // Thêm input T-1
                    storeTarget: safeParseFloat(document.getElementById('storeTargetInput').value),
                    isAllInOne: true,
                };

                // FIX: Cho phép chạy nếu CHỈ có dữ liệu T-1 và Target Siêu thị (để tính target trước)
                // Nếu không có dữ liệu thực tế (data7, data6, data2), hệ thống vẫn phải tính target được.
                const hasRealTimeData = inputs.data7 && inputs.data6 && inputs.data2;
                const hasTargetData = inputs.storeTarget > 0 && inputs.data6_T1;

                if (!hasRealTimeData && !hasTargetData) {
                    throw new Error("Vui lòng nhập Dữ liệu T-1 và Target Siêu thị (để chia Target) HOẶC nhập đủ dữ liệu bán hàng tháng này.");
                }

                if (detectedEmployees.length === 0) {
                    // Thử extract lại một lần nữa
                    extractEmployeesFromInputs();
                    if (detectedEmployees.length === 0) {
                        throw new Error("Không tìm thấy dữ liệu nhân viên. Vui lòng dán Bảng 6 (T-1 hoặc Hiện tại).");
                    }
                }

                // 1. Load Equal Distribution Flags (Đã load ở initDashboard)

                // 2. Phân tích dữ liệu để lấy ALL contest headers (CHỈ LÀM LẦN ĐẦU hoặc khi có dữ liệu mới)
                // SỬA LỖI: Luôn chạy logic này để đảm bảo allContestHeadersGlobal được cập nhật
                // Nếu có data7 thì lấy từ data7, nếu không thì lấy từ dataInput7 (dù trống thì thôi)
                let lines7 = [];
                if (inputs.data7) {
                    lines7 = inputs.data7.split('\n').filter(line => line.trim());
                } else {
                    // Nếu không có Data 7 thực tế, thử lấy từ T-1 nếu cần thiết (nhưng contest header thường lấy từ Data 7 hiện tại để chuẩn)
                    // Tuy nhiên, logic hiện tại yêu cầu Data 7 để biết tháng này có ngành hàng gì.
                    // Nếu chưa có Data 7, tạm thời hiển thị thông báo hoặc dùng headers cũ nếu có.
                    if (allContestHeadersGlobal.length === 0) {
                        // Nếu chưa có headers nào (lần đầu), và không có Data 7, thì không thể chia Target TĐ chi tiết được.
                        // Nhưng vẫn có thể chia Target DT.
                    }
                }

                let subHeaderIndex7 = -1;
                if (lines7.length > 0) {
                    subHeaderIndex7 = lines7.findIndex(line => line.trim().startsWith('SLLK'));
                    if (subHeaderIndex7 > 0) {
                        let allHeaders = lines7.slice(1, subHeaderIndex7).map(h => h.trim()).filter(Boolean);

                        const invalidHeaderKeywords = ['DTLK', 'SLLK', 'Tổng', 'BP All In One', 'Nguyễn', 'Bùi', 'Dương', 'Đỗ', 'Trần', 'Lê', 'Phạm', 'Hoàng', 'Phan', 'Vũ', 'Đặng', 'Thị'];
                        allContestHeadersGlobal = allHeaders.filter(header => {
                            return !invalidHeaderKeywords.some(keyword => header.includes(keyword));
                        });
                    }
                }


                // Nếu là lần đầu, gán selectedContestHeaders = allContestHeadersGlobal (Hiển thị tất cả)
                if (selectedContestHeaders.length === 0 || selectedContestHeaders.length === allContestHeadersGlobal.length) {
                    selectedContestHeaders = [...allContestHeadersGlobal];
                    localStorage.setItem('selectedContestHeaders', JSON.stringify(selectedContestHeaders));
                }

                // FIX: Xử lý logic hiển thị Báo cáo Target khi chưa có data thực tế
                if (!hasRealTimeData && isReRenderOnly) {
                    // Nếu chỉ render lại bảng target (khi chỉnh sửa), và chưa có dữ liệu thực tế -> OK
                } else if (!hasRealTimeData) {
                    // Nếu nhấn nút "Tạo Báo Cáo" mà chưa có dữ liệu thực tế -> Chỉ hiện bảng Target Allocation, ẩn các báo cáo khác
                    renderTargetAllocationReport(finalEmployeeTargets, allContestHeadersGlobal);
                    document.getElementById('report-capture-area').style.display = 'none'; // Ẩn phần báo cáo kết quả
                    showToast("Đã cập nhật Target! (Chưa có dữ liệu bán hàng tháng này để báo cáo)");
                    return; // Dừng xử lý báo cáo thực tế
                }

                // 3. Áp dụng bộ lọc ngành hàng đã chọn
                let finalContestHeaders;
                const isAllSelected = document.getElementById('allContestsCheckbox').checked;

                if (isAllSelected) {
                    finalContestHeaders = [...allContestHeadersGlobal];
                } else {
                    finalContestHeaders = allContestHeadersGlobal.filter(header => selectedContestHeaders.includes(header));
                }

                if (finalContestHeaders.length === 0 && allContestHeadersGlobal.length > 0) {
                    showToast("Không có ngành hàng nào được chọn. Vui lòng chọn ngành hàng.");
                    updateContestStatusUI();
                    return;
                }

                // 4. Phân tích dữ liệu nhân viên (Bảng 7)

                const fullHeaders = lines7.slice(1, subHeaderIndex7).map(h => h.trim()).filter(Boolean);
                const fullHeaderMap = fullHeaders.reduce((map, header, index) => {
                    map[header] = index;
                    return map;
                }, {});

                const employeeMap = new Map();
                employeeMap.set('TOTAL_EMPLOYEES_ONLY', {
                    name: 'Tổng nhân viên',
                    id: 'TOTAL_EMPLOYEES_ONLY',
                    group: 'all',
                    sales: {}
                });

                const activeEmployeeIds = detectedEmployees.map(e => e.id);

                lines7.slice(subHeaderIndex7 + 1).forEach(row => {
                    const cells = row.split('\t');
                    const nameId = (cells[0] || '').trim();

                    // CHỈ XỬ LÝ NHÂN VIÊN ĐÃ ĐƯỢC LỌC VÀ CÓ DỮ LIỆU
                    if (activeEmployeeIds.includes(nameId)) {
                        const nameOnly = nameId.split(' - ')[0].trim();
                        const group = 'all';
                        const sales = {};
                        allContestHeadersGlobal.forEach(header => {
                            const index = fullHeaderMap[header];
                            sales[header.trim()] = safeParseFloat(cells[index + 1]);
                        });
                        employeeMap.set(nameId, { name: nameOnly, id: nameId, group, sales });
                    }
                });

                // 5. TÍNH TOÁN TARGET BAN ĐẦU HOẶC ƯU TIÊN TARGET ĐÃ CHỈNH SỬA
                let initialTargets = new Map();
                // Nếu chỉ là re-render UI sau khi thay đổi target, KHÔNG CẦN tính toán lại 3T Avg.
                if (!isReRenderOnly) {
                    initialTargets = calculateInitialTargets(allContestHeadersGlobal); // Dùng ALL headers để đảm bảo tính toán đủ
                    // Lưu lại Target mặc định (theo skill) để dùng làm default
                    initialTargets.forEach((value, key) => employeeTargetsBySkill.set(key, value));

                    // LƯU Ý: Khi tính toán lại, ta vẫn giữ các cờ isActive, manualPercent từ lần trước nếu có
                    const finalTargetsFromInitial = new Map();
                    initialTargets.forEach((initial, id) => {
                        const existing = finalEmployeeTargets.get(id) || {};
                        finalTargetsFromInitial.set(id, {
                            ...initial,
                            // Giữ lại % chỉnh sửa thủ công và trạng thái active nếu có
                            manualDtPercent: existing.manualDtPercent !== undefined ? existing.manualDtPercent : initial.manualDtPercent,
                            // manualContestPercent ban đầu lấy từ % 3T Avg (nếu chưa có chỉnh sửa)
                            manualContestPercent: existing.manualContestPercent && Object.keys(existing.manualContestPercent).length > 0 ? existing.manualContestPercent : Object.fromEntries(initial.contest3MonthContribution),
                            isActive: existing.isActive !== undefined ? existing.isActive : true, // Mặc định là active
                        });
                    });
                    finalEmployeeTargets = finalTargetsFromInitial;
                }

                // BẮT BUỘC TÍNH TOÁN PHÂN BỔ CUỐI CÙNG DỰA TRÊN CÁC CỜ VÀ % ĐÃ CÓ
                // targetsToUse chứa các giá trị cuối cùng (dtTarget, contestTargets) sau khi áp dụng Equal Distribution và Active Status
                const targetsToUse = calculateTargetDistribution(finalEmployeeTargets);

                // Cập nhật lại finalEmployeeTargets bằng targetsToUse (vì targetsToUse giờ đã tính cả Target DT và TĐ tuyệt đối)
                targetsToUse.forEach((value, key) => {
                    finalEmployeeTargets.set(key, value);
                });


                // Lấy Target Cửa hàng (Bảng 2)
                const contestTargetsStore = {};
                const contestStoreStats = {};
                const lines2 = inputs.data2.split('\n').filter(line => line.trim());
                if (lines2.length > 1) {
                    const headers2 = lines2.shift().split('\t').map(h => h.trim());
                    const nameIndex2 = headers2.findIndex(h => h.includes('Ngành hàng'));
                    const dtqdIndex2 = headers2.findIndex(h => h === 'DTQĐ');
                    const targetIndex2 = headers2.findIndex(h => h === 'Target');
                    const projectedIndex2 = headers2.findIndex(h => h.includes('% HT Dự Kiến'));

                    if (nameIndex2 !== -1 && targetIndex2 !== -1) {
                        lines2.forEach(row => {
                            const cells = row.split('\t');
                            const categoryName = (cells[nameIndex2] || '').trim();
                            // CHỈ XỬ LÝ CÁC NGÀNH HÀNG ĐÃ ĐƯỢC TRÍCH XUẤT TỪ BẢNG 7 (allContestHeadersGlobal)
                            if (allContestHeadersGlobal.includes(categoryName)) {
                                const target = safeParseFloat(cells[targetIndex2]);
                                const actual = (dtqdIndex2 !== -1) ? safeParseFloat(cells[dtqdIndex2]) : 0;
                                const projected = (projectedIndex2 !== -1) ? safeParseFloat(String(cells[projectedIndex2]).replace(/%/g, '')) : 0;
                                contestTargetsStore[categoryName] = target;
                                contestStoreStats[categoryName] = { actual, target, projectedPercentFromSource: projected };
                            }
                        });
                    }
                }


                // 6. Lấy DTQD thực tế (Bảng 6)
                const lines6 = inputs.data6.split('\n').filter(line => line.trim());
                if (lines6.length > 1) {
                    const headers6 = lines6.shift().split('\t').map(h => h.trim());
                    const nameIndex6 = headers6.findIndex(h => h.includes('viên'));
                    const dtqdIndex6 = headers6.findIndex(h => h === 'DTQĐ');
                    employeeMap.forEach((employee, nameId) => {
                        const row6 = lines6.find(r => (r.split('\t')[nameIndex6] || '').trim() === nameId);
                        employee.actual_DTQD = (row6 && dtqdIndex6 !== -1) ? safeParseFloat(row6.split('\t')[dtqdIndex6]) : 0;
                    });
                } else {
                    employeeMap.forEach(e => e.actual_DTQD = 0);
                }

                const currentMonthTimeframe = getContestTimeframe('');
                const isFirstDayOfMonth = new Date().getDate() === 1; // Logic: Ngày 1 tính như kết quả tháng trước (Dự kiến = Thực tế)
                finalData = [];
                const totalSelectedContests = finalContestHeaders.length;

                employeeMap.forEach(employee => {
                    const targetData = targetsToUse.get(employee.id); // Lấy Target đã được phân bổ cuối cùng
                    if (targetData && targetData.isActive) {

                        // TARGET LÀ GIÁ TRỊ TỪ targetsToUse (đã tính toán cuối cùng)
                        employee.revenueTarget = targetData.dtTarget;
                        employee.contestTargets = targetData.contestTargets;

                        // ... (phần tính toán KPI còn lại giữ nguyên)
                        employee.revenueCompletion = employee.revenueTarget > 0 ? (employee.actual_DTQD / employee.revenueTarget) * 100 : 0;
                        // Nếu là mùng 1, Dự kiến = Thực tế (Lũy kế / Target). Ngược lại tính theo projection.
                        employee.projectedRevenueCompletion = isFirstDayOfMonth
                            ? employee.revenueCompletion
                            : (employee.revenueTarget > 0 ? (employee.actual_DTQD / currentMonthTimeframe.passedDays * currentMonthTimeframe.totalDays) / employee.revenueTarget * 100 : 0);

                        employee.contestCompletion = {};
                        employee.projectedCompletedContests = 0;

                        finalContestHeaders.forEach(key => {
                            const timeframe = getContestTimeframe(key);
                            const target = employee.contestTargets[key] || 0;
                            const actual = employee.sales[key] || 0;
                            const percent = target > 0 ? (actual / target) * 100 : 0;
                            // Nếu là mùng 1, % Dự kiến = % Thực tế.
                            const projectedPercent = isFirstDayOfMonth
                                ? percent
                                : (target > 0 ? (actual / timeframe.passedDays * timeframe.totalDays) / target * 100 : 0);

                            // Lấy Target tổng của cửa hàng (Bảng 2) cho mục đích hiển thị trong bảng tổng hợp
                            const storeStats = contestStoreStats[key] || { actual: 0, target: 0, projectedPercentFromSource: 0 };

                            employee.contestCompletion[key] = {
                                target,
                                actual,
                                percent,
                                projectedPercent,
                                storeTarget: storeStats.target,
                                storeActual: storeStats.actual
                            };
                            if (projectedPercent >= 100) employee.projectedCompletedContests++;
                        });

                        employee.overallProjectedContestCompletion = totalSelectedContests > 0 ? (employee.projectedCompletedContests / totalSelectedContests) * 100 : 0;
                        const contestScore = employee.overallProjectedContestCompletion;
                        const revenueScore = employee.projectedRevenueCompletion;
                        employee.totalScore = revenueScore + contestScore;

                        finalData.push(employee);
                    }
                });

                finalData.sort((a, b) => b.totalScore - a.totalScore);
                finalData.forEach((employee, index) => { employee.rank = index + 1; });

                const contestProjectedTotals = {};
                finalContestHeaders.forEach(header => {
                    const stat = contestStoreStats[header];
                    if (stat && stat.target > 0) {
                        const timeframe = getContestTimeframe(header);
                        // TỰ TÍNH TOÁN DỰ KIẾN SIÊU THỊ ĐỂ ĐẢM BẢO CHÍNH XÁC (Tránh lỗi 126% từ nguồn)
                        if (isFirstDayOfMonth) {
                            contestProjectedTotals[header] = stat.target > 0 ? (stat.actual / stat.target * 100) : 0;
                        } else {
                            contestProjectedTotals[header] = (stat.actual / timeframe.passedDays * timeframe.totalDays) / stat.target * 100;
                        }
                    } else {
                        contestProjectedTotals[header] = stat ? stat.projectedPercentFromSource : 0;
                    }
                });

                sortedContestHeadersGlobal = [...finalContestHeaders].sort((a, b) => {
                    return (contestProjectedTotals[b] || 0) - (contestProjectedTotals[a] || 0);
                });

                updateContestStatusUI();

                // RENDER UI: Chỉ hiển thị các báo cáo kết quả (ẩn Target Allocation Report khỏi khu vực này)
                if (!isReRenderOnly) {
                    renderUI(finalData, sortedContestHeadersGlobal, currentMonthTimeframe, contestProjectedTotals);
                } else {
                    // Nếu chỉ là re-render để cập nhật target, chỉ cần render lại bảng target
                    // SỬA LỖI: Dùng allContestHeadersGlobal để hiển thị target allocation report (không dùng finalContestHeaders/sortedContestHeadersGlobal)
                    renderTargetAllocationReport(finalEmployeeTargets, allContestHeadersGlobal);
                }

                // Cập nhật Target Allocation Report trong phần input
                // SỬA LỖI: Dùng allContestHeadersGlobal để hiển thị target allocation report (không dùng finalContestHeaders/sortedContestHeadersGlobal)
                renderTargetAllocationReport(finalEmployeeTargets, allContestHeadersGlobal);

                // Lưu inputs
                const inputsToSave = ['dataInput7', 'dataInput6', 'dataInput2', 'storeTargetInput', 'targetRangeStart', 'targetRangeEnd', 'targetRangePercent'];
                localStorage.setItem('targetTimeMode', document.querySelector('input[name="targetTimeMode"]:checked').value);

                historyDataInputs.forEach(h => { inputsToSave.push(h.idDT); });
                inputsToSave.forEach(key => {
                    const el = document.getElementById(key);
                    if (el) localStorage.setItem(el.id, el.value);
                });

                // TỰ ĐỘNG LƯU DỮ LIỆU HIỆU SUẤT VÀO LỊCH SỬ
                if (!isReRenderOnly) saveDailyPerformance(finalData);

            } catch (error) {
                showToast(`Đã xảy ra lỗi: ${error.message}`);
                console.error("Data processing error:", error);
            }
        }

        // --- HIỂN THỊ GIAO DIỆN ---
        function renderUI(data, headers, timeframe, projectedTotals) {
            document.getElementById('data-input-card').style.display = 'none';

            // Ẩn bảng target allocation report card khỏi khu vực report capture
            document.getElementById('target-allocation-report-card').style.display = 'none';

            document.getElementById('report-header').style.display = 'flex';
            document.getElementById('results-wrapper').style.display = 'block';
            document.getElementById('stram-analysis-card').style.display = 'block';
            document.getElementById('comments-card').style.display = 'block';
            document.getElementById('kpi-cards-section').style.display = 'block';

            const today = new Date();
            document.getElementById('reportTitle').textContent = `Báo cáo đánh giá nhân viên đến ngày ${today.toLocaleDateString('vi-VN')}`;
            document.getElementById('month-progress-container').innerHTML = `
            <div class="progress-bar-wrapper" style="margin-top:0;">
                <div class="progress-bar-label"><span>Tiến độ Tháng</span><span>${(timeframe.passedDays / timeframe.totalDays * 100).toFixed(1)}%</span></div>
                <div class="progress-bar-bg" style="height:12px;"><div class="progress-bar-fill" style="width: ${(timeframe.passedDays / timeframe.totalDays * 100)}%;"></div></div>
            </div>`;
            document.getElementById('month-progress-container').style.display = 'block';

            renderComprehensiveDashboard(data, headers, projectedTotals);
            renderStramAnalysis(data);
            // Khi render UI, reset comparison cache and render
            comparisonResultsCache = null;
            renderAllEmployeeCards(data);

            // Ẩn nút toggle so sánh khi mới load báo cáo
            document.getElementById('toggleComparisonBtn').style.display = 'none';

            // GỌI HÀM RENDER INFOGRAPHIC MỚI
            // (Hàm này sẽ tự gọi renderCommentsBox để cập nhật text ẩn)
            renderInfographic(data);
        }

        // NEW: Hàm viết tắt tên nhân viên (VD: Nguyễn Văn A -> N.V. A)
        function abbreviateName(fullName) {
            if (!fullName) return '';
            const parts = fullName.trim().split(/\s+/);
            if (parts.length < 2) return fullName;

            // Logic: Các từ đầu lấy chữ cái đầu + dấu chấm. Từ cuối cùng giữ nguyên.
            // VD: Nguyễn Bình Minh -> N.B. Minh
            const lastName = parts.pop();
            const initials = parts.map(p => p.charAt(0).toUpperCase() + '.').join('');
            return `${initials} ${lastName}`;
        }

        // NEW: Render Bảng Target Phân bổ (có thể chỉnh sửa)
        function renderTargetAllocationReport(targetsToUse, headers) {
            const container = document.getElementById('targetAllocationReportContainer');
            // SỬA LỖI: Truyền headers vào hàm tính toán để đảm bảo khớp
            const finalCalculatedTargets = calculateTargetDistribution(targetsToUse, headers);
            const employeeTargets = Array.from(finalCalculatedTargets.values());

            if (employeeTargets.length === 0) {
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: #94a3b8; font-style: italic;">Vui lòng dán dữ liệu và nhấn "Tạo Báo Cáo Phân Tích" để phân bổ Target.</div>';
                return;
            }

            // 1. Tính toán lại tổng cộng cuối cùng
            let totalDtAllocated = 0;
            let totalContestAllocated = new Map(headers.map(h => [h, 0]));

            employeeTargets.filter(e => e.isActive).forEach(e => {
                totalDtAllocated += e.dtTarget;
                headers.forEach(h => {
                    totalContestAllocated.set(h, totalContestAllocated.get(h) + (e.contestTargets[h] || 0));
                });
            });

            // 2. Lấy Target Siêu thị (Bảng 2) để kiểm tra tổng % phân bổ TĐ
            const storeTargetsMap = new Map();
            const data2 = document.getElementById('dataInput2').value;
            if (data2.trim()) {
                const lines2 = data2.split('\n').filter(line => line.trim());
                if (lines2.length > 1) {
                    const headers2 = lines2.shift().split('\t').map(h => h.trim());
                    const nameIndex2 = headers2.findIndex(h => h.includes('Ngành hàng'));
                    const targetIndex2 = headers2.findIndex(h => h === 'Target');
                    if (nameIndex2 !== -1 && targetIndex2 !== -1) {
                        lines2.forEach(row => {
                            const cells = row.split('\t');
                            const categoryName = (cells[nameIndex2] || '').trim();
                            if (allContestHeadersGlobal.includes(categoryName)) {
                                storeTargetsMap.set(categoryName, safeParseFloat(cells[targetIndex2]));
                            }
                        });
                    }
                }
            }

            // Calculate totals for footer
            const totalDtPercent = employeeTargets.filter(e => e.isActive).reduce((sum, e) => sum + e.manualDtPercent, 0);

            // 3. Build Header
            let headerHtml = `
                <thead>
                    <tr>
                        <th rowspan="2" style="width: 30px; font-size: 11px; padding: 4px;">#</th>
                        <th rowspan="2" style="width: 30px; padding: 4px;"><input type="checkbox" id="checkAllEmployeesTarget" ${employeeTargets.every(e => e.isActive) ? 'checked' : ''} onchange="toggleAllEmployeesTarget(this.checked)"></th>
                        <th rowspan="2" style="width: 100px; text-align: left; font-size: 11px; padding: 4px;">Nhân viên</th>
                        <th rowspan="2" style="width: 50px; font-size: 10px; padding: 4px;">% T-1</th>
                        <th colspan="2" class="col-revenue" style="padding: 4px;">
                            <span class="header-main-title" style="font-size: 11px;">TARGET DT</span>
                            <div style="display: flex; align-items: center; justify-content: center; gap: 3px; margin-bottom: 2px;">
                                <input type="checkbox" id="dt_equal_dist" onchange="toggleEqualDistribution('DT_Target', this.checked)" ${equalDistributionFlags.get('DT_Target') ? 'checked' : ''}>
                                <label for="dt_equal_dist" style="font-size: 8px; cursor: pointer; text-transform: none;">Chia đều</label>
                            </div>
                            <div style="display: flex; align-items: center; justify-content: center; gap: 3px;">
                                <input type="checkbox" id="dt_t1_dist" onchange="toggleT1Distribution('DT_Target', this.checked)" ${t1DistributionFlags.get('DT_Target') ? 'checked' : ''}>
                                <label for="dt_t1_dist" style="font-size: 8px; cursor: pointer; text-transform: none;">Theo T-1</label>
                            </div>
                        </th>
            `;

            // Add a global control row for "All T-1"
            // Note: Inserting it into the DOM outside this function might be cleaner, but let's put a small button or checkbox in the first header cell for simplicity logic
            // Actually, let's put it in the "Chỉnh %" / "Giá trị" row or somewhere visible. 
            // Better yet, add a small control panel ABOVE the table in HTML structure, but since we are generating table here:
            // Let's add it near the "Target Phân bổ" title in the parent container via separate JS update or include in the first TH.

            // Let's modify the FIRST TH (#) to include a "All By T-1" toggle if needed, or better, add a row above headers? No, keep it simple.
            // Let's add it to the top left corner.


            headers.forEach((h, index) => {
                const contestKey = `${h}_TargetTD`;
                const safeContestName = h.replace(/[^a-zA-Z0-9]/g, '-');
                const colClass = `col-contest-${(index % 3) + 1}`;

                headerHtml += `
                    <th colspan="2" class="${colClass}" style="padding: 4px;">
                        <span class="header-main-title" style="font-size: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px; display: inline-block;">${index + 1}. ${h.toUpperCase()}</span>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 3px;">
                            <div style="display: flex; align-items: center; gap: 1px;">
                                <input type="number" value="${contestAdjustPercents.get(h) || 0}" step="1" 
                                    onchange="contestAdjustPercents.set('${h}', safeParseFloat(this.value)); updateEmployeeTargets();"
                                    class="input-pill" style="width: 25px; height: 16px; font-size: 9px; padding: 0 2px;">
                                <span style="font-size: 8px;">%</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1px;">
                                <input type="checkbox" id="td_equal_dist_${safeContestName}" onchange="toggleEqualDistribution('${contestKey}', this.checked)" ${equalDistributionFlags.get(contestKey) ? 'checked' : ''}>
                                <label for="td_equal_dist_${safeContestName}" style="font-size: 8px; cursor: pointer; text-transform: none;">Đều</label>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1px;">
                                <input type="checkbox" id="td_t1_dist_${safeContestName}" onchange="toggleT1Distribution('${contestKey}', this.checked)" ${t1DistributionFlags.get(contestKey) ? 'checked' : ''}>
                                <label for="td_t1_dist_${safeContestName}" style="font-size: 8px; cursor: pointer; text-transform: none;">T-1</label>
                            </div>
                        </div>
                    </th>
                `;
            });

            headerHtml += `</tr><tr>
                <th class="col-revenue">Chỉnh %</th><th class="col-revenue">Giá trị (Tr)</th>
            `;
            headers.forEach((h, index) => {
                const colClass = `col-contest-${(index % 3) + 1}`;
                headerHtml += `<th class="${colClass}" style="font-size: 9px; padding: 2px;">Giá trị</th><th class="${colClass}" style="font-size: 9px; padding: 2px;">%</th>`;
            });
            headerHtml += `</tr></thead>`;

            // 2. Build Body
            let bodyHtml = `<tbody>`;
            employeeTargets.forEach((emp, idx) => {
                const safeEmpId = emp.id.replace(/[^a-zA-Z0-9]/g, '-');
                const rowOpacity = emp.isActive ? 1 : 0.5;
                const rowBg = idx % 2 === 0 ? '#ffffff' : '#f8fafc';

                bodyHtml += `<tr style="opacity: ${rowOpacity}; background-color: ${rowBg};">
                    <td style="text-align: center; color: #64748b; font-weight: 600; padding: 4px; font-size: 11px;">${idx + 1}</td>
                    <td style="text-align: center; padding: 4px;">
                        <input type="checkbox" onchange="toggleEmployeeActive('${emp.id}', this.checked)" ${emp.isActive ? 'checked' : ''}>
                    </td>
                    <td style="font-weight: 700; color: #334155; padding: 4px; white-space: nowrap; font-size: 11px;" title="${emp.name}">${abbreviateName(emp.name)}</td>
                    <td style="text-align: center; color: #475569; font-weight: 600; padding: 4px; font-size: 10px;">${emp.dtPercent3T.toFixed(1)}%</td>
                    
                    <!-- Revenue Columns -->
                    <td class="col-revenue" style="text-align: center; padding: 4px;">
                        <input type="number" value="${emp.manualDtPercent.toFixed(2)}" 
                            onchange="handleTargetPercentChange(this, '${emp.id}', 'dtPercent')"
                             class="input-pill" style="width: 40px; height: 20px; font-size: 10px; padding: 0 4px;"
                             ${equalDistributionFlags.get('DT_Target') || t1DistributionFlags.get('DT_Target') || !emp.isActive ? 'disabled' : ''}>
                    </td>
                    <td class="col-revenue target-value-cell revenue-value" style="padding: 4px; font-size: 11px;">
                        ${formatNumberFull(emp.dtTarget / 1000, 3)}
                    </td>
                `;

                headers.forEach((h, index) => {
                    const colClass = `col-contest-${(index % 3) + 1}`;
                    const target = emp.contestTargets[h] || 0;
                    const percent3T = emp.contest3MonthContribution.get(h) || 0;
                    const manualPercent = emp.manualContestPercent?.[h] || percent3T;
                    const contestKey = `${h}_TargetTD`;
                    const safeContestName = h.replace(/[^a-zA-Z0-9]/g, '-');

                    bodyHtml += `
                        <td class="${colClass} target-value-cell contest-value" style="padding: 4px; font-size: 11px;">
                            ${formatNumberFull(Math.round(target), 0)}
                        </td>
                        <td class="${colClass}" style="text-align: center; padding: 4px;">
                            <input type="number" value="${manualPercent.toFixed(1)}" 
                                onchange="handleTargetPercentChange(this, '${emp.id}', 'contestPercent', '${h}')"
                                class="input-pill" style="width: 35px; height: 20px; font-size: 10px; padding: 0 4px;"
                                ${equalDistributionFlags.get(contestKey) || t1DistributionFlags.get(contestKey) || !emp.isActive ? 'disabled' : ''}>
                        </td>
                    `;
                });
                bodyHtml += `</tr>`;
            });

            // 3. Footer
            const totalPercentClass = Math.abs(totalDtPercent - 100) < 0.01 ? '#10b981' : '#ef4444';
            let footerHtml = `
                <tfoot>
                    <tr style="background-color: #f1f5f9; font-weight: 800;">
                        <td colspan="4" style="text-align: right; padding-right: 20px;">TỔNG CỘNG PHÂN BỔ:</td>
                        <td class="col-revenue" style="text-align: center; color: ${totalPercentClass}; font-size: 14px;">${totalDtPercent.toFixed(2)}%</td>
                        <td class="col-revenue revenue-value" style="text-align: center;">${formatNumberFull(totalDtAllocated / 1000, 3)}</td>
            `;

            headers.forEach((h, index) => {
                const colClass = `col-contest-${(index % 3) + 1}`;
                const totalVal = totalContestAllocated.get(h) || 0;
                const storeTarget = storeTargetsMap.get(h) || 0;
                const totalContestPercent = storeTarget > 0 ? (totalVal / storeTarget) * 100 : 0;
                const contestPercentClass = Math.abs(totalContestPercent - 100) < 0.01 ? 'text-success' : 'text-danger';

                footerHtml += `
                    <td class="${colClass} contest-value" style="text-align: center;">${formatNumberFull(Math.round(totalVal), 0)}</td>
                    <td class="${colClass}" style="text-align: center;">
                        <span class="${contestPercentClass}">${totalContestPercent.toFixed(2)}%</span>
                    </td>
                `;
            });
            footerHtml += `</tr></tfoot>`;

            container.innerHTML = `<table id="target-allocation-report-table">${headerHtml}${bodyHtml}${footerHtml}</table>`;

            // CẬP NHẬT TRẠNG THÁI CHECKBOX ALL
            const checkAllBox = document.getElementById('checkAllEmployeesTarget');
            if (checkAllBox) {
                checkAllBox.checked = employeeTargets.every(e => e.isActive);
            }
        }

        // Tìm kiếm dữ liệu so sánh trong cache
        function getComparisonData(employeeId) {
            if (!comparisonResultsCache) return null;
            return comparisonResultsCache.find(r => r.id === employeeId);
        }

        function renderComprehensiveDashboard(data, headers, projectedTotals) {
            const container = document.getElementById('comprehensiveLeaderboardContainer');
            const totalDisplayedContests = headers.length;

            let tableHtml = `
            <table class="comprehensive-table">
                <thead>
                    <tr>
                        <th class="sticky-col-1">Hạng</th>
                        <th class="sticky-col-2">Nhân viên</th>
                        <th class="sticky-col-3">Điểm</th>
                        <th class="sticky-col-4">Số ngành HT (DK/${totalDisplayedContests})</th>
                        <th class="sticky-col-5">Tiến độ DT</th>`;
            headers.forEach((h, index) => {
                const projectedTotal = projectedTotals[h] || 0;

                // NEW: Lấy Target/Lũy kế Store từ dữ liệu nhân viên đầu tiên
                const firstEmployeeData = data.find(e => e.contestCompletion[h]);
                const storeStats = firstEmployeeData ? firstEmployeeData.contestCompletion[h] : { storeActual: 0, storeTarget: 0 };
                const storeActualDisplay = formatNumberFull(storeStats.storeActual || 0, 0);
                const storeTargetDisplay = formatNumberFull(storeStats.storeTarget || 0, 0);

                // BỔ SUNG: Dòng tiêu đề ngành hàng (cho phép xuống dòng)
                tableHtml += `<th class="contest-header-cell" title="${h}">
                            <a href="#" class="clickable-header" onclick="showContestDetailsPopup('${encodeURIComponent(h)}', event)">${index + 1}. ${h}</a>
                            <div style="font-size: 10px; line-height: 1.2; margin-top: 2px; color: var(--text-muted); font-weight: 500;">
                                LK/T: ${storeActualDisplay} / ${storeTargetDisplay}
                            </div>
                            <div style="color: ${projectedTotal >= 100 ? 'var(--success-color)' : 'var(--danger-color)'}; font-size: 11px; font-weight: 700; margin-top: 2px;">
                                ${projectedTotal.toFixed(1)}% (ST)
                            </div>
                        </th>`;
            });
            tableHtml += `</tr></thead><tbody>`;

            data.forEach(e => {
                let rankIcon = '';
                if (e.rank === 1) rankIcon = '🥇';
                else if (e.rank === 2) rankIcon = '🥈';
                else if (e.rank === 3) rankIcon = '🥉';
                else if (data.length > 3 && e.rank >= data.length - 2) rankIcon = '🔴';
                const rankDisplay = rankIcon ? `<span class="rank-icon">${rankIcon}</span>` : e.rank;

                const revenueCompletionCapped = Math.min(100, e.revenueCompletion);

                // Lấy dữ liệu so sánh cho bảng tổng hợp
                const compData = getComparisonData(e.id);
                // Cập nhật để hiển thị chênh lệch điểm tổng
                const scoreDisplay = compData
                    ? `${e.totalScore.toFixed(1)} ${getChangeHtml(compData.changeScore, 1)}`
                    : e.totalScore.toFixed(1);


                tableHtml += `<tr>
                <td class="rank-cell sticky-col-1">${rankDisplay}</td>
                <td class="sticky-col-2"><a href="#" class="clickable-name" onclick="showEmployeeDetailsPopup('${e.id}', event)">${abbreviateName(e.name)}</a></td>
                <td style="font-weight: 700;" class="sticky-col-3">${scoreDisplay}</td>
                <td style="font-weight: 700;" class="sticky-col-4">${e.projectedCompletedContests}/${totalDisplayedContests}</td>
                <td class="sticky-col-5">
                    <div class="progress-bar-wrapper">
                         <div class="progress-bar-label">
                            <span style="font-weight: 800; color: var(--primary-accent);">${e.revenueCompletion.toFixed(1)}%</span>
                            <span class="bubble-projected" title="Phần trăm dự kiến đạt được">DK: ${e.projectedRevenueCompletion.toFixed(1)}%</span>
                        </div>
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill ${e.revenueCompletion >= 100 ? 'success' : ''}" style="width: ${revenueCompletionCapped}%;"></div>
                        </div>
                        <div style="font-size: 10px; margin-top: 2px; color: var(--text-muted);">${formatNumberFull(e.actual_DTQD, 0)} / ${formatNumberFull(e.revenueTarget, 0)}</div>
                    </div>
                </td>`;

                headers.forEach(h => {
                    const item = e.contestCompletion[h] || { projectedPercent: 0, actual: 0, target: 0 };
                    let badgeClass = '';
                    if (item.projectedPercent >= 100) {
                        badgeClass = 'badge-green';
                    } else {
                        badgeClass = 'badge-red';
                    }

                    // BỔ SUNG: Thông số Lũy kế / Target cá nhân (Vẫn giữ để có ngữ cảnh trong bảng tổng hợp)
                    const actualDisplay = formatNumberFull(item.actual, 0);
                    const targetDisplay = formatNumberFull(item.target, 0);

                    tableHtml += `<td class="heatmap-cell">
                                <span class="percent-badge ${badgeClass}">${item.projectedPercent.toFixed(1)}%</span>
                                <span class="contest-value-pair" title="Lũy kế / Target cá nhân">${actualDisplay} / ${targetDisplay}</span>
                            </td>`;
                });

                tableHtml += `</tr>`;
            });

            container.innerHTML = tableHtml + '</tbody></table>';
        }

        function showEmployeeDetailsPopup(employeeId, event) {
            event.preventDefault();
            const employeeData = finalData.find(emp => emp.id === employeeId);
            if (employeeData) {
                const contestData = Object.entries(employeeData.contestCompletion)
                    .filter(([name]) => sortedContestHeadersGlobal.includes(name))
                    .sort(([, a], [, b]) => b.projectedPercent - a.projectedPercent);

                // Lấy dữ liệu so sánh chi tiết nhóm hàng
                const compData = getComparisonData(employeeId);
                const contestChangeMap = compData ? new Map(compData.contestChanges.map(c => [c.name, c.changeActual])) : null;
                const contestChangeProjectedMap = compData ? new Map(compData.contestChanges.map(c => [c.name, c.changeProjectedPercent])) : null;


                let tableHtml = `
                <div class="card" style="margin:0; box-shadow: none; border: none;">
                    <h3 style="margin-top:0; color: var(--primary-color);">Chi tiết Thi đua: ${employeeData.name}</h3>
                    <div class="table-container" style="margin-top:15px; max-height: 60vh;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Ngành hàng</th>
                                    <th>Lũy kế</th>
                                    <th>Target</th>
                                    <th>% HT</th>
                                    <th>% HT Dự kiến</th>
                                    ${compData ? '<th>Thay đổi Lũy kế</th>' : ''}
                                    ${compData ? '<th>Thay đổi % HT DK</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>`;

                contestData.forEach(([name, data]) => {
                    const globalIndex = sortedContestHeadersGlobal.findIndex(h => h === name);

                    const percentClass = getPercentColorClass(data.percent);
                    const projectedClass = getPercentColorClass(data.projectedPercent);


                    const changeActualCellHtml = compData ? `<td style="font-weight: 700;">${getChangeHtml(contestChangeMap.get(name) || 0, 0)}</td>` : '';
                    const changeProjectedCellHtml = compData ? `<td style="font-weight: 700;">${getChangeHtml(contestChangeProjectedMap.get(name) || 0, 1, true)}</td>` : '';

                    tableHtml += `
                    <tr>
                        <td style="font-weight:bold;">${globalIndex + 1}</td>
                        <td>${name}</td>
                        <td>${formatNumberFull(data.actual, 2)}</td>
                        <td>${formatNumberFull(data.target, 0)}</td>
                        <td class="${percentClass}">${data.percent.toFixed(0)}%</td>
                        <td class="${projectedClass}">${data.projectedPercent.toFixed(1)}%</td>
                        ${changeActualCellHtml}
                        ${changeProjectedCellHtml}
                    </tr>`;
                });
                tableHtml += `</tbody></table></div></div>`;
                document.getElementById('modal-body').innerHTML = tableHtml;
                document.getElementById('kpi-modal').style.display = 'block';
            }
        }

        function showContestDetailsPopup(contestName, event) {
            event.preventDefault();
            const decodedContestName = decodeURIComponent(contestName);

            // Kiểm tra xem ngành hàng này có tồn tại trong danh sách hiển thị không
            if (!sortedContestHeadersGlobal.includes(decodedContestName)) {
                return showToast(`Ngành hàng "${decodedContestName}" hiện không được hiển thị/chọn để theo dõi.`);
            }

            // Sắp xếp danh sách nhân viên theo % hoàn thành dự kiến của ngành hàng này
            const sortedByContest = [...finalData].sort((a, b) => {
                const perfA = a.contestCompletion[decodedContestName]?.projectedPercent || 0;
                // ĐÃ SỬA LỖI CHÍNH TẢ Ở DÒNG DƯỚI ĐÂY (trước đây là decodedContodedContestName)
                const perfB = b.contestCompletion[decodedContestName]?.projectedPercent || 0;
                return perfB - perfA;
            });

            // Lấy dữ liệu so sánh toàn bộ (nếu đang bật chế độ so sánh)
            const comparisonDataAll = comparisonResultsCache;

            let tableHtml = `
            <div class="card" style="margin:0; box-shadow: none; border: none;">
                <h3 style="margin-top:0; color: var(--primary-color);">Xếp hạng Ngành hàng: ${decodedContestName}</h3>
                <div class="table-container" style="margin-top:15px;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Hạng</th>
                                <th>Nhân viên</th>
                                <th>Lũy kế</th>
                                ${comparisonDataAll ? '<th>Thay đổi Lũy kế</th>' : ''}
                                <th>Target</th>
                                <th>% HT</th>
                                <th>% HT Dự kiến</th>
                                ${comparisonDataAll ? '<th>Thay đổi % HT DK</th>' : ''}
                            </tr>
                        </thead>
                        <tbody>`;

            sortedByContest.forEach((employee, index) => {
                const item = employee.contestCompletion[decodedContestName] || { actual: 0, target: 0, percent: 0, projectedPercent: 0 };

                const percentClass = getPercentColorClass(item.percent);
                const projectedClass = getPercentColorClass(item.projectedPercent);

                // Xử lý dữ liệu so sánh cho từng nhân viên
                let changeActualCellHtml = '';
                let changeProjectedCellHtml = '';

                if (comparisonDataAll) {
                    const compEmp = comparisonDataAll.find(e => e.id === employee.id);
                    if (compEmp) {
                        const compChange = compEmp.contestChanges.find(c => c.name === decodedContestName);
                        if (compChange) {
                            changeActualCellHtml = `<td style="font-weight: 700;">${getChangeHtml(compChange.changeActual, 0)}</td>`;
                            changeProjectedCellHtml = `<td style="font-weight: 700;">${getChangeHtml(compChange.changeProjectedPercent, 1, true)}</td>`;
                        } else {
                            changeActualCellHtml = `<td></td>`;
                            changeProjectedCellHtml = `<td></td>`;
                        }
                    } else {
                        changeActualCellHtml = `<td></td>`;
                        changeProjectedCellHtml = `<td></td>`;
                    }
                }

                tableHtml += `
                <tr>
                    <td class="rank-cell">${index + 1}</td>
                    <td>${employee.name}</td>
                    <td>${formatNumberFull(item.actual, 2)}</td>
                    ${changeActualCellHtml}
                    <td>${formatNumberFull(item.target, 0)}</td>
                    <td class="${percentClass}">${item.percent.toFixed(0)}%</td>
                    <td class="${projectedClass}">${item.projectedPercent.toFixed(1)}%</td>
                    ${changeProjectedCellHtml}
                </tr>`;
            });

            tableHtml += `</tbody></table></div></div>`;
            document.getElementById('modal-body').innerHTML = tableHtml;
            document.getElementById('kpi-modal').style.display = 'block';
        }
        // Cập nhật hàm này để nhận và sử dụng dữ liệu so sánh
        function renderAllEmployeeCards(data) {
            document.getElementById('allCardsContainer').innerHTML = data.map(employee => {
                const comparisonData = getComparisonData(employee.id);
                return getEmployeeCardHtml(employee, data.length, comparisonData);
            }).join('');
        }

        function getMotivationalQuote(rank, total) {
            if (rank === 1) return "Dẫn đầu cuộc đua, tuyệt vời!";
            if (rank <= 3) return "Vị trí top đầu, giữ vững phong độ!";
            if (rank <= Math.ceil(total * 0.6)) return "Cố gắng bứt phá top đầu nào!";
            return "Nỗ lực hơn để cải thiện thứ hạng!";
        }

        // Thêm tham số comparisonData
        function getEmployeeCardHtml(employee, total, comparisonData = null) {
            const revenueActual = employee.actual_DTQD || 0;
            const revenueTarget = employee.revenueTarget || 0;
            const revenueRemaining = revenueTarget - revenueActual;
            const totalDisplayedContests = sortedContestHeadersGlobal.length;
            const timeframe = getContestTimeframe('');

            const remainingDays = timeframe.remainingDays;
            const revenueTodayTarget = (revenueRemaining > 0 && remainingDays > 0) ? revenueRemaining / remainingDays : 0;

            const revenueCompletionCapped = Math.min(100, employee.revenueCompletion);
            const contestCompletionCapped = Math.min(100, employee.overallProjectedContestCompletion);

            let rankIcon = '';
            if (employee.rank === 1) rankIcon = '🥇 ';
            else if (employee.rank === 2) rankIcon = '🥈 ';
            else if (employee.rank === 3) rankIcon = '🥉 ';
            else if (total > 3 && employee.rank >= total - 2) rankIcon = '🔴 ';

            const isRevenueTargetCompleted = revenueActual >= revenueTarget;
            const remainingRevenueCell = isRevenueTargetCompleted ? `<span class="value success-text">🏆</span>` : `<span class="value">${formatNumberFull(revenueRemaining, 0)}</span>`;

            const isBottomThree = total > 3 && employee.rank >= total - 2;
            const headerColor = employee.rank === 1 ? '#F1C40F' : (employee.rank === 2 ? '#b2bec3' : (employee.rank === 3 ? '#CD7F32' : (isBottomThree ? '#e17055' : 'var(--primary-accent)')));
            const avatarSvg = `<svg width="60" height="60" xmlns="http://www.w3.org/2000/svg"><circle cx="30" cy="30" r="27" fill="${headerColor}" stroke="white" stroke-width="3"/><text x="50%" y="50%" dy=".1em" dominant-baseline="central" text-anchor="middle" font-family="Tahoma" font-size="${getInitials(employee.name).length > 1 ? '24' : '28'}" fill="${employee.rank <= 2 ? '#333' : '#fff'}" font-weight="bold">${getInitials(employee.name)}</text></svg>`;

            const contestTableBody = Object.entries(employee.contestCompletion)
                .filter(([name]) => sortedContestHeadersGlobal.includes(name))
                .sort((a, b) => b[1].projectedPercent - a[1].projectedPercent)
                .map(([category, data], index) => {
                    const contestTimeframe = getContestTimeframe(category);
                    const remaining = data.target - data.actual;
                    const remainingDaysContest = contestTimeframe.remainingDays;
                    const todayTarget = (remaining > 0 && remainingDaysContest > 0) ? remaining / remainingDaysContest : 0;
                    const isTargetCompleted = data.actual >= data.target;

                    const targetTodayCell = isTargetCompleted ? `<td class="icon-cell">🏆</td>` : `<td>${formatNumberFull(todayTarget, 2)}</td>`;

                    let changeActualHtml = '';
                    if (comparisonData) {
                        const changeData = comparisonData.contestChanges.find(c => c.name === category);
                        if (changeData) {
                            changeActualHtml = getChangeHtml(changeData.changeActual, 0, false);
                        }
                    }

                    const remainingCell = isTargetCompleted ? `<td class="icon-cell">🏆</td>` : `<td>${formatNumberFull(remaining, 2)}</td>`;

                    const percentClass = getPercentColorClass(data.percent);
                    const projectedClass = getPercentColorClass(data.projectedPercent);

                    return `<tr>
                        <td>${index + 1}</td>
                        <td style="text-align: left; font-weight: 600;">${category}</td>
                        ${targetTodayCell}
                        <td>${formatNumberFull(data.target, 0)}</td>
                        <td class="kpi-actual">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 4px;">
                                ${formatNumberFull(data.actual, 2)}
                                ${changeActualHtml}
                            </div>
                        </td>
                        ${remainingCell}
                        <td class="${percentClass}" style="font-weight: 700;">${data.percent.toFixed(0)}%</td>
                        <td class="${projectedClass}" style="font-weight: 900;">${data.projectedPercent.toFixed(1)}%</td>
                    </tr>`;
                }).join('');

            const scoreChangeDisplay = comparisonData ? getChangeHtml(comparisonData.changeScore, 1) : '';
            const revenueChangeDisplay = comparisonData ? getChangeHtml(comparisonData.changeRevenue, 1, true) : '';
            const contestChangeDisplay = comparisonData ? getChangeHtml(comparisonData.changeContest, 1, true) : '';

            const headerRankClass = employee.rank === 1 ? 'header-rank1' : (employee.rank === 2 ? 'header-rank2' : (employee.rank === 3 ? 'header-rank3' : (isBottomThree ? 'header-warning' : 'header-top')));

            return `<div class="perf-card">
                    <div class="perf-header ${headerRankClass}">
                        <div class="perf-avatar">${avatarSvg}</div>
                        <div class="name-block">
                            <h2>${abbreviateName(employee.name)}</h2>
                            <p class="perf-quote ${employee.rank === 1 ? 'rank1' : employee.rank === 2 ? 'rank2' : employee.rank === 3 ? 'rank3' : employee.rank <= 6 ? 'rank-mid' : 'rank-bottom'}">${getMotivationalQuote(employee.rank, total)}</p>
                        </div>
                        <div class="rank-block">
                            <h3>${rankIcon}HẠNG ${employee.rank}</h3>
                            <p style="margin: 0; font-size: 13px; font-weight: 700;">Điểm: ${employee.totalScore.toFixed(1)} ${scoreChangeDisplay}</p>
                        </div>
                    </div>
                    <div class="perf-body">
                         <div class="progress-bar-wrapper" style="margin-top: 15px;">
                            <div class="progress-bar-label">
                                <span>Tiến độ Doanh thu ${revenueChangeDisplay}</span>
                                <span class="progress-data">${formatNumberFull(revenueActual, 0)} / ${formatNumberFull(revenueTarget, 0)}</span>
                                <span class="${getPercentColorClass(employee.revenueCompletion)}" style="font-weight: 800;">${employee.revenueCompletion.toFixed(1)}%</span>
                            </div>
                            <div class="progress-bar-bg"><div class="progress-bar-fill ${employee.revenueCompletion >= 100 ? 'success' : ''}" style="width: ${revenueCompletionCapped}%;"></div></div>
                        </div>
                        <div class="progress-bar-wrapper">
                            <div class="progress-bar-label">
                                <span>Tiến độ Thi đua ${contestChangeDisplay}</span>
                                <span class="progress-data">${employee.projectedCompletedContests} / ${totalDisplayedContests} Nhóm</span>
                                <span class="${getPercentColorClass(employee.overallProjectedContestCompletion)}" style="font-weight: 800;">${employee.overallProjectedContestCompletion.toFixed(1)}%</span>
                            </div>
                            <div class="progress-bar-bg"><div class="progress-bar-fill ${employee.overallProjectedContestCompletion >= 100 ? 'success' : ''}" style="width: ${contestCompletionCapped}%;"></div></div>
                        </div>
                        <div class="progress-bar-group">
                            <div><div class="label">🎯 Target DT</div><span class="value">${formatNumberFull(revenueTarget, 0)}</span></div>
                            <div><div class="label">📈 Lũy kế DT</div><span class="value">${formatNumberFull(revenueActual, 0)}</span></div>
                            <div><div class="label">📉 DT Còn lại</div>${remainingRevenueCell}</div>
                            <div><div class="label">🔮 Dự kiến</div><span class="value" style="font-weight: 800;">${employee.projectedRevenueCompletion.toFixed(0)}%</span></div>
                            <div><div class="label">📅 M.tiêu Ngày</div><span class="value" style="font-weight: 800; color: var(--primary-accent);">${isRevenueTargetCompleted ? '🏆' : formatNumberFull(revenueTodayTarget, 0)}</span></div>
                        </div>
                         <div class="contest-table-container">
                            <table class="contest-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th style="text-align: left;">Ngành hàng</th>
                                        <th>M.tiêu</th>
                                        <th>Target</th>
                                        <th>Lũy kế</th>
                                        <th>Còn lại</th>
                                        <th>% HT</th>
                                        <th>Dự kiến</th>
                                    </tr>
                                </thead>
                                <tbody>${contestTableBody}</tbody>
                            </table>
                        </div>
                        <!-- EVALUATION SECTION -->
                        <div class="evaluation-container">
                            <button class="evaluation-toggle-btn" onclick="toggleEvaluation(this)">
                                <i class="fas fa-comment-dots"></i> <span>Đánh giá hiệu suất ${comparisonData ? 'giai đoạn này' : 'tuần'} (Click để xem)</span>
                            </button>
                            <div class="evaluation-content">
                                ${generatePerformanceEvaluation(employee, comparisonData)}
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        // --- HIGHLY DETAILED PERFORMANCE EVALUATION GENERATOR ---
        function generatePerformanceEvaluation(employee, comparisonData = null) {
            // HELPER: Format number
            const fmt = (n) => formatNumberFull(n, 0);
            const fmtDec = (n) => formatNumberFull(n, 2);

            // 1. GATHER DATA
            const revenueAct = employee.actual_DTQD || 0;
            const revenueTgt = employee.revenueTarget || 0;
            const revenuePct = employee.revenueCompletion || 0;
            const revenueProj = employee.projectedRevenueCompletion || 0;
            const revenueGap = revenueTgt - revenueAct;

            // Timeframe for Daily Goal Calculation
            const timeframe = getContestTimeframe('');
            const remainingDays = timeframe.remainingDays > 0 ? timeframe.remainingDays : 1;
            const requiredDailyRevenue = revenueGap > 0 ? (revenueGap / remainingDays) : 0;

            // Contest Categorization
            const contests = sortedContestHeadersGlobal.map(h => {
                const c = employee.contestCompletion[h];
                return {
                    name: h,
                    percent: c.percent || 0,
                    projected: c.projectedPercent || 0,
                    actual: c.actual || 0,
                    target: c.target || 0,
                    gap: (c.target || 0) - (c.actual || 0)
                };
            }).sort((a, b) => b.percent - a.percent);

            const completed = contests.filter(c => c.percent >= 100);
            const nearFinish = contests.filter(c => c.percent >= 80 && c.percent < 100);
            const progressing = contests.filter(c => c.percent >= 50 && c.percent < 80);
            const critical = contests.filter(c => c.percent < 50);

            // 2. BUILD NARRATIVE SECTIONS

            // SECTION 1: REVENUE DEEP DIVE
            let revStatusIcon = revenueProj >= 100 ? "🟢" : (revenueProj >= 85 ? "🟡" : "🔴");
            let revComment = `<b>1. Tài chính & Doanh thu ${revStatusIcon}:</b> `;
            revComment += `Hiện đạt <b>${revenuePct.toFixed(1)}%</b> (${fmt(revenueAct)}/${fmt(revenueTgt)}), còn thiếu <b>${fmt(revenueGap)}</b>. `;

            if (revenueGap > 0) {
                revComment += `Để về đích đúng hạn, bạn cần chạy trung bình <b>${fmt(requiredDailyRevenue)}/ngày</b> trong ${remainingDays} ngày tới. `;
                if (revenueProj < 90) revComment += `Tốc độ hiện tại (${revenueProj.toFixed(0)}%) là <b>KHÔNG ĐỦ</b> để đạt KPI 100%.`;
                else revComment += `Tốc độ khá tốt, hãy duy trì nhịp độ này.`;
            } else {
                revComment += `🏆 Bạn đã HOÀN THÀNH chỉ tiêu doanh thu tháng! Tuyệt vời!`;
            }

            // SECTION 2: CONTEST BREAKDOWN
            let contestComment = `<br><b>2. Chỉ số Ngành hàng (Đạt ${completed.length}/${contests.length} nhóm):</b><br>`;

            // Sprint Opportunities
            if (nearFinish.length > 0) {
                contestComment += `🚀 <b>CÁC MỤC TIÊU SÁT NÚT (Cần chốt ngay):</b><br>`;
                contestComment += `<ul style="margin: 5px 0 5px 20px; padding: 0;">`;
                nearFinish.forEach(c => {
                    const unit = c.gap < 5 && c.gap > 0 ? '' : 'đvi'; // Simple check, exact unit unknowable but generic ok
                    contestComment += `<li>${c.name}: Đã đạt ${c.percent.toFixed(0)}%, chỉ còn thiếu <b>${fmtDec(c.gap)}</b>.</li>`;
                });
                contestComment += `</ul>`;
            }

            // Critical Risks
            if (critical.length > 0) {
                contestComment += `⚠️ <b>RỦI RO CAO (Cần chiến lược gấp):</b> Các nhóm ${critical.map(c => c.name).slice(0, 3).join(", ")} hiện chỉ đạt dưới 50%. Cần rà soát lại nguồn khách hoặc tư vấn chéo ngay.`;
            } else if (progressing.length > 0) {
                contestComment += `⭐ <b>Đang tăng tốc:</b> ${progressing.length} nhóm kinh doanh ${progressing.map(c => c.name).slice(0, 2).join(", ")} đang ở mức 50-80%, cần đẩy mạnh hơn.`;
            }

            // SECTION 3: COMPARISON CONTEXT (If available)
            let compareComment = "";
            if (comparisonData) {
                const diffRank = comparisonData.startRank !== 'N/A' ? (comparisonData.startRank - employee.rank) : 0;
                const trend = diffRank > 0 ? "thăng hạng ⬆️" : (diffRank < 0 ? "tụt hạng ⬇️" : "giữ nguyên ➡️");
                let revSpeed = "";

                if (comparisonData.changeRevenue) {
                    revSpeed = comparisonData.changeRevenue > 0 ? "Tốc độ doanh thu đang TĂNG (+)" : "Tốc độ doanh thu đang GIẢM (-)";
                }

                compareComment = `<br><b>3. Xu hướng so với giai đoạn trước:</b> Bạn đã ${trend} (${comparisonData.startRank} -> ${employee.rank}). ${revSpeed}`;
                if (comparisonData.contestChanges) {
                    const topChange = comparisonData.contestChanges.sort((a, b) => b.changeActual - a.changeActual)[0];
                    if (topChange && topChange.changeActual > 0) {
                        compareComment += `. Tăng trưởng tốt nhất ở nhóm <b>${topChange.name}</b> (+${fmt(topChange.changeActual)}).`;
                    }
                }
            }

            // SECTION 4: DYNAMIC SMART ADVICE
            let advice = "";
            if (nearFinish.length > 0) {
                // Ưu tiên cao nhất: Sát nút
                const target = nearFinish[0];
                advice = `💡 <b>Chiến thuật Sát nút:</b> Hãy tập trung chốt ngay nhóm <b>${target.name}</b> (đang thiếu ${fmtDec(target.gap)}) để dứt điểm KPI này sớm.`;
            } else if (revenueProj < 100 && revenueProj >= 85) {
                // Ưu tiên nhì: Doanh thu sắp đạt
                advice = `💡 <b>Chiến thuật Doanh thu:</b> Bạn đang rất gần đích Doanh thu (thiếu ${fmt(revenueGap)}). Đẩy mạnh bán hàng giá trị cao để cán mốc 100% ngay.`;
            } else if (critical.length > 0) {
                // Ưu tiên ba: Cứu các nhóm thấp
                const risk = critical[0];
                advice = `💡 <b>Cảnh báo Rủi ro:</b> Nhóm <b>${risk.name}</b> đang rất thấp (<50%). Cần tư vấn chéo hoặc tìm nguồn khách gấp cho nhóm này.`;
            } else if (revenueProj < 85) {
                // Doanh thu thấp
                advice = `💡 <b>Lời khuyên:</b> Chỉ số Doanh thu đang báo động. Hãy tập trung vào các đơn hàng lớn để cải thiện đà tăng trưởng.`;
            } else {
                // Tốt đều
                advice = `💡 <b>Lời khuyên:</b> Phong độ tuyệt vời! Hãy duy trì nhịp độ và hỗ trợ đồng đội hoặc Upsell thêm để tối ưu thưởng.`;
            }

            // FINAL ASSEMBLY
            return `
                <div style="font-size: 13px; line-height: 1.5;">
                    ${revComment}
                    ${contestComment}
                    ${compareComment ? compareComment : ''}
                    <div style="margin-top: 8px; font-style: italic; color: #d63031; background: rgba(255,255,255,0.5); padding: 5px; border-radius: 5px;">${advice}</div>
                </div>
            `;
        }

        // --- GLOBAL TOGGLE FUNCTIONS ---
        function toggleEvaluation(btn) {
            const content = btn.nextElementSibling;
            content.classList.toggle('visible');
            const icon = btn.querySelector('i');
            if (content.classList.contains('visible')) {
                btn.querySelector('span').textContent = "Ẩn đánh giá";
                icon.className = "fas fa-chevron-up";
            } else {
                btn.querySelector('span').textContent = "Đánh giá hiệu suất tuần (Click để xem)";
                icon.className = "fas fa-comment-dots";
            }
        }

        function toggleAllComments(show) {
            const allBtns = document.querySelectorAll('.evaluation-toggle-btn');
            allBtns.forEach(btn => {
                const content = btn.nextElementSibling;
                const icon = btn.querySelector('i');
                if (show) {
                    content.classList.add('visible');
                    btn.querySelector('span').textContent = "Ẩn đánh giá";
                    icon.className = "fas fa-chevron-up";
                } else {
                    content.classList.remove('visible');
                    btn.querySelector('span').textContent = "Đánh giá hiệu suất tuần (Click để xem)";
                    icon.className = "fas fa-comment-dots";
                }
            });
            showToast(show ? "Đã hiện tất cả nhận xét." : "Đã ẩn tất cả nhận xét.");
        }
        function renderInfographic(data) {
            if (!data || data.length === 0) return;

            // 1. Cập nhật Text Area (Cho tính năng Copy cũ)
            const totalDisplayedContests = sortedContestHeadersGlobal.length;
            const total = data.length;
            const comments = data.map(e => {
                let icon = '';
                if (e.rank === 1) icon = '🥇 ';
                else if (e.rank === 2) icon = '🥈 ';
                else if (e.rank === 3) icon = '🥉 ';
                else if (total > 3 && e.rank >= total - 2) icon = '🔴 ';
                return `${icon}Top ${e.rank} - ${abbreviateName(e.name)}: ⭐ ${e.totalScore.toFixed(1)} điểm | 💰 DT: ${formatNumberFull(e.actual_DTQD, 0)} | ✅ HT ${e.projectedCompletedContests}/${totalDisplayedContests} nhóm.`;
            }).join('\n');
            const textArea = document.getElementById('comments-textarea');
            if (textArea) textArea.value = comments;

            // 2. Render Infographic Area
            const infoContainer = document.getElementById('infographic-report-area');
            if (!infoContainer) return;

            infoContainer.innerHTML = '';
            infoContainer.style.display = 'block';

            // Phân loại data
            const top3 = data.filter(e => e.rank <= 3);
            const topMid = data.filter(e => e.rank > 3 && e.rank <= 8);
            const topBottom = data.filter(e => e.rank > 8);

            // --- 1. TOP 3 PODIUM SECTION ---
            let top3Html = '';
            const downloadBtnHtml = `
                <div class="infographic-actions">
                    <button class="btn-download-hd" onclick="captureInfographicOnly(this)">
                        <i class="fas fa-camera"></i> Lưu Ảnh HD
                    </button>
                </div>
            `;

            if (top3.length > 0) {
                const podiumOrder = [];
                const rank2 = top3.find(e => e.rank === 2); if (rank2) podiumOrder.push(rank2);
                const rank1 = top3.find(e => e.rank === 1); if (rank1) podiumOrder.push(rank1);
                const rank3 = top3.find(e => e.rank === 3); if (rank3) podiumOrder.push(rank3);

                let podiumItemsHtml = podiumOrder.map(e => {
                    const initials = getInitials(e.name);
                    const rankClass = `rank${e.rank}`;
                    let crownHtml = e.rank === 1 ? `<div class="crown-icon">👑</div>` : '';

                    return `
                        <div class="podium-item ${rankClass}">
                            ${crownHtml}
                            <div class="podium-rank-number">${e.rank}</div>
                            <div class="star-wrapper">
                                <i class="fas fa-star"></i>
                                <div class="podium-avatar-text">${initials}</div>
                            </div>
                            <div class="podium-base">
                                <div class="podium-info-card">
                                    <span class="name">${abbreviateName(e.name)}</span>
                                    <div class="stats">
                                        <div>⭐ ${e.totalScore.toFixed(1)} Điểm</div>
                                        <div>💰 DT: ${formatNumberFull(e.actual_DTQD, 0)}</div>
                                        <div>✅ HT ${e.projectedCompletedContests}/${totalDisplayedContests} Nhóm</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                top3Html = `
                    <div class="top3-container" id="top3-infographic">
                        ${downloadBtnHtml}
                        <div class="top3-header">
                            <h2>
                                <i class="fas fa-trophy header-trophy-icon"></i> 
                                VINH DANH TOP 3 XUẤT SẮC
                                <i class="fas fa-trophy header-trophy-icon"></i>
                            </h2>
                        </div>
                        <div class="top3-podium">
                            ${podiumItemsHtml}
                        </div>
                    </div>
                `;
            }

            // --- 2. MIDDLE TIER (GRID) ---
            let midHtml = '';
            if (topMid.length > 0) {
                const cards = topMid.map(e => {
                    return `
                        <div class="mid-card">
                            <span class="mid-rank">TOP ${e.rank}</span>
                            <div class="mid-avatar">${getInitials(e.name)}</div>
                            <div class="mid-name">${abbreviateName(e.name)}</div>
                            <div class="mid-stats">
                                <div><span>Điểm:</span> <b>${e.totalScore.toFixed(1)}</b></div>
                                <div><span>DT:</span> <span>${formatNumberFull(e.actual_DTQD, 0)}</span></div>
                                <div><span>HT Nhóm:</span> <span>${e.projectedCompletedContests}/${totalDisplayedContests}</span></div>
                            </div>
                        </div>
                    `;
                }).join('');

                midHtml = `
                    <div class="mid-tier-container">
                        <div class="mid-tier-header">
                            <h3>🚀 CẦN BỨT PHÁ (TOP 4-8)</h3>
                        </div>
                        <div class="mid-grid">
                            ${cards}
                        </div>
                    </div>
                `;
            }

            // --- 3. BOTTOM TIER (LIST) ---
            let bottomHtml = '';
            if (topBottom.length > 0) {
                const startRank = topBottom[0].rank;
                const items = topBottom.map(e => {
                    return `
                        <div class="bottom-item">
                            <div class="bottom-rank">#${e.rank}</div>
                            <div class="bottom-content">
                                <div class="bottom-name">${e.name}</div>
                                <div class="bottom-details">
                                    ⭐ ${e.totalScore.toFixed(1)} | 💰 ${formatNumberFull(e.actual_DTQD, 0)} | ⚠️ Chỉ HT ${e.projectedCompletedContests}/${totalDisplayedContests} nhóm
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                bottomHtml = `
                    <div class="bottom-tier-container">
                        <div class="bottom-header">
                            <h3>🚨 CẢNH BÁO CẢI THIỆN (TOP ${startRank}+)</h3>
                        </div>
                        <div class="bottom-grid">
                            ${items}
                        </div>
                    </div>
                `;
            }

            infoContainer.innerHTML = top3Html + midHtml + bottomHtml;
        }

        // Add capture logic function
        function captureInfographicOnly(btnElement) {
            const infographicArea = document.getElementById('infographic-report-area');
            if (!infographicArea) return;

            // Ẩn nút download tạm thời
            if (btnElement) btnElement.style.display = 'none';
            // Ẩn các nút hành động khác nếu có
            const actions = infographicArea.querySelectorAll('.infographic-actions');
            actions.forEach(el => el.style.display = 'none');

            // Show toast
            const toast = document.getElementById('toast-notification');
            if (toast) {
                toast.textContent = "Đang tạo ảnh Infographic HD (3s)...";
                toast.className = "toast show";
                setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
            }

            html2canvas(infographicArea, {
                scale: 3, // Ultra High resolution
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#ffffff', // Force white BG
                scrollY: -window.scrollY, // Fix offset issues
                logging: false
            }).then(canvas => {
                // Hiện lại nút
                if (btnElement) btnElement.style.display = 'flex';
                actions.forEach(el => el.style.display = 'block');

                // Download
                const link = document.createElement('a');
                const today = new Date();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                link.download = `BaoCao_XepHang_Infographic_${dd}${mm}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();

                if (toast) {
                    toast.textContent = "Đã tải ảnh thành công!";
                    toast.className = "toast show";
                    setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
                }
            }).catch(err => {
                console.error("Error capturing infographic:", err);
                // Hiện lại nút
                if (btnElement) btnElement.style.display = 'flex';
                actions.forEach(el => el.style.display = 'block');

                if (toast) {
                    toast.textContent = "Lỗi khi tạo ảnh!";
                    toast.className = "toast show";
                }
            });
        }


        // --- CODE ĐÃ XÓA: HÀM RENDER INFOGRAPHIC KHÔNG CÒN TỒN TẠI ---

        // --- STRAM FUNCTIONS (Đã khôi phục) ---
        function getOverallDevelopmentLevel(revenuePercent, contestPercent) {
            const highNangLuc = revenuePercent >= 95;
            const highCamKet = contestPercent >= 80;

            if (highNangLuc && highCamKet) {
                return { dLevel: 'D4', sLevel: 'S4', description: 'Năng lực cao, Cam kết cao. (Người tự lực, đạt thành tựu)', nangLuc: `Cao (${revenuePercent.toFixed(1)}%)`, camKet: `Cao (${contestPercent.toFixed(1)}%)`, revenuePercent: revenuePercent, overallProjectedContestCompletion: contestPercent };
            } else if (highNangLuc && !highCamKet) {
                return { dLevel: 'D3', sLevel: 'S3', description: 'Năng lực cao, Cam kết thay đổi. (Có khả năng, nhưng thận trọng)', nangLuc: `Cao (${revenuePercent.toFixed(1)}%)`, camKet: `Thấp (${contestPercent.toFixed(1)}%)`, revenuePercent: revenuePercent, overallProjectedContestCompletion: contestPercent };
            } else if (!highNangLuc && highCamKet) {
                return { dLevel: 'D1', sLevel: 'S1', description: 'Năng lực thấp, Cam kết cao. (Người mới, nhiệt tình)', nangLuc: `Thấp (${revenuePercent.toFixed(1)}%)`, camKet: `Cao (${contestPercent.toFixed(1)}%)`, revenuePercent: revenuePercent, overallProjectedContestCompletion: contestPercent };
            } else {
                return { dLevel: 'D2', sLevel: 'S2', description: 'Năng lực thấp, Cam kết thấp. (Người học, vỡ mộng)', nangLuc: `Thấp (${revenuePercent.toFixed(1)}%)`, camKet: `Thấp (${contestPercent.toFixed(1)}%)`, revenuePercent: revenuePercent, overallProjectedContestCompletion: contestPercent };
            }
        }

        function getTaskDevelopmentLevel(projectedPercent) {
            if (projectedPercent >= 100) {
                return { dLevel: 'D4', sLevel: 'S4', description: 'Tự lực đạt thành tựu. (Năng lực cao, Cam kết cao)' };
            } else if (projectedPercent >= 80) {
                return { dLevel: 'D3', sLevel: 'S3', description: 'Có khả năng nhưng thận trọng. (Năng lực cao, Cam kết thay đổi)' };
            } else if (projectedPercent >= 50) {
                return { dLevel: 'D1', sLevel: 'S1', description: 'Nhiệt tình, cần chỉ dẫn. (Năng lực thấp, Cam kết cao)' };
            } else {
                return { dLevel: 'D2', sLevel: 'S2', description: 'Vỡ mộng, cần huấn luyện. (Năng lực thấp, Cam kết thấp)' };
            }
        }

        function getLeadershipStyleInfo(sLevel) {
            switch (sLevel) {
                case 'S1':
                    return { title: 'S1: Chỉ đạo (Hành vi chỉ đạo cao, hỗ trợ thấp)', chuDich: 'Giúp nhân viên phát triển năng lực.', bangCach: ['Ghi nhận các kỹ năng có thể chuyển giao/học cam kết.', 'Đưa ra chỉ đạo về công việc, cách làm và thời điểm hoàn thành.', 'Kiểm tra thường xuyên.'] };
                case 'S2':
                    return { title: 'S2: Huấn luyện (Hành vi chỉ đạo cao, hỗ trợ cao)', chuDich: 'Xốc tinh thần và chỉ dạy lại.', bangCach: ['Quan tâm đến họ và khích lệ họ.', 'Giải thích vì sao.', 'Chỉ đạo và hướng dẫn lại.', 'Cho họ cùng tham gia giải quyết vấn đề.'] };
                case 'S3':
                    return { title: 'S3: Hỗ trợ (Hành vi chỉ đạo thấp, hỗ trợ cao)', chuDich: 'Xây dựng sự tự tin vào năng lực.', bangCach: ['Nói D3 đưa ý kiến về công việc được giao và cách làm.', 'Lắng nghe và khích lệ.', 'Hướng dẫn giải quyết vấn đề bằng cách đặt câu hỏi mở.'] };
                case 'S4':
                    return { title: 'S4: Giao phó (Hành vi chỉ đạo thấp, hỗ trợ thấp)', chuDich: 'Trân trọng sự đóng góp.', bangCach: ['Ghi nhận họ có chuyên môn.', 'Ủng hộ sự tự quyết.', 'Khuyến khích họ đổi mới và học hỏi liên tục.'] };
                default:
                    return { title: '', chuDich: '', bangCach: [] };
            }
        }

        function renderStramAnalysis(data) {
            const container = document.getElementById('stramAnalysisContainer');
            let tableHtml = `
            <table class="stram-table">
                <thead>
                    <tr>
                        <th>Hạng</th>
                        <th>Nhân viên</th>
                        <th>Năng lực (DT DK)</th>
                        <th>Cam kết (TĐ DK)</th>
                        <th>Cấp độ (Tổng thể)</th>
                        <th>Phong cách QL</th>
                        <th>Chi tiết</th>
                    </tr>
                </thead>
                <tbody>`;

            data.forEach(e => {
                const stram = getOverallDevelopmentLevel(e.projectedRevenueCompletion, e.overallProjectedContestCompletion);
                const nangLucPercent = stram.revenuePercent;
                const nangLucHigh = nangLucPercent >= 95;
                const nangLucCell = `<div style="text-align: center; min-width: 100px;">
                                    <span style="color: ${nangLucHigh ? 'var(--success-color)' : 'var(--danger-color)'}; font-weight: 700; font-size: 1.1em;">
                                        ${nangLucPercent.toFixed(1)}%
                                    </span>
                                    <div class="stram-progress-bar-bg">
                                        <div class="stram-progress-bar-fill ${nangLucHigh ? 'success' : 'danger'}" style="width: ${Math.min(100, nangLucPercent)}%;"></div>
                                    </div>
                               </div>`;
                const camKetPercent = stram.overallProjectedContestCompletion;
                const camKetHigh = camKetPercent >= 80;
                const camKetCell = `<div style="text-align: center; min-width: 100px;">
                                    <span style="color: ${camKetHigh ? 'var(--success-color)' : 'var(--danger-color)'}; font-weight: 700; font-size: 1.1em;">
                                        ${camKetPercent.toFixed(1)}%
                                    </span>
                                    <div class="stram-progress-bar-bg">
                                        <div class="stram-progress-bar-fill ${camKetHigh ? 'success' : 'danger'}" style="width: ${Math.min(100, camKetPercent)}%;"></div>
                                    </div>
                               </div>`;

                tableHtml += `
                <tr>
                    <td class="rank-cell">${e.rank}</td>
                    <td>${abbreviateName(e.name)}</td>
                    <td>${nangLucCell}</td>
                    <td>${camKetCell}</td>
                    <td><span class="d-level-badge ${stram.dLevel.toLowerCase()}">${stram.dLevel}</span></td>
                    <td><span class="s-level-badge ${stram.sLevel.toLowerCase()}">${stram.sLevel}</span></td>
                    <td>
                        <button class="btn-stram-detail" onclick="showStramDetailsPopup('${e.id}')">
                            Xem chi tiết
                        </button>
                    </td>
                </tr>
            `;
            });
            container.innerHTML = tableHtml + '</tbody></table>';
        }

        function showStramDetailsPopup(employeeId) {
            const employeeData = finalData.find(emp => emp.id === employeeId);
            if (!employeeData) return;

            const modal = document.getElementById('stram-modal');
            const modalTitle = document.getElementById('stram-modal-title');
            const modalBody = document.getElementById('stram-modal-body');

            modalTitle.textContent = `Phân tích STRAM: ${employeeData.name}`;
            const overall = getOverallDevelopmentLevel(employeeData.projectedRevenueCompletion, employeeData.overallProjectedContestCompletion);
            const leaderStyle = getLeadershipStyleInfo(overall.sLevel);
            const revenueTask = getTaskDevelopmentLevel(employeeData.projectedRevenueCompletion);

            const contestTasks = Object.entries(employeeData.contestCompletion)
                .filter(([name]) => sortedContestHeadersGlobal.includes(name))
                .map(([name, data]) => {
                    return { name, rawData: data, analysis: getTaskDevelopmentLevel(data.projectedPercent) };
                })
                .sort((a, b) => b.rawData.projectedPercent - a.rawData.projectedPercent);

            let contestTaskHtml = contestTasks.map((task, index) => {
                const leaderAction = getLeadershipStyleInfo(task.analysis.sLevel);
                const data = task.rawData;
                const contestTimeframe = getContestTimeframe(task.name);

                const remaining = data.target - data.actual;
                const remainingDays = contestTimeframe.remainingDays;
                const isTargetCompleted = data.actual >= data.target;

                // Mục tiêu ngày: Còn lại / Số ngày còn lại (chỉ tính nếu còn lại > 0 và còn ngày)
                const todayTarget = (remaining > 0 && remainingDays > 0) ? remaining / remainingDays : 0;

                // Icon Cup: Dùng Cup nếu Target đã hoàn thành
                const targetTodayCell = isTargetCompleted ? `<span class="value green">🏆</span>` : `<span class="value">${formatNumberFull(todayTarget, 2)}</span>`;
                const remainingCell = isTargetCompleted ? `<span class="value green">🏆</span>` : `<span class="value">${formatNumberFull(remaining, 2)}</span>`;

                const projectedPercentClass = data.projectedPercent >= 100 ? 'green' : (data.projectedPercent >= 80 ? 'green' : (data.projectedPercent >= 50 ? 'red' : 'red'));

                return `
                <tr>
                    <td>${index + 1}</td>
                    <td style="text-align: left; vertical-align: top;">
                        <strong style="font-size: 1.1em; color: var(--text-primary);">Nhiệm vụ: ${task.name}</strong>
                        <div class="stram-task-details">
                            <div><span class="label">M.tiêu Ngày:</span> ${targetTodayCell}</div>
                            <div><span class="label">Target:</span> <span class="value">${formatNumberFull(data.target, 0)}</span></div>
                            <div><span class="label">Lũy kế:</span> <span class="value">${formatNumberFull(data.actual, 2)}</span></div>
                            <div><span class="label">Còn lại:</span> ${remainingCell}</div>
                            <div><span class="label">% HT:</span> <span class="value">${data.percent.toFixed(0)}%</span></div>
                            <div><span class="label">% HT DK:</span> <span class="value ${projectedPercentClass}">${data.projectedPercent.toFixed(1)}%</span></div>
                        </div>
                    </td>
                    <td><span class="d-level-badge ${task.analysis.dLevel.toLowerCase()}">${task.analysis.dLevel}</span></td>
                    <td><span class="s-level-badge ${task.analysis.sLevel.toLowerCase()}">${task.analysis.sLevel}</span></td>
                    <td style="text-align: left; font-size: 13px; vertical-align: top;">
                        <strong>${leaderAction.chuDich}</strong>
                        <ul>${leaderAction.bangCach.map(li => `<li>${li}</li>`).join('')}</ul>
                    </td>
                </tr>
            `;
            }).join('');

            const revenueTaskHtml = (() => {
                const revenueActual = employeeData.actual_DTQD || 0;
                const revenueTarget = employeeData.revenueTarget || 0;
                const revenueRemaining = revenueTarget - revenueActual;
                const timeframe = getContestTimeframe('');

                const remainingDaysRevenue = timeframe.remainingDays;
                const isRevenueTargetCompleted = revenueActual >= revenueTarget;

                // Mục tiêu ngày: Còn lại / Số ngày còn lại (chỉ tính nếu còn lại > 0 và còn ngày)
                const revenueTodayTarget = (revenueRemaining > 0 && remainingDaysRevenue > 0) ? revenueRemaining / remainingDaysRevenue : 0;

                const revenueTodayCell = isRevenueTargetCompleted ? `<span class="value green">🏆</span>` : `<span class="value">${formatNumberFull(revenueTodayTarget, 0)}</span>`;
                const revenueRemainingCell = isRevenueTargetCompleted ? `<span class="value green">✅</span>` : `<span class="value">${formatNumberFull(revenueRemaining, 0)}</span>`;

                const projectedPercentClass = employeeData.projectedRevenueCompletion >= 100 ? 'green' : (employeeData.projectedRevenueCompletion >= 80 ? 'green' : (employeeData.projectedRevenueCompletion >= 50 ? 'red' : 'red'));

                return `
                <tr>
                    <td style="text-align: left; vertical-align: top;">
                        <strong style="font-size: 1.1em; color: var(--text-primary);">Nhiệm vụ: Doanh thu Cá nhân</strong>
                        <div class="stram-task-details">
                            <div><span class="label">M.tiêu Ngày:</span> ${revenueTodayCell}</div>
                            <div><span class="label">Target:</span> <span class="value">${formatNumberFull(revenueTarget, 0)}</span></div>
                            <div><span class="label">Lũy kế:</span> <span class="value">${formatNumberFull(revenueActual, 0)}</span></div>
                            <div><span class="label">Còn lại:</span> ${revenueRemainingCell}</div>
                            <div><span class="label">% HT:</span> <span class="value">${employeeData.revenueCompletion.toFixed(0)}%</span></div>
                            <div><span class="label">% HT DK:</span> <span class="value ${projectedPercentClass}">${employeeData.projectedRevenueCompletion.toFixed(1)}%</span></div>
                        </div>
                    </td>
                    <td><span class="d-level-badge ${revenueTask.dLevel.toLowerCase()}">${revenueTask.dLevel}</span></td>
                    <td><span class="s-level-badge ${revenueTask.sLevel.toLowerCase()}">${revenueTask.sLevel}</span></td>
                    <td style="text-align: left; font-size: 13px; vertical-align: top;">
                        <strong>${getLeadershipStyleInfo(revenueTask.sLevel).chuDich}</strong>
                        <ul>${getLeadershipStyleInfo(revenueTask.sLevel).bangCach.map(li => `<li>${li}</li>`).join('')}</ul>
                    </td>
                </tr>
            `;
            })();


            modalBody.innerHTML = `
            <style>
                #stram-modal .modal-content { max-width: 1200px; }
                .stram-task-table { table-layout: fixed; width: 100%; }
                .stram-task-table th, .stram-task-table td { word-wrap: break-word; font-size: 12px; padding: 12px 8px; }
                #tab-contest .stram-task-table th:nth-child(1), #tab-contest .stram-task-table td:nth-child(1) { width: 5%; }
                #tab-contest .stram-task-table th:nth-child(2), #tab-contest .stram-task-table td:nth-child(2) { width: 35%; text-align: left; }
                #tab-contest .stram-task-table th:nth-child(3), #tab-contest .stram-task-table td:nth-child(3) { width: 8%; }
                #tab-contest .stram-task-table th:nth-child(4), #tab-contest .stram-task-table td:nth-child(4) { width: 8%; }
                #tab-contest .stram-task-table th:nth-child(5), #tab-contest .stram-task-table td:nth-child(5) { width: 44%; text-align: left; }
                #tab-revenue .stram-task-table th:nth-child(1), #tab-revenue .stram-task-table td:nth-child(1) { width: 35%; text-align: left; }
                #tab-revenue .stram-task-table th:nth-child(2), #tab-revenue .stram-task-table td:nth-child(2) { width: 8%; }
                #tab-revenue .stram-task-table th:nth-child(3), #tab-revenue .stram-task-table td:nth-child(3) { width: 8%; }
                #tab-revenue .stram-task-table th:nth-child(4), #tab-revenue .stram-task-table td:nth-child(4) { width: 49%; text-align: left; }
            </style>
            <div class="stram-modal-grid">
                <div class="stram-leader-card">
                    <h3>Chuẩn đoán Tổng thể</h3>
                    <p style="font-size: 1.1em; text-align: center;">
                        <span class="d-level-badge ${overall.dLevel.toLowerCase()}">${overall.dLevel}</span>
                        <span style="font-size: 1.5em; margin: 0 10px;">➔</span>
                        <span class="s-level-badge ${overall.sLevel.toLowerCase()}">${overall.sLevel}</span>
                    </p>
                    <p style="font-size: 14px; text-align: center; color: var(--text-muted); margin-top: 5px;"><i>"${overall.description}"</i></p>
                    <hr style="border: none; border-top: 1px solid var(--border-main); margin: 15px 0;">
                    <h3>Gợi ý Phong cách Lãnh đạo Chung</h3>
                    <h4>${leaderStyle.title}</h4>
                    <h4>Chủ đích:</h4>
                    <p style="font-size: 14px; color: var(--text-muted);">${leaderStyle.chuDich}</p>
                    <h4>Bằng cách:</h4>
                    <ul>${leaderStyle.bangCach.map(item => `<li>${item}</li>`).join('')}</ul>
                </div>
                <div>
                    <div class="stram-tabs">
                        <button class="stram-tab-btn active" data-tab="tab-contest">Thi đua (${contestTasks.length})</button>
                        <button class="stram-tab-btn" data-tab="tab-revenue">Doanh thu</button>
                    </div>
                    <div id="tab-contest" class="stram-tab-content active" style="max-height: 60vh; overflow-y: auto;">
                        <table class="stram-task-table">
                            <thead><tr><th>STT</th><th>Nhiệm vụ (Ngành hàng) & Chi tiết</th><th>Cấp độ (D)</th><th>Phong cách (S)</th><th>Gợi ý Hành động</th></tr></thead>
                            <tbody>${contestTaskHtml}</tbody>
                        </table>
                    </div>
                    <div id="tab-revenue" class="stram-tab-content">
                         <table class="stram-task-table">
                            <thead><tr><th>Nhiệm vụ & Chi tiết</th><th>Cấp độ (D)</th><th>Phong cách (S)</th><th>Gợi ý Hành động</th></tr></thead>
                            <tbody>${revenueTaskHtml}</tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;

            modalBody.querySelectorAll('.stram-tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    modalBody.querySelectorAll('.stram-tab-btn').forEach(b => b.classList.remove('active'));
                    modalBody.querySelectorAll('.stram-tab-content').forEach(c => c.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById(btn.dataset.tab).classList.add('active');
                });
            });
            modal.style.display = 'block';
        }
        function toggleTargetTimeMode() {
            const mode = document.querySelector('input[name="targetTimeMode"]:checked').value;
            const rangeInputs = document.getElementById('target-time-range-inputs');
            if (mode === 'range') {
                rangeInputs.style.display = 'grid';
            } else {
                rangeInputs.style.display = 'none';
            }
            updateEmployeeTargets();
        }
    </script>
</body>

</html>